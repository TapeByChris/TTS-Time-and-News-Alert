<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Candlesticks Dashboard (Audio + Yahoo + FF Econ Calendar)</title>
<style>
    :root {
        --bg: #1b1b1b;
        --panel: #232323;
        --panel-2: #2a2a2a;
        --panel-3: #2f2f2f;
        --input: #1f1f1f;
        --border: rgba(255,255,255,0.08);
        --border-subtle: rgba(255,255,255,0.05);
        --text: #f2f2f2;
        --text-muted: #b7b7b7;
        --muted: #8f8f8f;
        --green: #6bc97a;
        --red: #d63b3b;
        --amber: #e1b56a;
        --focus: #3a8dde;
        --ink: #0f0f0f;
        --card: #262626;
        --alert: var(--red);
        --dim: var(--muted);
        --accent: var(--focus);
        --gold: var(--amber);
        --cyan: #7db7e8;
        --line: var(--border);
        --overlay: rgba(10,10,10,0.72);
        --shadow-soft: 0 14px 30px rgba(0,0,0,0.4);
        --inner-outline: inset 0 0 0 1px rgba(255,255,255,0.04);
        --radius-sm: 8px;
        --radius: 12px;
        --radius-lg: 18px;
        --mica: linear-gradient(180deg, rgba(38,38,38,0.98), rgba(28,28,28,0.98));

        /* NEW: global widget scales */
        --timer-scale: 1;
        --yahoo-scale: 1;
        --econ-scale: 1;
    }

    html { font-size: 14px; }

    body {
        background:
            radial-gradient(1200px 800px at 80% -20%, rgba(255,255,255,0.05), transparent 60%),
            radial-gradient(900px 600px at -10% 120%, rgba(255,255,255,0.035), transparent 55%),
            var(--bg);
        color: var(--text);
        font-family: "Segoe UI Variable", "Segoe UI", "Cascadia Mono", "Consolas", sans-serif;
        line-height: 1.4;
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100vh;
        margin: 0;
        /* UPDATED: allow safety scrolling if user scales up */
        overflow: auto;
        transition: background 0.2s;
    }

    @keyframes fadeUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* TOP BAR */
    .top-bar {
        width: 100%;
        padding: 10px 16px;
        background: var(--mica);
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        box-sizing: border-box;
        box-shadow: var(--inner-outline);
        animation: fadeUp 0.45s ease both;
    }
    .btn-group { display: flex; gap: 6px; }
    .cluster {
        display: flex;
        align-items: center;
        gap: 6px;
        padding-left: 8px;
        margin-left: 8px;
        border-left: 1px solid var(--border-subtle);
    }
    .time-block { line-height: 1.1; }
    .time-label {
        color: var(--muted);
        font-size: 0.6rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
    }
    .time-value {
        font-size: 1.2rem;
        font-weight: 600;
    }
    .header-btn {
        background: var(--panel-2);
        border: 1px solid var(--border);
        color: var(--text);
        padding: 4px 8px;
        cursor: pointer;
        font-weight: 600;
        border-radius: var(--radius-sm);
        font-size: 0.7rem;
        letter-spacing: 0.02em;
        text-transform: none;
    }
    .header-btn:hover { background: var(--panel-3); outline: 1px solid var(--focus); outline-offset: -1px; }
    .help-btn { border-color: var(--focus); color: var(--text); }
    .help-btn:hover { background: var(--focus); color: var(--ink); }

    /* AUDIO BUTTON */
    .audio-btn {
        border: 1px solid var(--red);
        color: var(--text);
        min-width: 78px;
        cursor: pointer;
        border-radius: var(--radius-sm);
        background: var(--panel-2);
        padding: 4px 8px;
        font-family: inherit;
        margin-right: 8px;
        text-transform: none;
        letter-spacing: 0.02em;
        font-size: 0.7rem;
    }
    .audio-btn.on {
        border-color: var(--green);
        color: var(--text);
        background: var(--panel-3);
    }

    /* ALARM BUTTON */
    .alarm-btn {
        border: 1px solid var(--border);
        color: var(--text);
        min-width: 100px;
        cursor: pointer;
        border-radius: var(--radius-sm);
        background: var(--panel-2);
        padding: 4px 8px;
        font-family: inherit;
        font-size: 0.7rem;
        text-transform: none;
        letter-spacing: 0.02em;
    }
    .alarm-btn.on {
        border-color: var(--green);
        color: var(--text);
        background: var(--panel-3);
    }

    /* STATUS BAR & SECTION BAR */
    .status-bar {
        width: 100%;
        box-sizing: border-box;
        padding: 6px 16px;
        font-size: 0.6rem;
        color: var(--text-muted);
        display: flex;
        justify-content: space-between;
        gap: 8px 14px;
        flex-wrap: wrap;
        background: var(--mica);
        border-bottom: 1px solid var(--border-subtle);
        box-shadow: var(--inner-outline);
        animation: fadeUp 0.5s ease both;
    }
    .status-bar span { white-space: nowrap; }
    #status-alert {
        max-width: 260px;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    /* INDEX ROW */
    .index-row {
        width: 100%;
        box-sizing: border-box;
        padding: 6px 16px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
    }
    .index-chip {
        font-size: 0.65rem;
        padding: 4px 8px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        background: var(--panel-2);
        color: var(--text);
        min-width: 70px;
        text-align: center;
    }
    .index-chip.up { border-color: var(--green); color: var(--text); }
    .index-chip.down { border-color: var(--red); color: var(--text); }

    /* GRID (UPDATED: no forced 50vh crop, supports scaling) */
    .grid-wrapper {
        width: 100%;
        max-height: none;
        overflow: visible;
        display: flex;
        justify-content: center;
        padding: 10px 0 12px 0;
        box-sizing: border-box;
        transform: scale(var(--timer-scale, 1));
        transform-origin: top center;
        animation: fadeUp 0.6s ease both;
    }
    .grid-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        width: 98%;
        max-width: 1600px;
        align-items: stretch;
    }

    /* CARD */
    .card {
        background: linear-gradient(180deg, rgba(40,40,40,0.98), rgba(32,32,32,0.98));
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 16px;
        text-align: left;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 7rem;
        transition: background 0.2s, border-color 0.2s, transform 0.2s;
        transform: scale(var(--card-scale, 1));
        transform-origin: center;
        will-change: transform;
        box-shadow: var(--shadow-soft), var(--inner-outline);
    }
    .card.alert {
        background: var(--alert) !important;
        border-color: var(--red);
        box-shadow: var(--inner-outline);
    }
    .alert .c-title, .alert label { color: var(--text) !important; }

    .c-title {
        color: var(--muted);
        font-size: 0.62rem;
        text-transform: uppercase;
        margin: 0;
        letter-spacing: 0.06em;
    }
    .c-title.muted { color: var(--muted); opacity: 0.7; }
    .c-role {
        font-size: 0.6rem;
        color: var(--muted);
        letter-spacing: 0.1em;
        text-transform: uppercase;
        margin: 0;
    }
    .c-time {
        font-size: 1.8rem;
        font-weight: 600;
        line-height: 1.1;
        font-family: 'IBM Plex Mono', monospace;
    }
    .c-ms { font-size: 0.9rem; color: var(--muted); }
    .c-sub {
        font-size: 0.65rem;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
    }

    /* INPUTS / ROWS */
    .row {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid var(--border);
        align-items: center;
        flex-wrap: wrap;
    }
    .panel-head {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 6px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 6px;
        margin-bottom: 8px;
    }
    .panel-title {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    .panel-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        padding: 4px 0;
    }
    .row-label {
        font-size: 0.6rem;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.06em;
        line-height: 1.1;
        white-space: nowrap;
    }
    .row-value {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        justify-content: flex-end;
        flex: 1 1 auto;
    }
    .row-value.stack {
        flex-direction: column;
        align-items: flex-end;
        gap: 2px;
    }
    .time-row .row-value { justify-content: flex-end; }
    input {
        background: var(--input);
        border: 1px solid var(--border);
        color: var(--text);
        padding: 4px 6px;
        border-radius: 4px;
        font-family: inherit;
        font-size: 0.7rem;
        text-align: right;
        width: 64px;
    }
    input[type="checkbox"] { accent-color: var(--focus); }
    input:focus {
        outline: 1px solid var(--focus);
        outline-offset: -1px;
    }
    .align-in {
        width: 60px !important;
        color: var(--accent) !important;
        font-weight: bold;
    }
    .rth { grid-column: span 2; }
    .rth-inputs {
        display: flex;
        gap: 15px;
        margin-bottom: 5px;
        justify-content: center;
    }
    .mute-label {
        font-size: 0.65rem;
        display: inline-flex;
        align-items: center;
        gap: 3px;
        color: var(--muted);
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .mute-label input { width: auto; }

    /* BUTTON BASE */
    button {
        cursor: pointer;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        background: var(--panel-2);
        color: var(--text);
        padding: 4px 8px;
        font-family: inherit;
        text-transform: none;
        letter-spacing: 0.02em;
        font-size: 0.7rem;
    }
    button:hover { background: rgba(0,120,212,0.16); border-color: rgba(0,120,212,0.6); }
    button:focus-visible { outline: 2px solid rgba(0,120,212,0.75); outline-offset: 2px; }

    /* OVERLAYS (UPDATED to match theme vars) */
    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--overlay);
        z-index: 1000;
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        pointer-events: none;
        transition: 0.25s;
        backdrop-filter: blur(6px);
    }
    .overlay.visible {
        opacity: 1;
        pointer-events: all;
    }
    .modal {
        background: var(--mica);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 18px;
        max-width: 820px;
        width: min(92vw, 820px);
        color: var(--text);
        box-shadow: var(--shadow-soft), var(--inner-outline);
    }
    .modal h2 {
        border-bottom: 1px solid var(--border);
        padding-bottom: 10px;
        margin-top: 0;
        color: var(--accent);
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-size: 1rem;
    }
    .modal h3, .modal h4 { color: var(--text); }
    .modal p, .modal li { color: var(--text-muted); line-height: 1.5; font-size: 0.9rem; }
    .close-btn {
        float: right;
        cursor: pointer;
        font-size: 1.6rem;
        color: var(--text-muted);
        line-height: 1;
    }
    .close-btn:hover { color: var(--text); }

    /* DESIGN STUDIO */
    .cf-grp { margin-bottom: 16px; }
    .cf-grp h4 {
        margin: 0 0 10px 0;
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.14em;
    }
    .cf-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 8px;
        border: 1px solid var(--border);
        background: var(--panel-2);
        border-radius: 4px;
        gap: 10px;
        margin-bottom: 6px;
        box-shadow: var(--inner-outline);
    }
    .cf-row span { color: var(--text); font-size: 0.7rem; }

    input[type="color"] {
        border: none;
        width: 40px;
        height: 30px;
        cursor: pointer;
        background: none;
        padding: 0;
    }
    input[type="range"] { width: 220px; cursor: pointer; }

    .rst-btn {
        width: 100%;
        background: var(--red);
        margin-top: 10px;
        padding: 12px;
        font-weight: bold;
        border: none;
    }
    .rst-btn:hover { background: var(--red); }

    .theme-select, .news-select {
        background: var(--input);
        border-radius: 4px;
        border: 1px solid var(--border);
        color: var(--text);
        padding: 3px 6px;
        font-size: 0.7rem;
        font-family: inherit;
    }
    .settings-tabs {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        margin: 6px 0 10px 0;
    }
    .tab-btn {
        background: var(--panel-2);
        border: 1px solid var(--border);
        color: var(--text);
        padding: 3px 6px;
        font-size: 0.6rem;
        border-radius: 4px;
        text-transform: uppercase;
        letter-spacing: 0.06em;
    }
    .tab-btn.active {
        border-color: var(--focus);
        color: var(--text);
        background: var(--panel-3);
    }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    .setting-group {
        border: 1px solid var(--border);
        background: var(--panel-2);
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 8px;
        box-shadow: var(--inner-outline);
    }
    .setting-title {
        font-size: 0.65rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--text);
        margin-bottom: 4px;
    }
    .setting-desc {
        font-size: 0.6rem;
        color: var(--muted);
        margin-bottom: 8px;
    }
    .setting-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 10px 0;
        border-top: 1px solid var(--border-subtle);
    }
    .setting-row:first-of-type { border-top: none; padding-top: 0; }
    .setting-label {
        font-size: 0.7rem;
        color: var(--text);
    }
    .scale-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
    }
    .scale-item {
        border: 1px solid var(--border);
        background: var(--panel-2);
        border-radius: 4px;
        padding: 8px;
        box-shadow: var(--inner-outline);
    }
    .scale-label {
        font-size: 0.6rem;
        color: var(--muted);
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
    }
    .chip-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 10px;
    }
    .chip-row button {
        font-size: 0.6rem;
        padding: 2px 6px;
        border-radius: 4px;
        border: 1px solid var(--border);
        background: var(--panel-2);
    }
    .tf-list {
        max-height: 260px;
        overflow-y: auto;
        font-size: 0.65rem;
    }
    .accordion-header {
        width: 100%;
        text-align: left;
        padding: 5px 6px;
        border-radius: 4px;
        border: 1px solid var(--border);
        background: var(--panel-2);
        color: var(--text);
        font-size: 0.6rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        cursor: pointer;
    }
    .accordion-body {
        display: none;
        padding-top: 10px;
    }
    .accordion.open .accordion-body { display: block; }
    .theme-preview {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin-top: 10px;
    }
    .theme-swatch {
        border-radius: 4px;
        min-height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.6rem;
        border: 1px solid var(--border);
    }
    .theme-swatch.bg { background: var(--bg); }
    .theme-swatch.card { background: var(--card); }
    .theme-swatch.accent { background: var(--accent); color: var(--ink); }
    .theme-swatch.text { background: var(--panel-2); color: var(--text); }

    /* NEWS AREA */
    .news-wrapper {
        width: 100%;
        box-sizing: border-box;
        padding: 10px 16px 12px 16px;
        overflow-y: auto;
        flex: 1 1 auto;
        border-top: 1px solid var(--border-subtle);
        background: var(--bg);
        animation: fadeUp 0.65s ease both;
    }
.news-container {
    background: var(--mica);
    border: 1px solid var(--border);
    padding: 16px 18px;
    border-radius: var(--radius);
    max-width: 1400px;
    margin: 0 auto 8px auto;
    box-shadow: var(--shadow-soft), var(--inner-outline);
    overflow: visible;
    position: relative;
}
    /* NEW: scale each panel separately */
    .news-container[data-panel="yahoo"] { transform: scale(var(--yahoo-scale, 1)); transform-origin: top center; }
    .news-container[data-panel="econ"]  { transform: scale(var(--econ-scale, 1));  transform-origin: top center; }

    .news-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        padding-bottom: 6px;
        padding-right: 40px;
        border-bottom: 1px solid var(--border-subtle);
        position: sticky;
        top: 0;
        z-index: 5;
        background: var(--mica);
    }
    .news-title {
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--muted);
    }
    .news-controls,
    .econ-controls {
        display: flex;
        gap: 4px;
        align-items: center;
        flex-wrap: wrap;
    }
    .news-controls .news-select,
    .econ-controls .news-select,
    .news-controls .news-refresh,
    .econ-controls .news-refresh,
    .news-controls .news-voice-btn {
        height: 24px;
        padding: 2px 8px;
        font-size: 0.6rem;
        border-radius: var(--radius-sm);
        display: inline-flex;
        align-items: center;
    }
    .news-voice-btn { border-color: var(--accent); }
    .news-voice-btn.off { border-color: var(--border); color: var(--text-muted); }
    .refresh-state {
        font-size: 0.6rem;
        color: var(--muted);
        padding-left: 6px;
    }
    .refresh-state.active { color: var(--focus); }

    .news-list {
        max-height: 34vh;
        overflow-y: auto;
        margin-top: 4px;
    }
    .news-list {
        scrollbar-width: thin;
        scrollbar-color: var(--border) var(--panel-2);
    }
    .news-list::-webkit-scrollbar { width: 10px; }
    .news-list::-webkit-scrollbar-track {
        background: var(--panel-2);
        border-radius: 999px;
    }
    .news-list::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 999px;
        border: 2px solid var(--panel-2);
    }
    .news-list::-webkit-scrollbar-thumb:hover {
        background: var(--border-subtle);
    }
    .news-item {
        padding: 4px 4px;
        border-bottom: 1px solid var(--border-subtle);
        font-size: 0.65rem;
        transition: background 0.15s;
    }
    .news-list .news-item:nth-child(odd) { background: var(--panel-2); }
    .news-item:last-child { border-bottom: none; }
    .news-item strong { color: var(--text); margin-right: 4px; }
    .news-item a { color: var(--text); text-decoration: none; }
    .news-item a:hover { text-decoration: underline; }
    .news-item:hover { background: var(--panel-2); }
    .news-time { color: var(--dim); font-size: 0.6rem; margin-right: 6px; font-weight: 600; }

    /* ECON CALENDAR */
    .ff-label { color: var(--text); font-weight: 600; margin-right: 4px; }
    .ff-time { font-size: 0.6rem; color: var(--dim); margin-right: 6px; font-weight: 600; }
    .ff-cur { font-size: 0.6rem; color: var(--text-muted); margin-right: 6px; }
    .ff-badge {
        display: inline-block;
        padding: 2px 7px;
        border-radius: 2px;
        font-size: 0.55rem;
        margin-right: 6px;
        font-weight: 600;
    }
    .ff-high { background: var(--red); color: var(--text); }
    .ff-medium { background: #e0b94a; color: #ffffff; }
    .ff-low { background: var(--panel-2); color: var(--text); border: 1px solid var(--border); }
    .ff-main {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 6px;
        flex: 1 1 auto;
        min-width: 220px;
    }
    .news-item.ff-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
    }
    .ff-stats {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-left: auto;
        justify-content: flex-end;
        font-size: 0.72rem;
        color: var(--dim);
    }
    .ff-stat {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 6px;
        border-radius: 2px;
        border: 1px solid var(--border);
        background: var(--panel-2);
    }
    .ff-stat-label {
        font-size: 0.55rem;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: var(--text-muted);
    }
    .ff-stat-val { color: var(--text); font-weight: 600; }

    .ff-filter-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 5px;
        font-size: 0.6rem;
        color: var(--dim);
        align-items: center;
    }
    .ff-filter-row label {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        cursor: pointer;
    }
    .ff-filter-row input[type="checkbox"] { width: auto; }
    .econ-controls {
        color: var(--dim);
        margin-top: 0;
    }

    .news-item.ff-past { opacity: 0.45; }
    .news-item.ff-soon {
        background: var(--panel-2) !important;
        border-radius: 2px;
        padding: 6px 8px;
        border: 1px solid var(--red);
    }
    .ff-next-banner {
        font-size: 0.65rem;
        color: var(--text);
        padding: 3px 0;
        border-bottom: 1px dashed var(--border-subtle);
        margin-top: 4px;
    }

    /* NOTES */
    .notes-area {
        width: 100%;
        min-height: 260px;
        max-height: 420px;
        resize: vertical;
        background: var(--input);
        border-radius: 2px;
        border: 1px solid var(--border);
        color: var(--text);
        padding: 4px 6px;
        font-family: inherit;
        font-size: 0.7rem;
        box-sizing: border-box;
    }
    .notes-meta {
        font-size: 0.7rem;
        color: var(--text-muted);
        margin-top: 4px;
        text-align: right;
    }

    @media (max-width: 1100px) {
        .grid-container { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 800px) {
        .grid-container { grid-template-columns: repeat(2, 1fr); }
    }

body {
    scrollbar-width: thin;
    scrollbar-color: var(--border) var(--panel-2);
}
body::-webkit-scrollbar { width: 12px; }
body::-webkit-scrollbar-track {
    background: var(--panel-2);
    border-radius: 999px;
}
body::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 999px;
    border: 2px solid var(--panel-2);
}
body::-webkit-scrollbar-thumb:hover {
    background: var(--border-subtle);
}


    .ops-card.span-2,
    .ops-card.span-3,
    .ops-card.span-4 { grid-column: span 1; }



    .news-item strong { color: var(--text); }
    .news-item.news-item-yahoo {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }
    .news-item.news-item-yahoo a { flex: 1 1 auto; min-width: 160px; }
    .news-impact {
        font-size: 0.55rem;
        padding: 1px 5px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        text-transform: uppercase;
        letter-spacing: 0.06em;
    }
    .news-impact.high { background: #d64545; color: var(--text); border-color: #d64545; }
    .news-impact.medium { background: #e0b94a; color: #ffffff; border-color: #e0b94a; }
    .news-impact.low { background: var(--panel-2); color: var(--text); border-color: var(--border); }
    .news-ai-btn {
        margin-left: auto;
        border: 1px solid var(--border);
        background: var(--panel-2);
        color: var(--accent);
        width: 28px;
        height: 24px;
        border-radius: var(--radius-sm);
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    .news-ai-btn svg { width: 16px; height: 16px; }
    .news-ai-btn:hover { background: var(--panel-3); }
    .news-filter-row,
    .ff-hot-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
        font-size: 0.6rem;
        color: var(--dim);
        margin-top: 4px;
    }
    .news-filter-row {
        border-top: 1px solid var(--border-subtle);
        padding-top: 4px;
        margin-top: 6px;
    }
    .news-filter-row label,
    .ff-hot-row label {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
    }
    .ff-hot {
        background: var(--panel-2) !important;
        border: 1px solid var(--red);
        border-radius: 2px;
    }

.ff-low { background: var(--panel-2); color: var(--text); border: 1px solid var(--border); }
.ai-btn {
    border: 1px solid var(--border);
    background: var(--panel-2);
    color: var(--accent);
    width: 36px;
    height: 36px;
    border-radius: var(--radius-sm);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow: none;
}
.ai-btn svg { width: 24px; height: 24px; }
.ai-btn:hover { background: var(--panel-3); }
.ai-fab {
    position: absolute;
    right: 12px;
    top: 8px;
    z-index: 6;
}
.ai-modal { max-width: 980px; width: min(94vw, 980px); }
.ai-modal h2 {
    border-bottom: none;
    padding-bottom: 0;
    margin-bottom: 0;
    text-transform: none;
    letter-spacing: 0.02em;
    color: var(--text);
}
.ai-chat-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 16px;
    flex-wrap: wrap;
    margin-bottom: 12px;
}
.ai-title {
    margin: 0;
    font-size: 1.1rem;
    color: var(--text);
    letter-spacing: 0.01em;
}
.ai-subtitle {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 4px;
}
.ai-key-row {
    display: flex;
    gap: 6px;
    align-items: center;
    flex-wrap: wrap;
}
.ai-key-row .ai-input {
    min-width: 220px;
    max-width: 320px;
}
.ai-input, .ai-textarea {
    background: var(--input);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 6px 8px;
    border-radius: var(--radius-sm);
    font-family: inherit;
    font-size: 0.78rem;
    width: 100%;
    box-sizing: border-box;
}
.ai-textarea { min-height: 90px; resize: vertical; }
.ai-context {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    border: 1px solid var(--border);
    background: var(--panel-2);
    border-radius: var(--radius-sm);
    padding: 6px 8px;
    margin-bottom: 12px;
}
.ai-context-label {
    font-size: 0.6rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--text-muted);
}
.ai-link {
    background: transparent;
    border: none;
    color: var(--accent);
    padding: 0;
    font-size: 0.7rem;
}
.ai-chat {
    background: var(--panel-2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 10px;
    min-height: 220px;
    max-height: 360px;
    overflow: auto;
}
.ai-messages { display: flex; flex-direction: column; gap: 8px; }
.ai-msg { display: flex; animation: fadeUp 0.25s ease both; }
.ai-msg.user { justify-content: flex-end; }
.ai-bubble {
    max-width: 78%;
    padding: 8px 10px;
    border-radius: 12px;
    background: var(--panel-3);
    border: 1px solid var(--border);
    font-size: 0.78rem;
    line-height: 1.45;
    white-space: pre-wrap;
}
.ai-bubble strong { color: var(--text); }
.ai-msg.user .ai-bubble {
    background: rgba(43,136,216,0.18);
    border-color: rgba(43,136,216,0.4);
}
.ai-input-row {
    display: flex;
    gap: 8px;
    align-items: flex-end;
    margin-top: 12px;
}
.ai-chat-input { min-height: 64px; }
.ai-send-btn { min-width: 88px; }
.ai-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
}
.ai-status {
    font-size: 0.7rem;
    color: var(--text-muted);
}
.ai-pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 2px 6px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: var(--panel-2);
    font-size: 0.68rem;
    color: var(--text);
}

</style>
</head>
<body>

<!-- SETTINGS OVERLAY -->
<div id="set-ov" class="overlay" onclick="tog('set-ov',0)">
  <div class="modal" onclick="event.stopPropagation()">
    <span class="close-btn" onclick="tog('set-ov',0)">&times;</span>
    <h2>Settings</h2>

    <div class="settings-tabs">
        <button class="tab-btn active" data-tab="set-theme">Theme</button>
        <button class="tab-btn" data-tab="set-layout">Layout</button>
        <button class="tab-btn" data-tab="set-data">Data</button>
        <button class="tab-btn" data-tab="set-advanced">Advanced</button>
    </div>

    <div id="set-theme" class="tab-panel active">
        <div class="setting-group">
            <div class="setting-title">Theme Presets</div>
            <div class="setting-desc">Pick a base look for the dashboard.</div>
            <div class="setting-row">
                <label class="setting-label">Theme</label>
                <select id="theme-select" class="theme-select">
                    <option value="bloomberg">Bloomberg Black</option>
                    <option value="nightops">Night Ops Blue</option>
                    <option value="minimal">Minimal Grey</option>
                    <option value="terminal">Terminal Green</option>
                </select>
            </div>
            <div class="theme-preview">
                <div class="theme-swatch bg"></div>
                <div class="theme-swatch card"></div>
                <div class="theme-swatch accent"></div>
                <div class="theme-swatch text">Aa</div>
            </div>
        </div>

        <div class="setting-group accordion">
            <button class="accordion-header" data-acc="acc-colors">Custom Colors</button>
            <div id="acc-colors" class="accordion-body">
                <div class="setting-row">
                    <label class="setting-label">Main Background</label>
                    <input type="color" id="p-bg" oninput="upTh('--bg',this.value)">
                </div>
                <div class="setting-row">
                    <label class="setting-label">Card Background</label>
                    <input type="color" id="p-cd" oninput="upTh('--card',this.value)">
                </div>
                <div class="setting-row">
                    <label class="setting-label">Text Color</label>
                    <input type="color" id="p-tx" oninput="upTh('--text',this.value)">
                </div>
                <div class="setting-row">
                    <label class="setting-label">Alert Background</label>
                    <input type="color" id="p-al" oninput="upTh('--alert',this.value)">
                </div>
            </div>
        </div>
    </div>

    <div id="set-layout" class="tab-panel">
        <div class="setting-group">
            <div class="setting-title">Global Scale</div>
            <div class="setting-desc">Adjust overall text size and widget sizing.</div>
            <div class="setting-row">
                <label class="setting-label">Text Size</label>
                <input type="range" min="12" max="24" value="16" oninput="upTh('size',this.value)">
            </div>
            <div class="scale-grid">
                <div class="scale-item">
                    <div class="scale-label">Timers</div>
                    <input id="timer-scale" type="range" min="0.85" max="1.35" step="0.01"
                           oninput="setScale('--timer-scale', this.value, 'timer-scale')">
                </div>
                <div class="scale-item">
                    <div class="scale-label">Yahoo Panel</div>
                    <input id="yahoo-scale" type="range" min="0.85" max="1.25" step="0.01"
                           oninput="setScale('--yahoo-scale', this.value, 'yahoo-scale')">
                </div>
                <div class="scale-item">
                    <div class="scale-label">Econ Panel</div>
                    <input id="econ-scale" type="range" min="0.85" max="1.25" step="0.01"
                           oninput="setScale('--econ-scale', this.value, 'econ-scale')">
                </div>
            </div>
        </div>

        <div class="setting-group">
            <div class="setting-title">Visible Timeframes</div>
            <div class="setting-desc">Hide or show timeframe cards and use quick presets.</div>
            <div class="chip-row">
                <button onclick="applyLayoutPreset('scalp')">Scalping</button>
                <button onclick="applyLayoutPreset('swing')">Swing</button>
                <button onclick="applyLayoutPreset('all')">All</button>
            </div>
            <div id="tf-list" class="tf-list"></div>
        </div>
    </div>

    <div id="set-data" class="tab-panel">
        <div class="setting-group">
            <div class="setting-title">News & Calendar</div>
            <div class="setting-desc">Control auto-refresh behavior.</div>
            <div class="setting-row">
                <label class="setting-label">Yahoo Auto Refresh</label>
                <select id="news-refresh-select" class="news-select">
                    <option value="0">Off (Manual)</option>
                    <option value="60000">Every 1 min</option>
                    <option value="300000">Every 5 min</option>
                    <option value="900000">Every 15 min</option>
                </select>
            </div>
            <div class="setting-row">
                <label class="setting-label">Econ Auto Refresh</label>
                <select id="econ-refresh-select" class="news-select">
                    <option value="0">Off (Manual)</option>
                    <option value="900000">Every 15 min</option>
                    <option value="3600000">Every 60 min</option>
                </select>
            </div>
        </div>
    </div>

    <div id="set-advanced" class="tab-panel">
        <div class="setting-group">
            <div class="setting-title">Reset</div>
            <div class="setting-desc">Restore all settings to defaults.</div>
            <button class="rst-btn" onclick="resetTh()">RESET TO DEFAULTS</button>
        </div>
    </div>
  </div>
</div>

<!-- HELP OVERLAY -->
<div id="hlp-ov" class="overlay" onclick="tog('hlp-ov',0)">
  <div class="modal" onclick="event.stopPropagation()">
    <span class="close-btn" onclick="tog('hlp-ov',0)">&times;</span>
    <h2>Dashboard Help</h2>
    <h3>1. Timers</h3>
    <p>Each card is a candle timeframe. The timer shows how much time is left before the current candle closes.</p>
    <p><strong>ALERT AT</strong> is the number of seconds (or HH:MM:SS) before close where the card turns red and (if not muted) the system speaks an alert.</p>
    <h3>2. Mute & Visibility</h3>
    <p>Use the <strong>MUTE</strong> checkbox on each card to silence audio alerts per timeframe. Grey titles indicate muted timers.</p>
    <p>In <strong>SETTINGS â†’ Visible Timeframes</strong> you can hide/show each timeframe card entirely, or use the presets (Scalping / Swing / All). Each timeframe also has a size slider.</p>
    <h3>3. RTH Session & Alarm</h3>
    <p>The RTH card counts down until market open, then until close. It will speak when the alert threshold is hit. The 10 AM alarm button plays a short beep at 9:59 AM ET once per day (no TTS).</p>
    <h3>4. News & Economic Calendar</h3>
    <p>Yahoo has its own date and refresh (manual or auto). Economic calendar uses the Forex Factory JSON via your local Node server.</p>
    <p>Impact colors: <span class="ff-badge ff-high">High</span> <span class="ff-badge ff-medium">Medium</span> <span class="ff-badge ff-low">Low</span>.</p>
    <p>Hot Alerts highlight econ events inside 5/10/15 minutes and can beep when enabled.</p>
    <h3>5. Shortcuts</h3>
    <ul>
        <li><strong>S</strong> â†’ Toggle sound</li>
        <li><strong>N</strong> â†’ Refresh Yahoo news</li>
        <li><strong>E</strong> â†’ Refresh economic calendar</li>
        <li><strong>A</strong> â†’ Toggle 10 AM alarm</li>
    </ul>
  </div>
</div>

<!-- NOTES OVERLAY -->
<div id="notes-ov" class="overlay" onclick="tog('notes-ov',0)">
  <div class="modal" onclick="event.stopPropagation()">
    <span class="close-btn" onclick="tog('notes-ov',0)">&times;</span>
    <h2>Today's Notes</h2>
    <textarea id="notes-area" class="notes-area" placeholder="Trade plans, levels, mindset reminders..."></textarea>
    <div id="notes-meta" class="notes-meta">Saved locally</div>
  </div>
</div>

<!-- AI CHAT OVERLAY -->
<div id="ai-ov" class="overlay" onclick="tog('ai-ov',0)">
  <div class="modal ai-modal" onclick="event.stopPropagation()">
    <span class="close-btn" onclick="tog('ai-ov',0)">&times;</span>
    <div class="ai-chat-header">
        <div>
            <h2 class="ai-title">Market Copilot</h2>
            <div class="ai-subtitle">Chat about headlines, catalysts, and levels in real time.</div>
        </div>
        <div class="ai-key-row">
            <input id="ai-key" class="ai-input" type="password" placeholder="Groq API key (stored locally)">
            <button class="header-btn" onclick="saveAiKey()">Save Key</button>
        </div>
    </div>
    <div class="ai-context">
        <span class="ai-context-label">Context</span>
        <span id="ai-context" class="ai-pill">No headline attached</span>
        <button class="ai-link" onclick="clearAiContext()">Clear</button>
    </div>
    <div class="ai-chat">
        <div id="ai-messages" class="ai-messages"></div>
    </div>
    <div class="ai-input-row">
        <textarea id="ai-input" class="ai-textarea ai-chat-input" placeholder="Ask about impact, levels, and catalyst risk..."></textarea>
        <button class="header-btn ai-send-btn" onclick="sendAiMessage()">Send</button>
    </div>
    <div class="ai-actions">
        <span id="ai-status" class="ai-status"></span>
    </div>
  </div>
</div>

<!-- TOP BAR -->
<div class="top-bar">
    <div class="time-block">
        <span class="time-label">NY TIME (ET)</span><br>
        <span id="ny" class="time-value">--:--</span>
    </div>
    <div class="cluster">
        <button id="snd-btn" class="audio-btn" onclick="togSnd()">SOUND: OFF</button>
        <button id="alarm10-btn" class="alarm-btn" onclick="togAlarm10()">10 AM ALARM: ON</button>
    </div>
    <div class="btn-group cluster">
        <button class="header-btn" onclick="tog('set-ov',1)">SETTINGS</button>
        <button class="header-btn" onclick="tog('notes-ov',1)">NOTES</button>
        <button class="header-btn help-btn" onclick="tog('hlp-ov',1)">HELP</button>
    </div>
</div>

<!-- STATUS BAR -->
<div class="status-bar">
    <span id="status-market">STATUS: --</span>
    <span id="status-news">News: Manual</span>
    <span id="status-econ">Econ: Manual</span>
    <span id="status-alert">Alert: --</span>
</div>

<!-- SECTION BAR -->
<!-- TIMERS GRID -->
<div class="grid-wrapper">
    <div class="grid-container" id="grid"></div>
</div>


<!-- NEWS AREA (YAHOO + ECON CALENDAR) -->
<div class="news-wrapper">
    <!-- Yahoo Finance -->
    <div class="news-container" data-panel="yahoo">
        <div class="news-header">
            <div class="news-title">ðŸ“° Market News Feed</div>
            <div class="news-controls">
                <span style="font-size:0.75rem;color:var(--dim);">Date:</span>
                <select id="news-date" class="news-select"></select>
                <button class="news-refresh" onclick="refreshNews()">REFRESH NEWS</button>
                <button id="news-voice-btn" class="news-voice-btn" onclick="togNewsVoice()">News TTS: ON</button>
                <span id="yahoo-refresh-state" class="refresh-state"></span>
            </div>
        </div>
        <div class="news-filter-row">
            <span>Impact:</span>
            <label><input type="checkbox" class="news-imp" value="high" checked> <span class="news-impact high">High</span></label>
            <label><input type="checkbox" class="news-imp" value="medium" checked> <span class="news-impact medium">Medium</span></label>
            <label><input type="checkbox" class="news-imp" value="low" checked> <span class="news-impact low">Low</span></label>
        </div>
        <button class="ai-btn ai-fab" onclick="openAiHelper()" title="AI helper" aria-label="AI helper">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <rect x="4" y="6" width="16" height="12" rx="3" stroke="currentColor" stroke-width="1.8"/>
                <circle cx="9" cy="12" r="1.7" fill="currentColor"/>
                <circle cx="15" cy="12" r="1.7" fill="currentColor"/>
                <path d="M8 16h8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                <path d="M12 3v2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                <path d="M7 3l2 2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                <path d="M17 3l-2 2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
            </svg>
        </button>
        <div id="news-list" class="news-list">Loadingâ€¦</div>
    </div>

    <!-- Economic Calendar (Forex Factory via backend) -->
    <div class="news-container" data-panel="econ">
        <div class="news-header">
            <div class="news-title">ðŸ“… Economic Calendar</div>
            <div class="econ-controls">
                <span>ECON DATE:</span>
                <select id="econ-date" class="news-select"></select>
                <button class="news-refresh" onclick="refreshEcon()">REFRESH CALENDAR</button>
            </div>
        </div>
        <div class="ff-filter-row">
            <span>Currencies:</span>
            <label><input type="checkbox" class="ff-country" value="USD" checked> USD</label>
            <label><input type="checkbox" class="ff-country" value="EUR" checked> EUR</label>
            <label><input type="checkbox" class="ff-country" value="GBP" checked> GBP</label>
            <label><input type="checkbox" class="ff-country" value="JPY" checked> JPY</label>
            <label><input type="checkbox" class="ff-country" value="CAD"> CAD</label>
            <label><input type="checkbox" class="ff-country" value="AUD"> AUD</label>
            <label><input type="checkbox" class="ff-country" value="NZD"> NZD</label>
            <label><input type="checkbox" class="ff-country" value="CHF"> CHF</label>
            <label><input type="checkbox" class="ff-country" value="CNY"> CNY</label>
            <span>Impact:</span>
            <label><input type="checkbox" class="ff-imp" value="high" checked> <span class="ff-badge ff-high">High</span></label>
            <label><input type="checkbox" class="ff-imp" value="medium" checked> <span class="ff-badge ff-medium">Medium</span></label>
            <label><input type="checkbox" class="ff-imp" value="low" checked> <span class="ff-badge ff-low">Low</span></label>
        </div>
        <div class="ff-hot-row">
            <span>Hot Alerts:</span>
            <label><input type="checkbox" class="ff-hot-min" value="15" checked> 15m</label>
            <label><input type="checkbox" class="ff-hot-min" value="10" checked> 10m</label>
            <label><input type="checkbox" class="ff-hot-min" value="5" checked> 5m</label>
            <label><input type="checkbox" id="ff-hot-beep" checked> Beep</label>
        </div>
        <div id="ff-next" class="ff-next-banner">Next event: â€“</div>
        <div id="ff-list" class="news-list">Loadingâ€¦</div>
    </div>
</div>

<script>
/* THEME SYSTEM */
const THEMES = {
    bloomberg: { '--bg': '#1b1b1b', '--card': '#262626', '--text': '#f2f2f2', '--alert': '#d63b3b' },
    nightops:  { '--bg': '#191919', '--card': '#242424', '--text': '#ededed', '--alert': '#d63b3b' },
    minimal:   { '--bg': '#1d1d1d', '--card': '#2a2a2a', '--text': '#f0f0f0', '--alert': '#d63b3b' },
    terminal:  { '--bg': '#1b1b1b', '--card': '#262626', '--text': '#d9f3d9', '--alert': '#d63b3b' }
};

/* TIMER CONFIG (with roles) */
const config = [
    { label: "1 Minute",   seconds: 60,    type: "standard", warn: "00:00:10", role: "Scalp" },
    { label: "2 Minute",   seconds: 120,   type: "standard", warn: "00:00:15", role: "Scalp" },
    { label: "3 Minute",   seconds: 180,   type: "standard", warn: "00:00:20", role: "Entry" },
    { label: "5 Minute",   seconds: 300,   type: "standard", warn: "00:00:30", role: "Entry" },
    { label: "10 Minute",  seconds: 600,   type: "standard", warn: "00:01:00", role: "Entry" },
    { label: "15 Minute",  seconds: 900,   type: "standard", warn: "00:01:30", role: "Trend" },
    { label: "30 Minute",  seconds: 1800,  type: "standard", warn: "00:03:00", role: "Trend" },
    { label: "1 Hour",     seconds: 3600,  type: "standard", warn: "00:05:00", role: "Context" },
    { label: "2 Hour",     seconds: 7200,  type: "aligned",  warn: "00:10:00", role: "Context" },
    { label: "4 Hour",     seconds: 14400, type: "aligned",  warn: "00:15:00", role: "Swing" }
];

let offset = 0;
let audioOn = false;
let newsSpeechOn = true;
let lastSpeak = {};   // avoid repeating same-second TTS

/* Visible timeframes */
let visibleTimeframes = [];

/* NEWS STATE */
const seenNewsIds = new Set();   // Yahoo
const seenFFIds = new Set();     // Econ calendar
let yahooLastHtml = "";
let yahooLastUpdated = "";

/* Auto-refresh state */
let newsRefreshMs = 0;
let econRefreshMs = 0;
let newsRefreshTimer = null;
let econRefreshTimer = null;

/* Status bar state */
let statusMarket = "--";
let statusNews = "Manual";
let statusEcon = "Manual";
let statusAlert = "--";

/* News impact filters */
let newsImpactFilters = { high: true, medium: true, low: true };

/* Econ hot alerts */
let econHotLevels = [15, 10, 5];
let econHotBeep = true;
const econHotTriggered = new Set();

/* 10 AM Alarm state */
let alarm10Enabled = true;
let alarm10LastDate = localStorage.getItem("alarm10-last") || "";

/* Web Audio for alarm beep */
let audioCtx = null;

/* Yahoo RSS via AllOrigins */
const YF_RSS = "https://feeds.finance.yahoo.com/rss/2.0/headline?s=%5EGSPC&region=US&lang=en-US";
const YF_FEED_BASE = "https://api.allorigins.win/raw?url=";
const YF_RSS_API = "http://localhost:3000/api/yahoo-rss";

/* ECON BACKEND (Forex Factory proxy) */
const ECON_API_BASE = "http://localhost:3000/api/ff-calendar";
const FF_DIRECT_BASE = "https://nfs.faireconomy.media/ff_calendar_";
const FF_CACHE_TTL_MS = 10 * 60 * 1000;
const ffWeekCache = new Map();

/* Index quotes via Yahoo JSON */
const INDEX_YAHOO_URL = "https://query1.finance.yahoo.com/v7/finance/quote?symbols=SPY,QQQ,^VIX";
let indexTimer = null;

/* INIT */
function init() {
    loadVisibleTimeframes();
    renderTimerGrid();
    buildTimeframeSettingsUI();
    loadTh();
    loadScales();      // NEW
    initSettingsTabs();
    initNotes();
    initNewsControls();
    initNewsFilters();
    initEconHotControls();
    bindNewsAiButtons();
    initAlarmButton();
    loadAiKey();
    initAiChat();
    loop();
    refreshNews(); // initial Yahoo
}

/* --- NEW: SCALE SYSTEM (GLOBAL WIDGET SCALE) --- */
function setScale(cssVar, value, storageKey) {
    const v = Math.max(0.5, Math.min(2, parseFloat(value) || 1));
    document.documentElement.style.setProperty(cssVar, String(v));
    localStorage.setItem(storageKey, String(v));
}
function loadScales() {
    const timer = parseFloat(localStorage.getItem("timer-scale") || "1");
    const yahoo = parseFloat(localStorage.getItem("yahoo-scale") || "1");
    const econ  = parseFloat(localStorage.getItem("econ-scale")  || "1");

    document.documentElement.style.setProperty("--timer-scale", String(timer));
    document.documentElement.style.setProperty("--yahoo-scale", String(yahoo));
    document.documentElement.style.setProperty("--econ-scale",  String(econ));

    const t = document.getElementById("timer-scale");
    const y = document.getElementById("yahoo-scale");
    const e = document.getElementById("econ-scale");
    if (t) t.value = String(timer);
    if (y) y.value = String(yahoo);
    if (e) e.value = String(econ);
}

function initSettingsTabs() {
    const tabs = Array.from(document.querySelectorAll(".settings-tabs .tab-btn"));
    const panels = Array.from(document.querySelectorAll(".tab-panel"));
    if (!tabs.length || !panels.length) return;

    function activate(id) {
        tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === id));
        panels.forEach(p => p.classList.toggle("active", p.id === id));
    }

    tabs.forEach(btn => {
        btn.addEventListener("click", () => {
            activate(btn.dataset.tab);
        });
    });

    const accBtns = Array.from(document.querySelectorAll(".accordion .accordion-header"));
    accBtns.forEach(btn => {
        btn.addEventListener("click", () => {
            const parent = btn.closest(".accordion");
            if (parent) parent.classList.toggle("open");
        });
    });
}

/* Theme functions */
function applyTheme(themeKey, save = true) {
    const theme = THEMES[themeKey] || THEMES['bloomberg'];
    Object.entries(theme).forEach(([k, v]) => {
        document.documentElement.style.setProperty(k, v);
        localStorage.setItem(k, v);
    });

    const bgInput = document.getElementById('p-bg');
    const cdInput = document.getElementById('p-cd');
    const txInput = document.getElementById('p-tx');
    const alInput = document.getElementById('p-al');
    if (bgInput) bgInput.value = theme['--bg'];
    if (cdInput) cdInput.value = theme['--card'];
    if (txInput) txInput.value = theme['--text'];
    if (alInput) alInput.value = theme['--alert'];

    const sel = document.getElementById('theme-select');
    if (sel) sel.value = themeKey;

    if (save) localStorage.setItem('theme', themeKey);
}

/* Visible timeframes state */
function loadVisibleTimeframes() {
    const saved = localStorage.getItem("tf-visible");
    if (!saved) {
        visibleTimeframes = config.map(() => true);
    } else {
        const set = new Set(saved.split(",").map(x => parseInt(x,10)));
        visibleTimeframes = config.map((_, i) => set.has(i));
    }
}
function saveVisibleTimeframes() {
    const indices = config
        .map((_, i) => visibleTimeframes[i] ? i : null)
        .filter(i => i !== null);
    localStorage.setItem("tf-visible", indices.join(","));
}

/* Build timer cards grid */
function renderTimerGrid() {
    let html = "";

    config.forEach((c, i) => {
        if (!visibleTimeframes[i]) return;

        const savedWarn = localStorage.getItem('w-'+i) || c.warn;
        const savedMute = localStorage.getItem('mute-'+i) === '1';

        /* NEW: per-card scale */
        const tfScale = parseFloat(localStorage.getItem("tf-scale-" + i) || "1");

        let timeHTML =
            c.seconds === 60
              ? '<span id="t-'+i+'" class="c-time">00</span><span id="m-'+i+'" class="c-ms">.00</span>'
              : '<span id="t-'+i+'" class="c-time">00:00</span>';

        let alignHTML = "";
        if (c.type === "aligned") {
            const alignTime = localStorage.getItem('a-'+i) || (c.seconds === 14400 ? "17:00" : "00:00");
            alignHTML =
              '<div class="panel-row">' +
                '<span class="row-label">Align</span>' +
                '<span class="row-value">' +
                  '<input type="time" id="a-'+i+'" class="align-in" value="'+alignTime+'" onchange="save()">' +
                '</span>' +
              '</div>';
        }

        const roleHTML = c.role ? '<div class="c-role">'+c.role+'</div>' : '';

        html +=
          '<div class="card panel" id="c-'+i+'" style="--card-scale:'+tfScale+';">' +
            '<div class="panel-head">' +
              '<div class="panel-title">' +
                '<div class="c-title" id="title-'+i+'">'+c.label+'</div>' +
                roleHTML +
              '</div>' +
            '</div>' +
            alignHTML +
            '<div class="panel-row time-row">' +
              '<span class="row-label">Time Left</span>' +
              '<span class="row-value">'+timeHTML+'</span>' +
            '</div>' +
            '<div class="panel-row">' +
              '<span class="row-label">Alert At</span>' +
              '<span class="row-value">' +
                '<input type="text" id="w-'+i+'" value="'+savedWarn+'" onchange="save()">' +
                '<label class="mute-label"><input type="checkbox" id="mu-'+i+'" '+(savedMute?'checked':'')+' onchange="save()"> Mute</label>' +
              '</span>' +
            '</div>' +
          '</div>';
    });

    // RTH SESSION CARD
    const rO = localStorage.getItem('ro') || "09:30";
    const rC = localStorage.getItem('rc') || "16:00";
    const rW = localStorage.getItem('rw') || "00:15:00";

    html +=
      '<div class="card panel rth" id="c-rth">' +
        '<div class="panel-head">' +
          '<div class="panel-title">' +
            '<div class="c-title">RTH SESSION</div>' +
          '</div>' +
        '</div>' +
        '<div class="panel-row">' +
          '<span class="row-label">Open</span>' +
          '<span class="row-value"><input type="time" id="ro" value="'+rO+'" onchange="save()"></span>' +
        '</div>' +
        '<div class="panel-row">' +
          '<span class="row-label">Close</span>' +
          '<span class="row-value"><input type="time" id="rc" value="'+rC+'" onchange="save()"></span>' +
        '</div>' +
        '<div class="panel-row time-row">' +
          '<span class="row-label">Session</span>' +
          '<span class="row-value stack">' +
            '<span id="trth" class="c-time">--</span>' +
            '<span id="srth" class="c-sub">LOAD</span>' +
          '</span>' +
        '</div>' +
        '<div class="panel-row">' +
          '<span class="row-label">Alert At</span>' +
          '<span class="row-value"><input type="text" id="rw" value="'+rW+'" onchange="save()"></span>' +
        '</div>' +
      '</div>';

    document.getElementById("grid").innerHTML = html;
}

/* Rebuild grid when visible timeframes change */
function rebuildGrid() {
    renderTimerGrid();
}

/* Build timeframe settings UI (UPDATED: includes per-card size sliders) */
function buildTimeframeSettingsUI() {
    const cont = document.getElementById("tf-list");
    if (!cont) return;

    let inner = "";
    config.forEach((c, i) => {
        const checked = visibleTimeframes[i] !== false;
        const sc = parseFloat(localStorage.getItem("tf-scale-" + i) || "1");

        inner += `
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;padding:6px;border:1px solid var(--border);background:var(--panel-2);border-radius:2px;">
            <label style="display:flex;align-items:center;gap:6px;min-width:120px;">
              <input type="checkbox" class="tf-toggle" data-idx="${i}" ${checked ? "checked" : ""}>
              <span style="font-size:0.7rem;color:var(--text);">${c.label}</span>
            </label>

            <div style="display:flex;align-items:center;gap:8px;flex:1;">
              <span style="font-size:0.65rem;color:var(--text-muted);min-width:54px;">Size</span>
              <input type="range" class="tf-scale" data-idx="${i}"
                     min="0.85" max="1.35" step="0.01" value="${sc}">
              <span style="font-size:0.65rem;color:var(--text-muted);width:42px;text-align:right;">${Math.round(sc*100)}%</span>
            </div>
          </div>
        `;
    });

    cont.innerHTML = inner;

    Array.from(cont.querySelectorAll(".tf-toggle")).forEach(cb => {
        cb.addEventListener("change", () => {
            const idx = parseInt(cb.getAttribute("data-idx"), 10);
            visibleTimeframes[idx] = cb.checked;
            saveVisibleTimeframes();
            rebuildGrid();
            buildTimeframeSettingsUI();
        });
    });

    Array.from(cont.querySelectorAll(".tf-scale")).forEach(sl => {
        sl.addEventListener("input", () => {
            const idx = parseInt(sl.getAttribute("data-idx"), 10);
            const v = parseFloat(sl.value);

            localStorage.setItem("tf-scale-" + idx, String(v));

            const pct = sl.parentElement.querySelector("span:last-child");
            if (pct) pct.textContent = `${Math.round(v*100)}%`;

            const card = document.getElementById("c-" + idx);
            if (card) card.style.setProperty("--card-scale", v);
        });
    });
}

/* Layout presets */
function applyLayoutPreset(name) {
    if (name === 'scalp') {
        visibleTimeframes = config.map((_, i) => i <= 4); // 1â€“10m
    } else if (name === 'swing') {
        visibleTimeframes = config.map((_, i) => i >= 4); // 10m+
    } else {
        visibleTimeframes = config.map(() => true);
    }
    saveVisibleTimeframes();
    rebuildGrid();
    buildTimeframeSettingsUI();
}

/* MAIN LOOP */
function loop() {
    try {
        const nowMs = Date.now() + offset;
        const now = new Date(nowMs);
        const nyEl = document.getElementById('ny');
        if (!nyEl) {
            requestAnimationFrame(loop);
            return;
        }

        const nyStr = now.toLocaleTimeString(
            'en-US',
            { timeZone: 'America/New_York', hour12: true }
        );
        nyEl.innerText = nyStr;

        const timeMatch = nyStr.match(/(\d+):(\d+):(\d+)\s*(AM|PM)/i);
        if (!timeMatch) {
            requestAnimationFrame(loop);
            return;
        }
        let h = parseInt(timeMatch[1],10);
        const m = parseInt(timeMatch[2],10);
        const s = parseInt(timeMatch[3],10);
        const ampm = timeMatch[4].toUpperCase();
        if (ampm === "PM" && h !== 12) h += 12;
        if (ampm === "AM" && h === 12) h = 0;

        const ms = 999 - now.getMilliseconds();

        // 10 AM alarm check
        check10Alarm(h, m, s);

        // Timer cards
        config.forEach((c, i) => {
            if (!visibleTimeframes[i]) return;

            let secRem = 0;
            const cardEl = document.getElementById('c-'+i);
            const tEl = document.getElementById('t-'+i);
            if (!cardEl || !tEl) return;

            if (c.type === "standard") {
                const total = Math.floor(nowMs/1000);
                secRem = c.seconds - (total % c.seconds) - 1;
            } else {
                const aEl = document.getElementById('a-'+i);
                const alignVal = aEl && aEl.value ? aEl.value : "00:00";
                const aParts = alignVal.split(':').map(Number);
                const aH = !Number.isNaN(aParts[0]) ? aParts[0] : 0;
                const intervalHrs = c.seconds / 3600;
                let dist = (aH - h) % intervalHrs;
                if (dist <= 0) dist += intervalHrs;
                secRem = ((dist - 1) * 3600) + ((59 - m) * 60) + (59 - s);
            }

            if (c.seconds === 60) {
                tEl.innerText = (secRem < 10 ? "0" : "") + secRem;
                const msEl = document.getElementById('m-'+i);
                if (msEl) {
                    msEl.innerText = "." + Math.floor(ms/10).toString().padStart(2, "0");
                }
            } else {
                tEl.innerText = fmt(secRem, c.seconds >= 3600);
            }

            const wEl = document.getElementById('w-'+i);
            const thresh = parseTime(wEl ? wEl.value : c.warn);

            if (secRem <= thresh) cardEl.classList.add("alert");
            else cardEl.classList.remove("alert");

            const muteEl = document.getElementById('mu-'+i);
            const isMuted = muteEl ? muteEl.checked : false;

            const titleEl = document.getElementById('title-'+i);
            if (titleEl) {
                if (isMuted) titleEl.classList.add('muted');
                else titleEl.classList.remove('muted');
            }

            if (secRem === thresh) {
                if (lastSpeak['c-'+i] !== secRem && !isMuted) {
                    speak(c.label + " candle closing in " + thresh + " seconds");
                    setLastAlert(c.label + " close " + thresh + "s");
                    lastSpeak['c-'+i] = secRem;
                }
            } else {
                lastSpeak['c-'+i] = -1;
            }
        });

        // RTH LOGIC
        const roEl = document.getElementById('ro');
        const rcEl = document.getElementById('rc');
        const trthEl = document.getElementById('trth');
        const srthEl = document.getElementById('srth');
        const rCardEl = document.getElementById('c-rth');

        if (roEl && rcEl && trthEl && srthEl && rCardEl) {
            const roParts = roEl.value.split(':').map(Number);
            const rcParts = rcEl.value.split(':').map(Number);
            const ro = [
                !Number.isNaN(roParts[0]) ? roParts[0] : 9,
                !Number.isNaN(roParts[1]) ? roParts[1] : 30
            ];
            const rc = [
                !Number.isNaN(rcParts[0]) ? rcParts[0] : 16,
                !Number.isNaN(rcParts[1]) ? rcParts[1] : 0
            ];

            const nowS = (h*3600) + (m*60) + s;
            const oS = (ro[0]*3600) + (ro[1]*60);
            const cS = (rc[0]*3600) + (rc[1]*60);

            const rwEl = document.getElementById('rw');
            const rthThresh = parseTime(rwEl ? rwEl.value : "00:15:00");

            let phase = "Closed";

            if (nowS >= oS && nowS < cS) {
                const diff = cS - nowS - 1;
                trthEl.innerText = fmt(diff, true);
                srthEl.innerText = "MARKET OPEN";
                phase = "RTH";

                if (diff <= rthThresh) rCardEl.classList.add("alert");
                else rCardEl.classList.remove("alert");

                if (diff === rthThresh && lastSpeak['rth'] !== diff) {
                    speak("Session closing in " + rthThresh + " seconds");
                    setLastAlert("Session close " + rthThresh + "s");
                    lastSpeak['rth'] = diff;
                }

                rCardEl.style.borderColor = "var(--green)";
            } else {
                rCardEl.classList.remove("alert");
                if (nowS < oS) {
                    trthEl.innerText = fmt(oS - nowS - 1, true);
                    srthEl.innerText = "PRE-MARKET";
                    phase = "Premarket";
                    rCardEl.style.borderColor = "var(--focus)";
                } else {
                    trthEl.innerText = "CLOSED";
                    srthEl.innerText = "SESSION ENDED";
                    phase = "Closed";
                    rCardEl.style.borderColor = "var(--border)";
                }
            }

            if (phase !== statusMarket) {
                statusMarket = phase;
                updateStatusBar();
            }
        }
    } catch (e) {
        console.warn("Loop error caught:", e);
    }

    requestAnimationFrame(loop);
}

/* HELPERS */
function speak(msg) {
    if (!audioOn) return;
    try {
        const u = new SpeechSynthesisUtterance(msg);
        u.rate = 1.1;
        window.speechSynthesis.speak(u);
    } catch (e) {
        console.warn("Speech error:", e);
    }
}
function setAudioOn(on, announce) {
    audioOn = !!on;
    const btn = document.getElementById('snd-btn');
    if (!btn) return;
    if (audioOn) {
        btn.innerText = "SOUND: ON";
        btn.classList.add('on');
        if (announce) speak("Audio enabled");
    } else {
        btn.innerText = "SOUND: OFF";
        btn.classList.remove('on');
    }
}
function togSnd() {
    setAudioOn(!audioOn, true);
}
function setLastAlert(msg) {
    statusAlert = msg || "--";
    updateStatusBar();
}
function parseTime(v) {
    if (!v || typeof v !== "string") return 0;
    const p = v.split(':').map(Number);
    if (p.length === 3) return (p[0]*3600) + (p[1]*60) + p[2];
    if (p.length === 2) return (p[0]*60) + p[1];
    return Number.isNaN(p[0]) ? 0 : p[0];
}
function fmt(s, showHours) {
    if (s < 0) s = 0;
    const hr = Math.floor(s / 3600);
    const mn = Math.floor((s % 3600) / 60);
    const sc = s % 60;
    const base = (mn < 10 ? "0" : "") + mn + ":" + (sc < 10 ? "0" : "") + sc;
    return showHours ? hr + ":" + base : base;
}
function save() {
    config.forEach((c, i) => {
        const wEl = document.getElementById('w-'+i);
        if (wEl) localStorage.setItem('w-'+i, wEl.value);
        const muEl = document.getElementById('mu-'+i);
        if (muEl) localStorage.setItem('mute-'+i, muEl.checked ? '1' : '0');
        if (c.type === "aligned") {
            const aEl = document.getElementById('a-'+i);
            if (aEl) localStorage.setItem('a-'+i, aEl.value);
        }
    });
    const roEl = document.getElementById('ro');
    const rcEl = document.getElementById('rc');
    const rwEl = document.getElementById('rw');
    if (roEl) localStorage.setItem('ro', roEl.value);
    if (rcEl) localStorage.setItem('rc', rcEl.value);
    if (rwEl) localStorage.setItem('rw', rwEl.value);
}
function tog(id, s) {
    const el = document.getElementById(id);
    if (!el) return;
    if (s) el.classList.add("visible");
    else el.classList.remove("visible");
}
function upTh(p, v) {
    if (p === "size") {
        document.documentElement.style.fontSize = v + "px";
        localStorage.setItem('sz', v);
    } else {
        document.documentElement.style.setProperty(p, v);
        localStorage.setItem(p, v);
        if (p === '--bg')  { const i = document.getElementById('p-bg'); if (i) i.value = v; }
        if (p === '--card'){ const i = document.getElementById('p-cd'); if (i) i.value = v; }
        if (p === '--text'){ const i = document.getElementById('p-tx'); if (i) i.value = v; }
        if (p === '--alert'){const i = document.getElementById('p-al'); if (i) i.value = v; }
    }
}
function loadTh() {
    const themeKey = localStorage.getItem('theme') || 'bloomberg';
    applyTheme(themeKey, false);

    ['--bg','--card','--text','--alert'].forEach(k => {
        const v = localStorage.getItem(k);
        if (v) {
            document.documentElement.style.setProperty(k, v);
            if (k === '--bg')  { const i = document.getElementById('p-bg'); if (i) i.value = v; }
            if (k === '--card'){ const i = document.getElementById('p-cd'); if (i) i.value = v; }
            if (k === '--text'){ const i = document.getElementById('p-tx'); if (i) i.value = v; }
            if (k === '--alert'){const i = document.getElementById('p-al'); if (i) i.value = v; }
        }
    });

    const sz = localStorage.getItem('sz');
    if (sz) document.documentElement.style.fontSize = sz + "px";

    const sel = document.getElementById('theme-select');
    if (sel && !sel.dataset.bound) {
        sel.dataset.bound = '1';
        sel.value = themeKey;
        sel.addEventListener('change', e => applyTheme(e.target.value, true));
    }
}
function resetTh() {
    localStorage.clear();
    location.reload();
}

/* DATE HELPERS */
function getTodayNY() {
    const now = new Date();
    const nyStr = now.toLocaleString("en-US", { timeZone: "America/New_York" });
    const ny = new Date(nyStr);
    const y = ny.getFullYear();
    const m = String(ny.getMonth()+1).padStart(2, "0");
    const d = String(ny.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
}

/* 10 AM ALARM */
function initAlarmButton() {
    const saved = localStorage.getItem("alarm10");
    if (saved === "0") alarm10Enabled = false;
    updateAlarmButton();
}
function updateAlarmButton() {
    const btn = document.getElementById("alarm10-btn");
    if (!btn) return;
    if (alarm10Enabled) {
        btn.classList.add("on");
        btn.innerText = "10 AM ALARM: ON";
    } else {
        btn.classList.remove("on");
        btn.innerText = "10 AM ALARM: OFF";
    }
}
function togAlarm10() {
    alarm10Enabled = !alarm10Enabled;
    localStorage.setItem("alarm10", alarm10Enabled ? "1" : "0");
    updateAlarmButton();
}
function check10Alarm(h, m, s) {
    if (!alarm10Enabled) return;
    const today = getTodayNY();
    if (today === alarm10LastDate) return;
    if (h === 9 && m === 59 && s === 0) {
        if (audioOn) {
            playBeep();
        }
        setLastAlert("10 AM Alarm");
        alarm10LastDate = today;
        localStorage.setItem("alarm10-last", today);
    }
}
function playBeep() {
    try {
        if (!audioCtx) {
            const Ctx = window.AudioContext || window.webkitAudioContext;
            if (!Ctx) return;
            audioCtx = new Ctx();
        }
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = "sine";
        osc.frequency.value = 880;
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        gain.gain.setValueAtTime(0.35, now);
        gain.gain.exponentialRampToValueAtTime(0.0001, now + 1.0);
        osc.start(now);
        osc.stop(now + 1.0);
    } catch (e) {
        console.warn("Beep error:", e);
    }
}

function setYahooRefreshState(text, active) {
    const el = document.getElementById("yahoo-refresh-state");
    if (!el) return;
    el.innerText = text || "";
    el.classList.toggle("active", !!active);
}

function classifyNewsImpact(title) {
    const t = (title || "").toLowerCase();
    const high = [
        "cpi","ppi","fomc","fed","rate ","rates","rate hike","rate cut",
        "inflation","payroll","jobs","nfp","gdp","pce","powell",
        "ism","pmi","unemployment","treasury","auction"
    ];
    const medium = [
        "earnings","guidance","downgrade","upgrade","buyback","futures",
        "dow ","nasdaq","s&p","spx","bank","oil","crude","opec",
        "bitcoin","crypto","sec","ipo","merger","acquisition","tariff","sanction"
    ];
    if (high.some(k => t.includes(k))) return "high";
    if (medium.some(k => t.includes(k))) return "medium";
    return "low";
}
function shouldShowNewsImpact(impact) {
    return !!newsImpactFilters[impact];
}

/* ---------------------- NEWS: YAHOO ---------------------- */
function refreshYahoo() {
    const dateInput = document.getElementById("news-date");
    const selectedDate = dateInput && dateInput.value ? dateInput.value : "";
    const url = YF_RSS_API;

    const listEl = document.getElementById("news-list");
    const prevScroll = listEl ? listEl.scrollTop : 0;
    setYahooRefreshState("Refreshing...", true);

    fetch(url)
        .then(r => {
            if (!r.ok) throw new Error("Yahoo RSS backend error");
            return r.text();
        })
        .catch(() => {
            const fallbackUrl = YF_FEED_BASE + encodeURIComponent(YF_RSS);
            return fetch(fallbackUrl).then(r => r.text());
        })
        .then(str => {
            let doc;
            try {
                doc = new window.DOMParser().parseFromString(str, "text/xml");
            } catch (e) {
                console.warn("DOMParser error on Yahoo feed:", e);
                if (listEl && yahooLastHtml) {
                    listEl.innerHTML = yahooLastHtml;
                } else if (listEl) {
                    listEl.innerText = "Could not parse news.";
                }
                setYahooRefreshState("Refresh failed", false);
                return;
            }

            const items = Array.from(doc.querySelectorAll("item"));
            if (!listEl) return;

            let html = "";
            let firstNewTitle = null;
            let shown = 0;

            function appendItems(filterByDate) {
                items.forEach(it => {
                    if (shown >= 5) return;
                    const guid = it.querySelector("guid")?.textContent ||
                                 it.querySelector("link")?.textContent ||
                                 it.querySelector("title")?.textContent || "";
                    const title = it.querySelector("title")?.textContent?.trim() || "Untitled";
                    const link  = it.querySelector("link")?.textContent?.trim() || "#";
                    const pub   = it.querySelector("pubDate")?.textContent || "";
                    let tlabel = "";
                    let dStr = "";

                    if (pub) {
                        const d = new Date(pub);
                        if (!Number.isNaN(d.getTime())) {
                            tlabel = d.toLocaleTimeString("en-US", {
                                hour: "numeric",
                                minute: "2-digit",
                                hour12: true
                            });
                            const yy = d.getFullYear();
                            const mm = String(d.getMonth()+1).padStart(2,"0");
                            const dd = String(d.getDate()).padStart(2,"0");
                            dStr = `${yy}-${mm}-${dd}`;
                        }
                    }

                    if (filterByDate && selectedDate && dStr && dStr !== selectedDate) return;
                    const impact = classifyNewsImpact(title);
                    if (!shouldShowNewsImpact(impact)) return;
                    const impactLabel = impact === "high" ? "High" : (impact === "medium" ? "Medium" : "Low");
                    const aiText = title + (link && link !== "#" ? " (" + link + ")" : "");
                    const aiPayload = encodeURIComponent(aiText);

                    if (!seenNewsIds.has(guid)) {
                        seenNewsIds.add(guid);
                        if (!firstNewTitle) firstNewTitle = title;
                    }

                    html += '<div class="news-item news-item-yahoo">' +
                                (tlabel ? '<span class="news-time">'+tlabel+'</span>' : '') +
                                '<span class="news-impact '+impact+'">'+impactLabel+'</span>' +
                                '<strong>Yahoo Finance:</strong>' +
                                '<a href="'+link+'" target="_blank" rel="noopener noreferrer">'+title+'</a>' +
                                '<button class="news-ai-btn" data-headline="'+aiPayload+'" title="Send to AI" aria-label="Send to AI">' +
                                    '<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">' +
                                        '<rect x="4" y="6" width="16" height="12" rx="3" stroke="currentColor" stroke-width="1.6"/>' +
                                        '<circle cx="9" cy="12" r="1.4" fill="currentColor"/>' +
                                        '<circle cx="15" cy="12" r="1.4" fill="currentColor"/>' +
                                        '<path d="M8 16h8" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>' +
                                    '</svg>' +
                                '</button>' +
                            '</div>';
                    shown += 1;
                });
            }

            appendItems(true);
            if (!html && selectedDate) {
                html = "";
                shown = 0;
                firstNewTitle = null;
                appendItems(false);
            }

            if (html) {
                listEl.innerHTML = html;
                yahooLastHtml = html;
            } else if (!yahooLastHtml) {
                listEl.innerText = "No headlines match filters.";
            }

            if (listEl) {
                listEl.scrollTop = Math.min(prevScroll, listEl.scrollHeight);
            }

            const now = new Date();
            yahooLastUpdated = now.toLocaleTimeString("en-US", {
                hour: "numeric",
                minute: "2-digit",
                hour12: true
            });
            setYahooRefreshState("Updated " + yahooLastUpdated, false);

            if (firstNewTitle && audioOn && newsSpeechOn) {
                speak("Yahoo Finance: " + firstNewTitle);
                setLastAlert("News: " + firstNewTitle);
            }
        })
        .catch(err => {
            console.warn("Yahoo Finance feed error:", err);
            if (listEl && yahooLastHtml) {
                listEl.innerHTML = yahooLastHtml;
            } else if (listEl) {
                listEl.innerText = "Could not load news.";
            }
            setYahooRefreshState("Refresh failed", false);
        });
}

/* ---------------------- ECON CALENDAR (Forex Factory) ---------------------- */
function impactToLevel(impact) {
    if (!impact) return "low";
    const s = impact.toLowerCase();
    if (s.includes("high")) return "high";
    if (s.includes("medium")) return "medium";
    if (s.includes("low")) return "low";
    return "low";
}

function dayDiff(a, b) {
    const da = new Date(`${a}T00:00:00`);
    const db = new Date(`${b}T00:00:00`);
    const msPerDay = 24 * 60 * 60 * 1000;
    return Math.round((da - db) / msPerDay);
}

function pickEconVal(ev, keys) {
    if (!ev) return "";
    for (const k of keys) {
        if (ev[k] == null) continue;
        const s = String(ev[k]).trim();
        if (s) return s;
    }
    return "";
}
function fmtEconVal(v) {
    return v && String(v).trim() ? String(v).trim() : "--";
}

async function fetchFFWeekData(suffix) {
    const cached = ffWeekCache.get(suffix);
    const now = Date.now();
    if (cached && (now - cached.fetchedAt) < FF_CACHE_TTL_MS) {
        return cached.data;
    }

    const url = FF_DIRECT_BASE + suffix + ".json";
    let data = [];

    try {
        const resp = await fetch(url);
        if (!resp.ok) throw new Error("FF direct fetch failed");
        data = await resp.json();
    } catch (err) {
        const proxyUrl = YF_FEED_BASE + encodeURIComponent(url);
        const resp = await fetch(proxyUrl);
        if (!resp.ok) throw new Error("FF proxy fetch failed");
        data = await resp.json();
    }

    const arr = Array.isArray(data) ? data : [];
    ffWeekCache.set(suffix, { data: arr, fetchedAt: now });
    return arr;
}

async function fetchEconFallback(selectedDate, countriesVal, impParam) {
    const todayStr = getTodayNY();
    const diffFromToday = dayDiff(selectedDate, todayStr);
    const candidates = ["thisweek"];

    if (diffFromToday < 0 && diffFromToday >= -7) {
        candidates.push("lastweek");
    } else if (diffFromToday > 0 && diffFromToday <= 7) {
        candidates.push("nextweek");
    }

    let dataForDate = [];

    for (const suffix of candidates) {
        const weekData = await fetchFFWeekData(suffix);
        const subset = weekData.filter(ev => {
            if (!ev.date) return false;
            return ev.date.slice(0, 10) === selectedDate;
        });
        if (subset.length > 0) {
            dataForDate = subset;
            break;
        }
    }

    const countries = (countriesVal || "")
        .split(",")
        .map(s => s.trim().toUpperCase())
        .filter(Boolean);
    if (countries.length) {
        dataForDate = dataForDate.filter(ev =>
            ev.country && countries.includes(ev.country.toUpperCase())
        );
    }

    const impacts = (impParam || "")
        .split(",")
        .map(s => s.trim().toLowerCase())
        .filter(Boolean);
    if (impacts.length) {
        dataForDate = dataForDate.filter(ev =>
            ev.impact && impacts.includes(ev.impact.toLowerCase())
        );
    }

    dataForDate.sort((a, b) => new Date(a.date) - new Date(b.date));
    return dataForDate;
}

function renderEconData(data) {
    if (!Array.isArray(data)) data = [];
    const el = document.getElementById("ff-list");
    if (!el) return;

    let html = "";
    let firstNew = null;
    const now = new Date();
    let nextUpcoming = null;
    let nextDiff = Infinity;
    let rendered = 0;

    data.forEach(ev => {
        try {
            const id = (ev.country || "") + "|" + (ev.title || "") + "|" + (ev.date || "");
            if (!seenFFIds.has(id)) {
                seenFFIds.add(id);
                if (!firstNew) firstNew = ev;
            }

            const level = impactToLevel(ev.impact);
            const when = ev.date ? new Date(ev.date) : null;
            const timeLabel = when
                ? when.toLocaleTimeString("en-US", {
                      timeZone: "America/New_York",
                      hour: "numeric",
                      minute: "2-digit",
                      hour12: true
                  })
                : "";

            const minsDiff = when ? (when - now) / 60000 : 9999;
            let extraClass = "";
            if (minsDiff < 0) extraClass = " ff-past";
            else if (minsDiff <= 30) extraClass = " ff-soon";
            const hotMax = econHotLevels.length ? Math.max(...econHotLevels) : 0;
            if (hotMax && minsDiff >= 0 && minsDiff <= hotMax) {
                extraClass += " ff-hot";
            }

            if (minsDiff >= 0 && minsDiff < nextDiff) {
                nextDiff = minsDiff;
                nextUpcoming = { ev, timeLabel, level };
            }

            const country = ev.country || "";
            const title = ev.title || "Event";

            const niceImpact =
                level === "high" ? "High" :
                level === "medium" ? "Medium" : "Low";

            const actual = pickEconVal(ev, ["actual", "act"]);
            const forecast = pickEconVal(ev, ["forecast", "consensus"]);
            const previous = pickEconVal(ev, ["previous", "prev"]);
            const revised = pickEconVal(ev, ["revised", "revision", "revised_from", "revisedFrom"]);

            if (econHotLevels.length && minsDiff >= 0) {
                const eligible = econHotLevels.filter(level => minsDiff <= level);
                if (eligible.length) {
                    const level = Math.min.apply(null, eligible);
                    const key = id + "|" + level;
                    if (!econHotTriggered.has(key)) {
                        econHotTriggered.add(key);
                        setLastAlert(`Econ ${level}m: ${title}`);
                        if (econHotBeep && audioOn) {
                            playBeep();
                        }
                    }
                }
            }

            html +=
                '<div class="news-item ff-item'+extraClass+'">' +
                    '<div class="ff-main">' +
                        (timeLabel ? '<span class="ff-time">'+timeLabel+'</span>' : '') +
                        (country ? '<span class="ff-cur">['+country+']</span>' : '') +
                        '<span class="ff-badge ff-'+level+'">'+niceImpact+'</span>' +
                        '<span class="ff-label">Economic:</span>' +
                        '<span>'+title+'</span>' +
                    '</div>' +
                    '<div class="ff-stats">' +
                        '<span class="ff-stat"><span class="ff-stat-label">Act</span><span class="ff-stat-val">'+fmtEconVal(actual)+'</span></span>' +
                        '<span class="ff-stat"><span class="ff-stat-label">Fcst</span><span class="ff-stat-val">'+fmtEconVal(forecast)+'</span></span>' +
                        '<span class="ff-stat"><span class="ff-stat-label">Prev</span><span class="ff-stat-val">'+fmtEconVal(previous)+'</span></span>' +
                        '<span class="ff-stat"><span class="ff-stat-label">Rev</span><span class="ff-stat-val">'+fmtEconVal(revised)+'</span></span>' +
                    '</div>' +
                '</div>';
            rendered += 1;
        } catch (e) {
            console.warn("Error mapping econ event:", e);
        }
    });

    el.innerHTML = html || "No events found for selected filters.";

    const nextEl2 = document.getElementById("ff-next");
    if (nextEl2) {
        if (nextUpcoming) {
            const ev = nextUpcoming.ev;
            const level = nextUpcoming.level;
            const timeLabel = nextUpcoming.timeLabel;
            const what =
                level === "high" ? "High impact" :
                level === "medium" ? "Medium impact" : "Low impact";
            const country = ev.country || "";
            const title = ev.title || "event";
            const mins = Math.round(nextDiff);
            const minsText = mins <= 1 ? "now" : `in ${mins} min`;
            nextEl2.innerText =
                `Next ${what} event: ${timeLabel} ${country ? "["+country+"] " : ""}${title} (${minsText})`;
        } else {
            nextEl2.innerText = "No upcoming events for the rest of the selected day.";
        }
    }

    if (firstNew && audioOn && newsSpeechOn) {
        const level = impactToLevel(firstNew.impact);
        const when = firstNew.date ? new Date(firstNew.date) : null;
        const timeLabel = when
            ? when.toLocaleTimeString("en-US", {
                  timeZone: "America/New_York",
                  hour: "numeric",
                  minute: "2-digit",
                  hour12: true
              })
            : "";
        const country = firstNew.country || "";
        const title = firstNew.title || "event";

        const what =
            level === "high" ? "High impact" :
            level === "medium" ? "Medium impact" : "Low impact";

        const tPart = timeLabel ? " at " + timeLabel : "";
        const cPart = country ? " in " + country : "";

        speak("Economic calendar " + what + " event" + tPart + cPart + ": " + title);
        setLastAlert("Econ: " + title);
    }

    return rendered;
}

async function refreshEcon() {
    const econDateInput = document.getElementById("econ-date");
    const selectedDate = econDateInput && econDateInput.value ? econDateInput.value : getTodayNY();

    const countryCbs = Array.from(document.querySelectorAll(".ff-country"));
    const selectedCountries = countryCbs
        .filter(cb => cb.checked)
        .map(cb => cb.value);
    const countriesVal = selectedCountries.join(",");

    const impCheckboxes = Array.from(document.querySelectorAll(".ff-imp"));
    const imps = impCheckboxes
        .filter(cb => cb.checked)
        .map(cb => cb.value.toLowerCase());
    const impParam = imps.join(",");

    // Save filters
    localStorage.setItem("econ-date", selectedDate);
    localStorage.setItem("ff-countries", countriesVal);
    localStorage.setItem("ff-imp", impParam || "high,medium,low");

    const listEl = document.getElementById("ff-list");
    if (listEl) listEl.innerText = "Loadingâ€¦";
    const nextEl = document.getElementById("ff-next");
    if (nextEl) nextEl.innerText = "Next event: â€¦";

    const url =
        ECON_API_BASE +
        `?date=${encodeURIComponent(selectedDate)}` +
        (countriesVal ? `&countries=${encodeURIComponent(countriesVal)}` : "") +
        (impParam ? `&imp=${encodeURIComponent(impParam)}` : "");

    try {
        const r = await fetch(url);
        if (!r.ok) throw new Error("Backend error");
        const data = await r.json();
        const rendered = renderEconData(data);
        const todayStr = getTodayNY();
        if (!rendered && selectedDate !== todayStr) {
            const fallbackToday = await fetchEconFallback(todayStr, countriesVal, impParam);
            renderEconData(fallbackToday);
            if (econDateInput) econDateInput.value = todayStr;
            localStorage.setItem("econ-date", todayStr);
        }
    } catch (err) {
        console.warn("Econ calendar fetch error:", err);
        try {
            const fallbackData = await fetchEconFallback(selectedDate, countriesVal, impParam);
            const rendered = renderEconData(fallbackData);
            const todayStr = getTodayNY();
            if (!rendered && selectedDate !== todayStr) {
                const fallbackToday = await fetchEconFallback(todayStr, countriesVal, impParam);
                renderEconData(fallbackToday);
                if (econDateInput) econDateInput.value = todayStr;
                localStorage.setItem("econ-date", todayStr);
            }
        } catch (fallbackErr) {
            console.warn("Econ calendar fallback error:", fallbackErr);
            const el = document.getElementById("ff-list");
            if (el) el.innerText = "Could not load economic calendar.";
            const nextEl2 = document.getElementById("ff-next");
            if (nextEl2) nextEl2.innerText = "Backend offline or unreachable.";
        }
    }
}

/* Combined manual refresh for Yahoo */
function refreshNews() {
    refreshYahoo();
}

/* NEWS CONTROLS & AUTO REFRESH */
function setNewsAutoRefresh(ms) {
    if (newsRefreshTimer) clearInterval(newsRefreshTimer);
    newsRefreshMs = ms || 0;
    localStorage.setItem("news-refresh-ms", String(newsRefreshMs));
    if (newsRefreshMs > 0) {
        newsRefreshTimer = setInterval(refreshNews, newsRefreshMs);
    }
    statusNews = newsRefreshMs ? `Auto ${Math.round(newsRefreshMs/60000)}m` : "Manual";
    updateStatusBar();
    const sel = document.getElementById("news-refresh-select");
    if (sel && String(newsRefreshMs) !== sel.value) sel.value = String(newsRefreshMs);
}
function setEconAutoRefresh(ms) {
    if (econRefreshTimer) clearInterval(econRefreshTimer);
    econRefreshMs = ms || 0;
    localStorage.setItem("econ-refresh-ms", String(econRefreshMs));
    if (econRefreshMs > 0) {
        econRefreshTimer = setInterval(refreshEcon, econRefreshMs);
    }
    statusEcon = econRefreshMs ? `Auto ${Math.round(econRefreshMs/60000)}m` : "Manual";
    updateStatusBar();
    const sel = document.getElementById("econ-refresh-select");
    if (sel && String(econRefreshMs) !== sel.value) sel.value = String(econRefreshMs);
}

/* NEWS CONTROLS */
function initNewsControls() {
    const voiceBtn = document.getElementById("news-voice-btn");
    const dateInput = document.getElementById("news-date");
    const econDateInput = document.getElementById("econ-date");
    const impCheckboxes = Array.from(document.querySelectorAll(".ff-imp"));
    const countryCbs = Array.from(document.querySelectorAll(".ff-country"));

    initDateSelects();
    if (dateInput) {
        dateInput.addEventListener("change", () => {
            localStorage.setItem("news-date", dateInput.value || "");
            seenNewsIds.clear();
            refreshYahoo();
        });
    }
    if (econDateInput) {
        econDateInput.addEventListener("change", () => {
            seenFFIds.clear();
            refreshEcon();
        });
    }

    const savedCountries = localStorage.getItem("ff-countries");
    if (savedCountries) {
        const set = new Set(savedCountries.split(","));
        countryCbs.forEach(cb => { cb.checked = set.has(cb.value); });
    }
    countryCbs.forEach(cb => {
        cb.addEventListener("change", () => {
            seenFFIds.clear();
            refreshEcon();
        });
    });

    const savedImp = localStorage.getItem("ff-imp");
    if (savedImp) {
        const parts = savedImp.split(",").map(s => s.trim().toLowerCase());
        impCheckboxes.forEach(cb => { cb.checked = parts.includes(cb.value.toLowerCase()); });
    }
    impCheckboxes.forEach(cb => {
        cb.addEventListener("change", () => {
            seenFFIds.clear();
            refreshEcon();
        });
    });

    const savedVoice = localStorage.getItem("news-voice");
    if (savedVoice === "0") {
        newsSpeechOn = false;
        if (voiceBtn) {
            voiceBtn.classList.add("off");
            voiceBtn.innerText = "News TTS: OFF";
        }
    }

    const savedNewsMs = parseInt(localStorage.getItem("news-refresh-ms") || "0",10) || 0;
    const savedEconMs = parseInt(localStorage.getItem("econ-refresh-ms") || "0",10) || 0;

    setNewsAutoRefresh(savedNewsMs);
    setEconAutoRefresh(savedEconMs);

    const newsSel = document.getElementById("news-refresh-select");
    if (newsSel && !newsSel.dataset.bound) {
        newsSel.dataset.bound = "1";
        newsSel.value = String(newsRefreshMs);
        newsSel.addEventListener("change", () => {
            const ms = parseInt(newsSel.value,10) || 0;
            setNewsAutoRefresh(ms);
        });
    }

    const econSel = document.getElementById("econ-refresh-select");
    if (econSel && !econSel.dataset.bound) {
        econSel.dataset.bound = "1";
        econSel.value = String(econRefreshMs);
        econSel.addEventListener("change", () => {
            const ms = parseInt(econSel.value,10) || 0;
            setEconAutoRefresh(ms);
        });
    }

    refreshEcon();
}

function togNewsVoice() {
    newsSpeechOn = !newsSpeechOn;
    const btn = document.getElementById("news-voice-btn");
    if (btn) {
        if (newsSpeechOn) {
            btn.classList.remove("off");
            btn.innerText = "News TTS: ON";
        } else {
            btn.classList.add("off");
            btn.innerText = "News TTS: OFF";
        }
    }
    localStorage.setItem("news-voice", newsSpeechOn ? "1" : "0");
}

function initDateSelects() {
    const newsSelect = document.getElementById("news-date");
    const econSelect = document.getElementById("econ-date");
    const baseStr = getTodayNY ? getTodayNY() : new Date().toISOString().slice(0, 10);
    const baseDate = new Date(baseStr + "T00:00:00");

    populateDateSelect(newsSelect, baseDate, true, "news-date");
    populateDateSelect(econSelect, baseDate, false, "econ-date");
}

function populateDateSelect(selectEl, baseDate, includeLatest, storageKey) {
    if (!selectEl || !baseDate || Number.isNaN(baseDate.getTime())) return;
    const saved = localStorage.getItem(storageKey) || "";
    const options = [];

    if (includeLatest) {
        options.push({ value: "", label: "Latest" });
    }

    for (let i = 0; i < 14; i += 1) {
        const d = new Date(baseDate);
        d.setDate(baseDate.getDate() - i);
        const value = formatDateValue(d);
        let label = value;
        if (i === 0) label = "Today";
        else if (i === 1) label = "Yesterday";
        else label = d.toLocaleDateString("en-US", { month: "short", day: "2-digit" });
        options.push({ value, label });
    }

    selectEl.innerHTML = options
        .map(opt => `<option value="${opt.value}">${opt.label}</option>`)
        .join("");

    if (saved && options.some(opt => opt.value === saved)) {
        selectEl.value = saved;
    } else if (!includeLatest) {
        selectEl.value = formatDateValue(baseDate);
    } else {
        selectEl.value = "";
    }
}

function formatDateValue(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
}

function initNewsFilters() {
    const impCbs = Array.from(document.querySelectorAll(".news-imp"));
    const saved = localStorage.getItem("news-imp") || "high,medium,low";
    const set = new Set(saved.split(",").map(s => s.trim()).filter(Boolean));
    newsImpactFilters = {
        high: set.has("high"),
        medium: set.has("medium"),
        low: set.has("low")
    };
    impCbs.forEach(cb => { cb.checked = set.has(cb.value); });

    impCbs.forEach(cb => {
        cb.addEventListener("change", () => {
            newsImpactFilters[cb.value] = cb.checked;
            const keys = Object.keys(newsImpactFilters).filter(k => newsImpactFilters[k]);
            localStorage.setItem("news-imp", keys.join(","));
            refreshYahoo();
        });
    });
}
function bindNewsAiButtons() {
    const listEl = document.getElementById("news-list");
    if (!listEl || listEl.dataset.aiBound) return;
    listEl.dataset.aiBound = "1";
    listEl.addEventListener("click", (e) => {
        const btn = e.target.closest(".news-ai-btn");
        if (!btn) return;
        const raw = btn.getAttribute("data-headline") || "";
        const text = raw ? decodeURIComponent(raw) : "";
        if (text) {
            openAiWithHeadline(text);
        }
    });
}
function openAiWithHeadline(text) {
    openAiHelper();
    setAiContext(text);
}
function initEconHotControls() {
    const hotCbs = Array.from(document.querySelectorAll(".ff-hot-min"));
    const beepCb = document.getElementById("ff-hot-beep");
    const saved = localStorage.getItem("ff-hot-levels") || "15,10,5";
    const set = new Set(saved.split(",").map(s => s.trim()).filter(Boolean));
    hotCbs.forEach(cb => { cb.checked = set.has(cb.value); });
    econHotLevels = hotCbs.filter(cb => cb.checked).map(cb => parseInt(cb.value, 10));

    const savedBeep = localStorage.getItem("ff-hot-beep");
    econHotBeep = savedBeep !== "0";
    if (beepCb) beepCb.checked = econHotBeep;

    hotCbs.forEach(cb => {
        cb.addEventListener("change", () => {
            econHotLevels = hotCbs.filter(x => x.checked).map(x => parseInt(x.value, 10));
            localStorage.setItem("ff-hot-levels", econHotLevels.join(","));
            refreshEcon();
        });
    });
    if (beepCb) {
        beepCb.addEventListener("change", () => {
            econHotBeep = beepCb.checked;
            localStorage.setItem("ff-hot-beep", econHotBeep ? "1" : "0");
        });
    }
}

/* INDEX QUOTES */
function initIndex() {
    fetchIndexQuotes();
    indexTimer = setInterval(fetchIndexQuotes, 60000);
}
function fetchIndexQuotes() {
    const url = YF_FEED_BASE + encodeURIComponent(INDEX_YAHOO_URL);
    fetch(url)
        .then(r => r.text())
        .then(txt => {
            let data = null;
            try {
                data = JSON.parse(txt);
            } catch (e) {
                console.warn("Index parse error:", e);
            }
            if (!data || !data.quoteResponse || !Array.isArray(data.quoteResponse.result)) {
                return;
            }
            const bySymbol = {};
            data.quoteResponse.result.forEach(q => { bySymbol[q.symbol] = q; });
            renderIndexQuote("SPY", "idx-spy", bySymbol["SPY"]);
            renderIndexQuote("QQQ", "idx-qqq", bySymbol["QQQ"]);
            renderIndexQuote("VIX", "idx-vix", bySymbol["^VIX"]);
        })
        .catch(err => {
            console.warn("Index fetch error:", err);
        });
}

function renderIndexQuote(symbol, elId, q) {
    const el = document.getElementById(elId);
    if (!el) return;
    el.classList.remove("up","down");
    if (!q || q.regularMarketPrice == null) {
        el.textContent = symbol + " --";
        return;
    }
    const price = Number(q.regularMarketPrice);
    const chgPct = Number(q.regularMarketChangePercent || 0);
    const pctStr = (chgPct >= 0 ? "+" : "") + chgPct.toFixed(2) + "%";
    el.textContent = `${symbol} ${price.toFixed(2)} (${pctStr})`;
    if (chgPct > 0.05) el.classList.add("up");
    else if (chgPct < -0.05) el.classList.add("down");
}

/* NOTES */
function initNotes() {
    const ta = document.getElementById("notes-area");
    const meta = document.getElementById("notes-meta");
    if (!ta) return;
    ta.value = localStorage.getItem("scratch-notes") || "";
    if (meta) meta.innerText = "Saved locally Â· " + (ta.value.length || 0) + " chars";
    ta.addEventListener("input", () => {
        localStorage.setItem("scratch-notes", ta.value);
        if (meta) meta.innerText = "Saved locally Â· " + (ta.value.length || 0) + " chars";
    });
}

/* AI CHAT */
let aiChatHistory = [];
let aiContextText = "";

function setAiStatus(msg) {
    const el = document.getElementById("ai-status");
    if (el) el.innerText = msg || "";
}
function loadAiKey() {
    const key = localStorage.getItem("groq-key") || "";
    const input = document.getElementById("ai-key");
    if (input) input.value = key;
}
function initAiChat() {
    const input = document.getElementById("ai-input");
    if (!input || input.dataset.bound) return;
    input.dataset.bound = "1";
    input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendAiMessage();
        }
    });
}
function setAiContext(text) {
    const next = (text || "").trim();
    const changed = next && next !== aiContextText;
    aiContextText = next;
    const el = document.getElementById("ai-context");
    if (el) el.textContent = aiContextText || "No headline attached";
    if (changed) resetAiChat();
}
function clearAiContext() {
    setAiContext("");
}
function resetAiChat() {
    aiChatHistory = [];
    const list = document.getElementById("ai-messages");
    if (list) {
        list.innerHTML = "";
        delete list.dataset.seeded;
    }
    ensureAiWelcome();
}
function ensureAiWelcome() {
    const list = document.getElementById("ai-messages");
    if (!list || list.dataset.seeded) return;
    list.dataset.seeded = "1";
    appendAiMessage("assistant", "Drop a headline or ask about impact, levels, and catalyst risk.", false);
}
function openAiHelper() {
    tog("ai-ov", 1);
    setAiStatus("");
    loadAiKey();
    ensureAiWelcome();
    const input = document.getElementById("ai-input");
    if (input) input.focus();
}
function saveAiKey() {
    const input = document.getElementById("ai-key");
    const key = input ? input.value.trim() : "";
    if (!key) {
        setAiStatus("Enter a Groq API key.");
        return;
    }
    localStorage.setItem("groq-key", key);
    setAiStatus("Key saved locally.");
}
function escapeHtml(s) {
    return String(s)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
}
function formatAiResponse(text) {
    const safe = escapeHtml(text);
    const lines = safe.split("\n");
    let out = "";
    lines.forEach(line => {
        if (line.trim().match(/^(bullish|bearish|catalyst|impact|expected|levels|risk)\b/i)) {
            out += '<span class="ai-pill">' + line.trim() + '</span>\n';
        } else if (line.match(/^\d+\./)) {
            out += "<strong>" + line + "</strong>\n";
        } else {
            out += line + "\n";
        }
    });
    return out.trim();
}
function appendAiMessage(role, text, asHtml) {
    const list = document.getElementById("ai-messages");
    if (!list) return;
    const row = document.createElement("div");
    row.className = "ai-msg " + (role || "assistant");
    const bubble = document.createElement("div");
    bubble.className = "ai-bubble";
    if (asHtml) bubble.innerHTML = text;
    else bubble.textContent = text;
    row.appendChild(bubble);
    list.appendChild(row);
    list.scrollTop = list.scrollHeight;
}
async function sendAiMessage() {
    const keyInput = document.getElementById("ai-key");
    const key = (keyInput && keyInput.value.trim()) || localStorage.getItem("groq-key") || "";
    const input = document.getElementById("ai-input");
    const message = (input && input.value.trim()) || "";

    if (!key) {
        setAiStatus("Add your Groq API key first.");
        return;
    }
    if (!message) {
        setAiStatus("Type a question or prompt.");
        return;
    }

    appendAiMessage("user", message, false);
    aiChatHistory.push({ role: "user", content: message });
    if (input) input.value = "";
    setAiStatus("Thinking...");

    const messages = [
        {
            role: "system",
            content: "You are a market news analyst. Be concise and practical. Mention what data levels would be bullish/bearish, expected market impact, and catalyst risk. Not financial advice."
        }
    ];
    if (aiContextText) {
        messages.push({ role: "system", content: "Context:\n" + aiContextText });
    }
    messages.push(...aiChatHistory);

    try {
        const resp = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + key
            },
            body: JSON.stringify({
                model: "llama-3.1-8b-instant",
                messages: messages,
                temperature: 0.4,
                max_tokens: 350
            })
        });

        if (!resp.ok) {
            const errText = await resp.text();
            let detail = errText;
            try {
                const parsed = JSON.parse(errText);
                detail = parsed && parsed.error && parsed.error.message ? parsed.error.message : errText;
            } catch (e) {
                // keep raw text
            }
            throw new Error("Request failed: " + resp.status + (detail ? " - " + detail : ""));
        }
        const data = await resp.json();
        const text = data && data.choices && data.choices[0] && data.choices[0].message
            ? data.choices[0].message.content
            : "No response received.";
        const safe = String(text || "").trim();
        aiChatHistory.push({ role: "assistant", content: safe });
        appendAiMessage("assistant", formatAiResponse(safe), true);
        setAiStatus("Done.");
    } catch (e) {
        appendAiMessage("assistant", "Error: " + e.message, false);
        setAiStatus("Request failed.");
    }
}

/* STATUS BAR */
function updateStatusBar() {
    const mEl = document.getElementById("status-market");
    const nEl = document.getElementById("status-news");
    const eEl = document.getElementById("status-econ");
    const aEl = document.getElementById("status-alert");
    if (mEl) mEl.innerText = "STATUS: " + statusMarket;
    if (nEl) nEl.innerText = "News: " + statusNews;
    if (eEl) eEl.innerText = "Econ: " + statusEcon;
    if (aEl) aEl.innerText = "Alert: " + statusAlert;
}

/* GLOBAL LOGGING */
window.addEventListener("error", (e) => {
    console.warn("Global JS error:", e.message);
});
window.addEventListener("unhandledrejection", (e) => {
    console.warn("Unhandled promise rejection:", e.reason);
});

/* KEYBOARD SHORTCUTS */
document.addEventListener("keydown", (e) => {
    const tag = (e.target && e.target.tagName) ? e.target.tagName.toUpperCase() : "";
    if (tag === "INPUT" || tag === "TEXTAREA") return;
    if (e.key === "s" || e.key === "S") {
        togSnd();
    } else if (e.key === "n" || e.key === "N") {
        refreshNews();
    } else if (e.key === "e" || e.key === "E") {
        refreshEcon();
    } else if (e.key === "a" || e.key === "A") {
        togAlarm10();
    }
});

/* START */
init();
</script>
</body>
</html>
