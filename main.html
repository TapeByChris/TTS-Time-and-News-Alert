<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Candlesticks Dashboard (Audio + Yahoo + FF Econ Calendar)</title>
<style>
    :root {
        --bg: #141617;
        --panel: #1E2124;
        --panel-2: #23272A;
        --panel-3: #2B3034;
        --input: #1C1F22;
        --border: #3B3F44;
        --border-subtle: #2E3337;
        --text: #E7EAEF;
        --text-muted: #A8AFB7;
        --muted: #8D949C;
        --green: #47E28D;
        --red: #FF5C5C;
        --amber: #E0B356;
        --alert: var(--red);
        --alert-bg: #3A2222;
        --alert-border: #8C3A3A;
        --alert-text: #F2D1D1;
        --focus: #5C6166;
        --ink: #101214;
        --card: #1E2124;
        --dim: var(--muted);
        --accent: #C9A24D;
        --gold: var(--amber);
        --cyan: #6E7A86;
        --line: var(--border);
        --overlay: var(--bg);
        --shadow-soft: 0 10px 28px rgba(0,0,0,0.38);
        --inner-outline: inset 0 0 0 1px rgba(0,0,0,0.55);
        --text-primary: #F3F5F7;
        --text-secondary: #C7CDD3;
        --text-muted-2: #9CA3AB;
        --text-disabled: #6F767D;
        --row-a: #1F2326;
        --row-b: #1A1D20;
        --header-bg: #1A1D20;
        --header-top: #24282C;
        --frame: #3B3F44;
        --frame-subtle: #2B2F33;
        --inset: #0B0D0E;
        --plate-1: #1F2326;
        --plate-2: #2A2F33;
        --group-strip: #22262A;
        --control-h: 24px;
        --radius-sm: 6px;
        --radius: 10px;
        --radius-lg: 14px;
        --mica: var(--panel);
        --mono: "Cascadia Mono", "Consolas", "SFMono-Regular", "Menlo", monospace;

        /* NEW: global widget scales */
        --timer-scale: 1;
        --yahoo-scale: 1;
        --econ-scale: 1;
        --watchlist-scale: 1;
        --rail-w: 56px;
    }

    html { font-size: 13px; }

    body {
        background:
            radial-gradient(1200px 800px at 80% -20%, rgba(255,255,255,0.02), transparent 60%),
            radial-gradient(900px 600px at -10% 120%, rgba(255,255,255,0.015), transparent 55%),
            var(--bg);
        color: var(--text);
        font-family: "Segoe UI Variable", "Segoe UI", "Cascadia Mono", "Consolas", sans-serif;
        line-height: 1.35;
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100vh;
        margin: 0;
        /* UPDATED: allow safety scrolling if user scales up */
        overflow: auto;
        transition: background 0.2s;
    }


    @keyframes fadeUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* TOP BAR */
    .top-bar {
        width: 100%;
        padding: 8px 14px;
        background: linear-gradient(180deg, var(--header-top), var(--header-bg));
        border-bottom: 1px solid var(--border-subtle);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        box-sizing: border-box;
        box-shadow: var(--inner-outline);
        animation: fadeUp 0.45s ease both;
    }
    .btn-group { display: flex; gap: 6px; }
    .cluster {
        display: flex;
        align-items: center;
        gap: 6px;
        padding-left: 8px;
        margin-left: 8px;
        border-left: 1px solid var(--border-subtle);
    }
    .time-block { line-height: 1.1; }
    .time-label {
        color: var(--muted);
        font-size: 0.6rem;
        letter-spacing: 0.06em;
        text-transform: uppercase;
    }
    .time-value {
        font-size: 1.2rem;
        font-weight: 600;
    }
    .header-btn {
        background: var(--panel-2);
        border: 1px solid var(--border-subtle);
        color: var(--text);
        padding: 4px 8px;
        cursor: pointer;
        font-weight: 600;
        border-radius: var(--radius-sm);
        font-size: 0.68rem;
        letter-spacing: 0.04em;
        text-transform: none;
    }
    .header-btn:hover { background: var(--panel-3); outline: 1px solid var(--focus); outline-offset: -1px; }
    .help-btn { border-color: var(--focus); color: var(--text); }
    .help-btn:hover { background: var(--focus); color: var(--ink); }

    /* AUDIO BUTTON */
    .audio-btn {
        border: 1px solid var(--red);
        color: var(--text);
        min-width: 78px;
        cursor: pointer;
        border-radius: var(--radius-sm);
        background: var(--panel-2);
        padding: 4px 8px;
        font-family: inherit;
        margin-right: 8px;
        text-transform: none;
        letter-spacing: 0.02em;
        font-size: 0.7rem;
    }
    .audio-btn.on {
        border-color: var(--green);
        color: var(--text);
        background: var(--panel-3);
    }

    /* ALARM BUTTON */
    .alarm-btn {
        border: 1px solid var(--border);
        color: var(--text);
        min-width: 100px;
        cursor: pointer;
        border-radius: var(--radius-sm);
        background: var(--panel-2);
        padding: 4px 8px;
        font-family: inherit;
        font-size: 0.7rem;
        text-transform: none;
        letter-spacing: 0.02em;
    }
    .alarm-btn.on {
        border-color: var(--green);
        color: var(--text);
        background: var(--panel-3);
    }

    /* STATUS BAR & SECTION BAR */
    .status-bar {
        width: 100%;
        box-sizing: border-box;
        padding: 6px 14px;
        font-size: 0.62rem;
        color: var(--text-muted);
        display: flex;
        justify-content: space-between;
        gap: 8px 14px;
        flex-wrap: wrap;
        background: var(--group-strip);
        border-bottom: 1px solid var(--border-subtle);
        box-shadow: var(--inner-outline);
        animation: fadeUp 0.5s ease both;
    }
    .status-bar span { white-space: nowrap; }
    #status-alert {
        max-width: 260px;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .status-strip {
        width: 100%;
        box-sizing: border-box;
        padding: 4px 14px;
        font-size: 0.58rem;
        color: var(--text-secondary);
        display: flex;
        justify-content: space-between;
        gap: 8px 12px;
        flex-wrap: wrap;
        background: linear-gradient(180deg, var(--header-top), var(--header-bg));
        border-bottom: 1px solid var(--border-subtle);
        text-transform: uppercase;
        letter-spacing: 0.08em;
    }
    .status-strip .strip-chip {
        color: var(--text-secondary);
    }
    .status-strip .strip-chip strong {
        color: var(--accent);
        font-weight: 600;
    }
    .auth-tabs {
        display: flex;
        gap: 6px;
        margin-bottom: 8px;
    }
    .auth-tab {
        flex: 1 1 auto;
        border: 1px solid var(--frame-subtle);
        background: var(--panel-3);
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 0.6rem;
        padding: 6px 8px;
        cursor: pointer;
    }
    .auth-tab.active {
        border-color: var(--accent);
        color: var(--text-primary);
        background: linear-gradient(180deg, rgba(201,162,77,0.25), rgba(201,162,77,0.08));
    }
    .auth-actions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
        justify-content: flex-end;
    }
    .terminal-footer {
        width: 100%;
        box-sizing: border-box;
        padding: 4px 10px;
        font-size: 0.58rem;
        color: var(--text-secondary);
        display: flex;
        justify-content: space-between;
        gap: 8px 12px;
        flex-wrap: wrap;
        background: linear-gradient(180deg, var(--header-bg), var(--header-top));
        border-top: 1px solid var(--border-subtle);
        text-transform: uppercase;
        letter-spacing: 0.08em;
    }
    body:not(.landscape-mode) .terminal-footer { margin-top: 6px; }
    .terminal-footer .footer-chip {
        color: var(--text-secondary);
    }
    .terminal-footer .footer-chip strong {
        color: var(--accent);
        font-weight: 600;
    }
    /* INDEX ROW */
    .index-row {
        width: 100%;
        box-sizing: border-box;
        padding: 6px 16px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
    }
    .index-chip {
        font-size: 0.65rem;
        padding: 4px 8px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        background: var(--panel-2);
        color: var(--text);
        min-width: 70px;
        text-align: center;
    }
    .index-chip.up { border-color: var(--green); color: var(--text); }
    .index-chip.down { border-color: var(--red); color: var(--text); }

    /* GRID (UPDATED: no forced 50vh crop, supports scaling) */
    .grid-wrapper {
        width: 100%;
        max-height: none;
        overflow: visible;
        display: flex;
        justify-content: center;
        padding: 10px 0 12px 0;
        box-sizing: border-box;
        zoom: var(--timer-scale, 1);
        animation: fadeUp 0.6s ease both;
    }
.grid-container {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    width: 98%;
    max-width: 1600px;
    align-items: stretch;
}

    /* CARD */
    .card {
        background: linear-gradient(180deg, rgba(40,40,40,0.98), rgba(32,32,32,0.98));
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 16px;
        text-align: left;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 7rem;
        transition: background 0.2s, border-color 0.2s, transform 0.2s;
        transform: scale(var(--card-scale, 1));
        transform-origin: center;
        will-change: transform;
        box-shadow: var(--shadow-soft), var(--inner-outline);
    }
    .card.alert {
        background: var(--panel) !important;
        border-color: var(--frame) !important;
        border-left: 3px solid var(--alert-border) !important;
        box-shadow: var(--inner-outline);
    }
    .alert .c-title, .alert label { color: var(--text) !important; }

    .c-title {
        color: var(--muted);
        font-size: 0.62rem;
        text-transform: uppercase;
        margin: 0;
        letter-spacing: 0.06em;
    }
    .c-title.muted { color: var(--text-disabled); }
    .c-role {
        font-size: 0.6rem;
        color: var(--muted);
        letter-spacing: 0.1em;
        text-transform: uppercase;
        margin: 0;
    }
    .c-time {
        font-size: 1.8rem;
        font-weight: 600;
        line-height: 1.1;
        font-family: 'IBM Plex Mono', monospace;
    }
    .c-ms { font-size: 0.9rem; color: var(--muted); }
    .c-sub {
        font-size: 0.65rem;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
    }

    /* INPUTS / ROWS */
    .row {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid var(--border);
        align-items: center;
        flex-wrap: wrap;
    }
    .panel-head {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 6px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 6px;
        margin-bottom: 8px;
    }
    .panel-title {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    .panel-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        padding: 4px 0;
    }
    .row-label {
        font-size: 0.7rem;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.06em;
        line-height: 1.1;
        white-space: nowrap;
    }
    .row-value {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        justify-content: flex-end;
        flex: 1 1 auto;
    }
    .row-value.stack {
        flex-direction: column;
        align-items: flex-end;
        gap: 2px;
    }
    .time-row .row-value { justify-content: flex-end; }
    input {
        background: var(--input);
        border: 1px solid var(--border);
        color: var(--text);
        padding: 4px 6px;
        border-radius: 4px;
        font-family: inherit;
        font-size: 0.7rem;
        text-align: right;
        width: 64px;
    }
    input[type="checkbox"] { accent-color: var(--focus); }
    input:focus {
        outline: 1px solid var(--focus);
        outline-offset: -1px;
    }
    .align-in {
        width: 60px !important;
        color: var(--accent) !important;
        font-weight: bold;
    }
    .rth { grid-column: span 2; }
    .rth-inputs {
        display: flex;
        gap: 15px;
        margin-bottom: 5px;
        justify-content: center;
    }
    .mute-label {
        font-size: 0.65rem;
        display: inline-flex;
        align-items: center;
        gap: 3px;
        color: var(--muted);
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .mute-label input { width: auto; }

    /* BUTTON BASE */
    button {
        cursor: pointer;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        background: var(--panel-2);
        color: var(--text);
        padding: 4px 8px;
        font-family: inherit;
        text-transform: none;
        letter-spacing: 0.02em;
        font-size: 0.7rem;
    }
    button:hover { background: rgba(0,120,212,0.16); border-color: rgba(0,120,212,0.6); }
    button:focus-visible { outline: 2px solid rgba(0,120,212,0.75); outline-offset: 2px; }

    /* OVERLAYS (UPDATED to match theme vars) */
    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--overlay);
        z-index: 1000;
        display: none;
        justify-content: center;
        align-items: center;
        pointer-events: all;
        transition: none;
        backdrop-filter: none;
    }
    .overlay.visible { display: flex; }
    .modal {
        background: var(--mica);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 18px;
        max-width: 820px;
        width: min(92vw, 820px);
        color: var(--text);
        box-shadow: var(--shadow-soft), var(--inner-outline);
    }
    .modal h2 {
        border-bottom: 1px solid var(--border);
        padding-bottom: 10px;
        margin-top: 0;
        color: var(--accent);
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-size: 1rem;
    }
    .modal h3, .modal h4 { color: var(--text); }
    .modal p, .modal li { color: var(--text-muted); line-height: 1.5; font-size: 0.9rem; }
    .close-btn {
        float: right;
        cursor: pointer;
        font-size: 1.6rem;
        color: var(--text-muted);
        line-height: 1;
    }
    .close-btn:hover { color: var(--text); }

    /* DESIGN STUDIO */
    .cf-grp { margin-bottom: 16px; }
    .cf-grp h4 {
        margin: 0 0 10px 0;
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.14em;
    }
    .cf-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 8px;
        border: 1px solid var(--border);
        background: var(--panel-2);
        border-radius: 4px;
        gap: 10px;
        margin-bottom: 6px;
        box-shadow: var(--inner-outline);
    }
    .cf-row span { color: var(--text); font-size: 0.7rem; }

    input[type="color"] {
        border: none;
        width: 40px;
        height: 30px;
        cursor: pointer;
        background: none;
        padding: 0;
    }
    input[type="range"] { width: 220px; cursor: pointer; }

    .rst-btn {
        width: 100%;
        background: var(--red);
        margin-top: 10px;
        padding: 12px;
        font-weight: bold;
        border: none;
    }
    .rst-btn:hover { background: var(--red); }

    .theme-select, .news-select {
        background: var(--input);
        border-radius: 4px;
        border: 1px solid var(--border);
        color: var(--text);
        padding: 3px 6px;
        font-size: 0.7rem;
        font-family: inherit;
    }
    .settings-tabs {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        margin: 6px 0 10px 0;
    }
    .tab-btn {
        background: var(--panel-2);
        border: 1px solid var(--border);
        color: var(--text);
        padding: 3px 6px;
        font-size: 0.6rem;
        border-radius: 4px;
        text-transform: uppercase;
        letter-spacing: 0.06em;
    }
    .tab-btn.active {
        border-color: var(--focus);
        color: var(--text);
        background: var(--panel-3);
    }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    .setting-group {
        border: 1px solid var(--border);
        background: var(--panel-2);
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 8px;
        box-shadow: var(--inner-outline);
    }
    .setting-title {
        font-size: 0.65rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--text);
        margin-bottom: 4px;
    }
    .setting-desc {
        font-size: 0.6rem;
        color: var(--muted);
        margin-bottom: 8px;
    }
    .setting-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 10px 0;
        border-top: 1px solid var(--border-subtle);
    }
    .setting-row:first-of-type { border-top: none; padding-top: 0; }
    .setting-label {
        font-size: 0.7rem;
        color: var(--text);
    }
    .scale-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
    }
    .scale-item {
        border: 1px solid var(--border);
        background: var(--panel-2);
        border-radius: 4px;
        padding: 8px;
        box-shadow: var(--inner-outline);
    }
    .scale-label {
        font-size: 0.6rem;
        color: var(--muted);
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
    }
    .chip-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 10px;
    }
    .chip-row button {
        font-size: 0.6rem;
        padding: 2px 6px;
        border-radius: 4px;
        border: 1px solid var(--border);
        background: var(--panel-2);
    }
    .tf-list {
        max-height: 260px;
        overflow-y: auto;
        font-size: 0.65rem;
    }
    .accordion-header {
        width: 100%;
        text-align: left;
        padding: 5px 6px;
        border-radius: 4px;
        border: 1px solid var(--border);
        background: var(--panel-2);
        color: var(--text);
        font-size: 0.6rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        cursor: pointer;
    }
    .accordion-body {
        display: none;
        padding-top: 10px;
    }
    .accordion.open .accordion-body { display: block; }
    .theme-preview {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin-top: 10px;
    }
    .theme-swatch {
        border-radius: 4px;
        min-height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.6rem;
        border: 1px solid var(--border);
    }
    .theme-swatch.bg { background: var(--bg); }
    .theme-swatch.card { background: var(--card); }
    .theme-swatch.accent { background: var(--accent); color: var(--ink); }
    .theme-swatch.text { background: var(--panel-2); color: var(--text); }

    .app-frame {
        width: 100vw;
        max-width: none;
        background: var(--panel);
        border: 1px solid var(--frame-subtle);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-soft);
        overflow: hidden;
        display: grid;
        grid-template-columns: 1fr;
        grid-template-rows: 1fr;
    }
    .shell-content {
        min-height: 0;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        width: 100%;
    }
    .view {
        display: none;
        min-height: 0;
        height: 100%;
        width: 100%;
    }
    .view.active {
        display: flex;
        flex-direction: column;
        min-height: 0;
        height: 100%;
    }
    #view-review iframe {
        width: 100%;
        height: 100%;
        border: 0;
        display: block;
        background: var(--bg);
    }
    .side-rail {
        width: var(--rail-w);
        background: var(--panel-2);
        border-right: 1px solid var(--frame-subtle);
        display: flex;
        flex-direction: column;
        gap: 6px;
        padding: 8px 6px;
        min-height: 0;
        position: sticky;
        top: 0;
        height: 100vh;
    }
    .rail-brand {
        display: grid;
        gap: 4px;
        padding: 4px 4px 2px 4px;
    }
    .rail-logo {
        height: 28px;
        border: 1px solid var(--frame-subtle);
        background: var(--panel-3);
        color: var(--accent);
        font-size: 0.6rem;
        letter-spacing: 0.18em;
        display: flex;
        align-items: center;
        justify-content: center;
        text-transform: uppercase;
    }
    .rail-sub {
        font-size: 0.5rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.12em;
        text-align: center;
    }
    .side-rail .rail-btn {
        height: 44px;
        border: 1px solid var(--frame-subtle);
        background: var(--panel-3);
        color: var(--text-secondary);
        display: grid;
        place-items: center;
        border-radius: 6px;
        cursor: pointer;
        width: 100%;
        position: relative;
    }
    .side-rail .rail-ico {
        width: 20px;
        height: 20px;
        fill: currentColor;
        color: var(--text-secondary);
        display: block;
    }
    .side-rail .rail-btn.active {
        border-color: var(--accent);
        background: var(--panel-2);
    }
    .side-rail .rail-btn.active .rail-ico {
        color: var(--accent);
    }
    .rail-user {
        margin-top: auto;
        display: grid;
        gap: 6px;
        padding: 6px 4px;
        border-top: 1px solid var(--frame-subtle);
    }
    .rail-user .user-name {
        font-size: 0.6rem;
        color: var(--text-primary);
        text-transform: uppercase;
        letter-spacing: 0.08em;
    }
    .rail-user .user-meta {
        font-size: 0.55rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.08em;
    }
    .rail-user .rail-btn {
        height: 34px;
    }
    .main-stack {
        display: flex;
        flex-direction: column;
        min-height: 0;
    }
    body.rail-hidden .app-frame { grid-template-columns: 0 1fr !important; }
    body.rail-hidden .side-rail { display: none !important; }
    body.rail-hidden .app-frame {
        grid-template-columns: 0 1fr;
    }
    body.rail-hidden .side-rail {
        display: none;
    }
    body.density-compact .news-wrapper { padding: 6px 8px 8px 8px; }
    body.density-compact .grid-container { gap: 6px; }
    body.density-compact .news-header { padding-bottom: 4px; }
    body.density-compact .watchlist-grid { gap: 6px; }

    /* NEWS AREA */
    .news-wrapper {
        width: 100%;
        box-sizing: border-box;
        padding: 8px 12px 10px 12px;
        overflow-y: auto;
        flex: 1 1 auto;
        border-top: 1px solid var(--border-subtle);
        background: var(--bg);
        animation: fadeUp 0.65s ease both;
    }
    body:not(.landscape-mode) .news-wrapper {
        flex: 0 0 auto;
    }
    body:not(.landscape-mode) .timers-panel {
        flex: 0 0 auto;
    }

    /* Landscape layout option (keeps portrait default unchanged) */
    body.landscape-mode .app-frame {
        max-width: none;
    }
    body.landscape-mode .main-stack {
        display: grid;
        grid-template-rows: auto auto auto minmax(0, 1fr) minmax(0, 1fr) auto;
        grid-template-columns: 1fr 1fr;
    }
    body.landscape-mode .top-bar,
    body.landscape-mode .status-strip,
    body.landscape-mode .status-bar {
        grid-column: 1 / -1;
    }
    body.landscape-mode .news-wrapper {
        grid-column: 2 / 3;
        grid-row: 4 / span 2;
        min-height: 0;
        border-top: none;
        border-left: 1px solid var(--border-subtle);
        display: flex;
        flex-direction: column;
    }
    body.landscape-mode .timers-panel {
        grid-column: 1 / 2;
        grid-row: 4;
        min-height: 0;
        height: 100%;
        display: flex;
        flex-direction: column;
        background: var(--panel-2);
    }
    body.landscape-mode .timers-panel .tos-panel-body {
        overflow: auto;
        flex: 1 1 auto;
    }
    body.landscape-mode .watchlist-panel {
        grid-column: 1 / 2;
        grid-row: 5;
        min-height: 0;
        align-self: stretch;
        overflow: hidden;
        height: 100%;
        display: flex;
        flex-direction: column;
        background: var(--panel-2);
    }
    body.landscape-mode .watchlist-panel .tos-panel-body {
        overflow: auto;
        flex: 1 1 auto;
    }
    body.landscape-mode .news-container.econ-panel,
    body.landscape-mode .news-container.news-panel {
        flex: 1 1 0;
        min-height: 0;
    }
    body.landscape-mode .terminal-footer {
        grid-column: 1 / -1;
        grid-row: 6;
    }

    @media (max-width: 1100px) {
        .watchlist-grid { grid-template-columns: 1fr; }
        .watchlist-row { grid-template-columns: 64px 1fr 80px 64px; }
        .watchlist-head { grid-template-columns: 64px 1fr 80px 64px; }
    }
.news-container {
    background: var(--mica);
    border: 1px solid var(--border-subtle);
    padding: 12px 14px;
    border-radius: var(--radius);
    max-width: 1400px;
    margin: 0 auto 8px auto;
    box-shadow: var(--shadow-soft), var(--inner-outline);
    overflow: visible;
    position: relative;
}
    /* NEW: scale each panel separately */
    .news-container[data-panel="yahoo"] { zoom: var(--yahoo-scale, 1); }
    .news-container[data-panel="econ"]  { zoom: var(--econ-scale, 1); }
    .news-container[data-panel="watchlist"] { zoom: var(--watchlist-scale, 1); }

.watchlist-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 8px;
    margin-top: 6px;
}
    .watchlist-col {
        border: 1px solid var(--border-subtle);
        background: var(--panel-2);
        border-radius: var(--radius-sm);
        padding: 10px;
        box-shadow: var(--inner-outline);
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-height: 140px;
    }
    .watchlist-col-title {
        font-size: 0.6rem;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }
    .watchlist-col-controls {
        display: flex;
        gap: 6px;
        align-items: center;
    }
    .watchlist-input {
        flex: 1 1 auto;
        width: 100%;
        text-align: left;
        font-size: 0.65rem;
        padding: 4px 6px;
        border-radius: 4px;
        background: var(--input);
        border: 1px solid var(--border);
        color: var(--text);
    }
    .watchlist-list {
        display: grid;
        gap: 6px;
        font-size: 0.7rem;
    }
    .watchlist-head {
        display: grid;
        grid-template-columns: 70px 1fr 90px 70px;
        gap: 6px;
        align-items: center;
        padding: 2px 6px 4px 6px;
        border-bottom: 1px solid var(--border-subtle);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 0.55rem;
        color: var(--muted);
    }
    .watchlist-head span { text-align: right; }
    .watchlist-head .watchlist-head-symbol { text-align: left; }
    .watchlist-head > * + * {
        border-left: 1px solid var(--border-subtle);
        padding-left: 6px;
    }
    .watchlist-row {
        display: grid;
        grid-template-columns: 70px 1fr 90px 70px;
        gap: 6px;
        align-items: center;
        padding: 4px 6px;
        border-radius: 4px;
        background: var(--panel-3);
        border: 1px solid var(--border-subtle);
        min-height: 24px;
    }
    .watchlist-row > * + * {
        border-left: 1px solid var(--border-subtle);
        padding-left: 6px;
    }
    .watchlist-row.pinned {
        border-color: rgba(225, 181, 106, 0.6);
        background: rgba(225, 181, 106, 0.12);
        box-shadow: inset 0 0 0 1px rgba(225, 181, 106, 0.35);
    }
    .watchlist-symbol {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-weight: 600;
        color: var(--text);
    }
    .watchlist-pin {
        width: 30px;
        height: 30px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        border: 1px solid var(--border-subtle);
        background: var(--panel-2);
        color: var(--text);
        font-size: 0.65rem;
        line-height: 1;
        cursor: pointer;
        user-select: none;
        padding: 0;
        opacity: 0.8;
    }
    .watchlist-pin:hover {
        opacity: 1;
        border-color: rgba(225, 181, 106, 0.6);
        background: rgba(225, 181, 106, 0.08);
    }
    .watchlist-pin svg {
        width: 24px;
        height: 24px;
        fill: currentColor;
        display: block;
    }
    .watchlist-pin.active {
        color: var(--ink);
        background: var(--gold);
        border-color: rgba(225, 181, 106, 0.8);
    }
    .watchlist-price {
        color: var(--text);
        text-align: right;
        font-family: var(--mono);
        font-variant-numeric: tabular-nums;
    }
    .watchlist-change {
        text-align: right;
        font-variant-numeric: tabular-nums;
        font-weight: 700;
        font-family: var(--mono);
    }
    .watchlist-change.up { color: var(--green); }
    .watchlist-change.down { color: var(--red); }
    .watchlist-row.up .watchlist-pct { color: var(--green); }
    .watchlist-row.down .watchlist-pct { color: var(--red); }
    .watchlist-pct {
        text-align: right;
        font-variant-numeric: tabular-nums;
        color: var(--text-muted);
        font-weight: 700;
        font-family: var(--mono);
    }
    .watchlist-empty {
        color: var(--text-muted);
        font-size: 0.65rem;
        padding: 6px;
    }

    .news-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        padding-bottom: 6px;
        padding-right: 40px;
        border-bottom: 1px solid var(--border-subtle);
        position: sticky;
        top: 0;
        z-index: 5;
        background: var(--header-bg);
        position: relative;
    }
.news-title {
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-secondary);
}
    .news-controls,
    .econ-controls {
        display: flex;
        gap: 4px;
        align-items: center;
        flex-wrap: wrap;
    }
    .news-controls .news-select,
    .econ-controls .news-select,
    .news-controls .news-refresh,
    .econ-controls .news-refresh,
    .news-controls .news-voice-btn {
        height: 24px;
        padding: 2px 8px;
        font-size: 0.6rem;
        border-radius: var(--radius-sm);
        display: inline-flex;
        align-items: center;
    }
    .news-voice-btn { border-color: var(--accent); }
    .news-voice-btn.off { border-color: var(--border); color: var(--text-muted); }
.refresh-state {
    font-size: 0.65rem;
    color: var(--muted);
    padding-left: 6px;
}
    .refresh-state.active { color: var(--focus); }

    .news-list {
        max-height: 34vh;
        overflow-y: auto;
        margin-top: 4px;
    }
    .news-list {
        scrollbar-width: thin;
        scrollbar-color: var(--border) var(--panel-2);
    }
    .news-list::-webkit-scrollbar { width: 10px; }
    .news-list::-webkit-scrollbar-track {
        background: var(--panel-2);
        border-radius: 999px;
    }
    .news-list::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 999px;
        border: 2px solid var(--panel-2);
    }
    .news-list::-webkit-scrollbar-thumb:hover {
        background: var(--border-subtle);
    }
    .news-item {
        padding: 4px 4px;
        border-bottom: 1px solid var(--border-subtle);
        font-size: 0.65rem;
        transition: background 0.15s;
    }
    .news-list .news-item:nth-child(odd) { background: var(--panel-2); }
    .news-item:last-child { border-bottom: none; }
    .news-item strong { color: var(--text); margin-right: 4px; }
    .news-item a { color: var(--text); text-decoration: none; }
    .news-item a:hover { text-decoration: underline; }
    .news-item:hover { background: var(--panel-2); }
    .news-time { color: var(--dim); font-size: 0.6rem; margin-right: 6px; font-weight: 600; }

    /* ECON CALENDAR */
    .ff-label { color: var(--text); font-weight: 600; margin-right: 4px; }
    .ff-time { font-size: 0.6rem; color: var(--dim); margin-right: 6px; font-weight: 600; }
    .ff-cur { font-size: 0.6rem; color: var(--text-muted); margin-right: 6px; }
    .ff-badge {
        display: inline-block;
        padding: 2px 7px;
        border-radius: 2px;
        font-size: 0.55rem;
        margin-right: 6px;
        font-weight: 600;
    }
    .ff-high { background: var(--red); color: var(--text); }
    .ff-medium { background: var(--panel); color: var(--text-primary); }
    .ff-low { background: var(--panel-2); color: var(--text); border: 1px solid var(--border); }
    .ff-main {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 6px;
        flex: 1 1 auto;
        min-width: 220px;
    }
    .news-item.ff-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
    }
    .ff-stats {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-left: auto;
        justify-content: flex-end;
        font-size: 0.72rem;
        color: var(--dim);
    }
    .ff-stat {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 6px;
        border-radius: 2px;
        border: 1px solid var(--border);
        background: var(--panel-2);
    }
    .ff-stat-label {
        font-size: 0.55rem;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: var(--text-muted);
    }
    .ff-stat-val { color: var(--text); font-weight: 600; }

    .ff-filter-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 5px;
        font-size: 0.6rem;
        color: var(--dim);
        align-items: center;
    }
    .ff-filter-row label {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        cursor: pointer;
    }
    .ff-filter-row input[type="checkbox"] { width: auto; }
    .econ-controls {
        color: var(--dim);
        margin-top: 0;
    }

    .news-item.ff-past { color: var(--text-muted-2); }
    .news-item.ff-soon {
        background: var(--panel-2) !important;
        border-radius: 2px;
        padding: 6px 8px;
        border: 1px solid var(--red);
    }
    .ff-next-banner {
        font-size: 0.65rem;
        color: var(--text);
        padding: 3px 0;
        border-bottom: 1px dashed var(--border-subtle);
        margin-top: 4px;
    }

    /* NOTES */
    .notes-area {
        width: 100%;
        min-height: 260px;
        max-height: 420px;
        resize: vertical;
        background: var(--input);
        border-radius: 2px;
        border: 1px solid var(--border);
        color: var(--text);
        padding: 4px 6px;
        font-family: inherit;
        font-size: 0.7rem;
        box-sizing: border-box;
    }
    .notes-meta {
        font-size: 0.7rem;
        color: var(--text-muted);
        margin-top: 4px;
        text-align: right;
    }

    @media (max-width: 1100px) {
        .grid-container { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 800px) {
        .grid-container { grid-template-columns: repeat(2, 1fr); }
    }

body {
    scrollbar-width: thin;
    scrollbar-color: var(--border) var(--panel-2);
}
body::-webkit-scrollbar { width: 12px; }
body::-webkit-scrollbar-track {
    background: var(--panel-2);
    border-radius: 999px;
}
body::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 999px;
    border: 2px solid var(--panel-2);
}
body::-webkit-scrollbar-thumb:hover {
    background: var(--border-subtle);
}


    .ops-card.span-2,
    .ops-card.span-3,
    .ops-card.span-4 { grid-column: span 1; }



    .news-item strong { color: var(--text); }
    .news-item.news-item-yahoo {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }
    .news-item.news-item-yahoo a { flex: 1 1 auto; min-width: 160px; }
    .news-impact {
        font-size: 0.55rem;
        padding: 1px 5px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        text-transform: uppercase;
        letter-spacing: 0.06em;
    }
    .news-impact.high { border-color: var(--red); }
    .news-impact.medium { border-color: var(--amber); }
    .news-impact.low { background: var(--panel-2); color: var(--text); border-color: var(--border); }
    .news-anl-btn {
        margin-left: auto;
        border: 1px solid var(--border);
        background: var(--panel-2);
        color: var(--text-secondary);
        width: 22px;
        height: 22px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 9px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
    }
    .news-item:hover .news-anl-btn { color: var(--text-primary); }
    .news-anl-btn:hover { background: var(--panel-3); color: var(--text-primary); }
    .news-filter-row,
    .ff-hot-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
        font-size: 0.6rem;
        color: var(--dim);
        margin-top: 4px;
    }
    .news-filter-row {
        border-top: 1px solid var(--border-subtle);
        padding-top: 4px;
        margin-top: 6px;
    }
    .news-filter-row label,
    .ff-hot-row label {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
    }
    .ff-hot {
        background: var(--panel-2) !important;
        border: 1px solid var(--red);
        border-radius: 2px;
    }

.ff-low { background: var(--panel-2); color: var(--text); border: 1px solid var(--border); }

</style>
<style>
    /* ===== ThinkorSwim (ToS) Detached Gadget Overrides ===== */
    :root {
        --bg: #141617;
        --panel: #1E2124;
        --panel-2: #23272A;
        --panel-3: #2B3034;
        --input: #1C1F22;
        --border: #3B3F44;
        --border-subtle: #2E3337;
        --text: #E7EAEF;
        --text-muted: #A8AFB7;
        --muted: #8D949C;
        --green: #47E28D;
        --red: #FF5C5C;
        --amber: #E0B356;
        --focus: #5C6166;
        --mica: #1E2124;
        --header-bg: #1A1D20;
        --header-top: #24282C;
        --row-a: #1F2326;
        --row-b: #1A1D20;
        --group-strip: #22262A;
        --frame: #3B3F44;
        --frame-subtle: #2B2F33;
        --rail-w: 56px;
        --mono: "Cascadia Mono", "Consolas", "SFMono-Regular", "Menlo", monospace;
        --shadow-soft: none;
        --inner-outline: none;
        --radius-sm: 0;
        --radius: 0;
        --radius-lg: 0;
    }

    html { font-size: 12px; }

    body {
        background: var(--bg) !important;
        font-family: "Segoe UI", Tahoma, Arial, sans-serif;
        line-height: 1.2;
        height: 100vh;
        width: 100vw;
        margin: 0;
        overflow: hidden;
        display: flex;
        align-items: stretch;
        justify-content: stretch;
    }

    * { border-radius: 0 !important; box-shadow: none !important; animation: none !important; transition: none !important; }
    body { transition: none !important; }

    .app-frame {
        width: 100%;
        height: 100%;
        background: var(--panel-2);
        border: 1px solid var(--frame-subtle);
        box-shadow: inset 0 0 0 1px rgba(0,0,0,0.4) !important;
        display: grid;
        grid-template-columns: 1fr;
        grid-template-rows: 1fr;
        overflow: hidden;
        min-height: 0;
    }
    .side-rail {
        width: var(--rail-w);
        background:
            linear-gradient(180deg, rgba(201,162,77,0.08), transparent 40%),
            var(--header-bg);
        border-right: 1px solid var(--frame-subtle);
        display: flex;
        flex-direction: column;
        gap: 6px;
        padding: 6px 4px;
        min-height: 0;
    }
    .rail-brand { display: grid; gap: 4px; padding: 4px 2px 6px 2px; border-bottom: 1px solid var(--frame-subtle); }
    .rail-logo {
        height: 26px;
        border: 1px solid var(--frame-subtle);
        background: linear-gradient(180deg, #2B3034, #1F2326);
        color: var(--amber);
        font-size: 9px;
        letter-spacing: 0.2em;
        display: flex;
        align-items: center;
        justify-content: center;
        text-transform: uppercase;
    }
    .rail-sub { font-size: 9px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.08em; text-align: center; }
    .side-rail .rail-btn {
        height: 34px;
        border: 1px solid var(--frame-subtle);
        background: linear-gradient(180deg, #2B3034, #23272A);
        color: var(--text-secondary);
        font-size: 9px;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
    }
    .side-rail .rail-btn.active {
        border-color: var(--amber);
        color: var(--text-primary);
        background: linear-gradient(180deg, rgba(224,179,86,0.3), rgba(224,179,86,0.12));
    }
    .rail-section { display: grid; gap: 4px; padding: 4px 2px; border-top: 1px solid var(--frame-subtle); }
    .rail-chip {
        display: grid;
        gap: 2px;
        padding: 4px 4px;
        border: 1px solid var(--frame-subtle);
        background: var(--panel-3);
        font-size: 9px;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: var(--text-secondary);
    }
    .rail-chip strong { color: var(--amber); font-weight: 600; }
    .rail-user { display: grid; gap: 4px; padding: 4px 2px; border-top: 1px solid var(--frame-subtle); margin-top: auto; }
    .rail-user .user-name { font-size: 9px; color: var(--text-primary); text-transform: uppercase; letter-spacing: 0.06em; }
    .rail-user .user-meta { font-size: 9px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em; }
    .rail-user .rail-btn { height: 28px; font-size: 9px; }
    .main-stack {
        display: flex;
        flex-direction: column;
        min-height: 0;
    }

    .top-bar,
    .status-bar,
    .status-strip,
    .terminal-footer {
        background: linear-gradient(180deg, var(--header-top), var(--header-bg)) !important;
        border-bottom: 1px solid var(--frame-subtle) !important;
        padding: 4px 8px !important;
        box-shadow: none !important;
        animation: none !important;
    }
    .terminal-footer {
        border-bottom: none !important;
        border-top: 1px solid var(--frame-subtle) !important;
    }

    .status-bar {
        font-size: 11px !important;
        color: var(--text-secondary) !important;
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 220px;
        align-items: center;
        column-gap: 8px;
        line-height: 1.1;
        background: var(--group-strip) !important;
    }
    #status-alert { text-align: right; width: 220px; }
    .time-label { font-size: 10px !important; letter-spacing: 0.06em !important; line-height: 1; }
    .time-value { font-size: 14px !important; font-weight: 700 !important; line-height: 1.1; }
    .cluster { padding-left: 6px !important; margin-left: 6px !important; border-left: 1px solid var(--frame) !important; }

    .tos-panel {
        border: none;
        box-shadow: none !important;
        background: transparent;
        display: flex;
        flex-direction: column;
        min-height: 0;
    }
    .tos-panel-header {
        background: linear-gradient(180deg, var(--header-top), var(--header-bg));
        border-bottom: 1px solid var(--frame-subtle) !important;
        padding: 3px 6px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 6px;
        box-shadow: none;
        position: relative;
    }
    .tos-panel-title {
        font-size: 11px;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        color: var(--text-secondary);
    }
    .tos-panel-title.active { color: var(--text-primary); }
    .tos-panel-tools {
        display: flex;
        align-items: center;
        gap: 6px;
        color: var(--text-secondary);
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
    }
    .tos-panel-body {
        padding: 2px 4px;
        min-height: 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        background: var(--panel-2);
        box-shadow: none !important;
    }
    body.landscape-mode .timers-panel,
    body.landscape-mode .watchlist-panel,
    body.landscape-mode .news-wrapper {
        height: 100%;
    }
    body.landscape-mode .timers-panel .tos-panel-body,
    body.landscape-mode .watchlist-panel .tos-panel-body,
    body.landscape-mode .news-container.econ-panel,
    body.landscape-mode .news-container.news-panel {
        flex: 1 1 0 !important;
        min-height: 0 !important;
    }

    .timers-panel { margin: 0 !important; }
    .timers-panel .tos-panel-body {
        background: var(--panel-2);
        box-shadow: inset 0 0 0 1px var(--inset) !important;
    }
    body.landscape-mode .timers-panel {
        height: 100% !important;
    }
    body.landscape-mode .timers-panel .tos-panel-body {
        flex: 1 1 auto !important;
    }
    .grid-wrapper { width: 100% !important; padding: 0 !important; }
    .grid-container { width: 100% !important; max-width: none !important; gap: 2px !important; }

    body.landscape-mode .main-stack {
        display: grid;
        grid-template-rows: auto auto auto minmax(0, 1fr) minmax(0, 1fr) auto;
        grid-template-columns: 1fr 1fr;
    }
    body.landscape-mode .top-bar,
    body.landscape-mode .status-strip,
    body.landscape-mode .status-bar {
        grid-column: 1 / -1;
    }
    body.landscape-mode .news-wrapper {
        grid-column: 2 / 3;
        grid-row: 4 / span 2;
        min-height: 0;
        border-top: none;
        border-left: 1px solid var(--frame-subtle);
        display: flex;
        flex-direction: column;
    }
    body.landscape-mode .timers-panel {
        grid-column: 1 / 2;
        grid-row: 4;
        min-height: 0;
        align-self: stretch;
        height: 100%;
    }
    body.landscape-mode .timers-panel .tos-panel-body {
        overflow: auto;
        flex: 1 1 auto;
    }
    body.landscape-mode .watchlist-panel {
        grid-column: 1 / 2;
        grid-row: 5;
        min-height: 0;
        align-self: stretch;
        overflow: hidden;
        height: 100%;
    }
    body.landscape-mode .watchlist-panel .tos-panel-body {
        overflow: auto;
        flex: 1 1 auto;
    }
    body.landscape-mode .news-container.econ-panel,
    body.landscape-mode .news-container.news-panel {
        flex: 1 1 0;
        min-height: 0;
    }
    body.landscape-mode .terminal-footer {
        grid-column: 1 / -1;
        grid-row: 6;
    }

    .card {
        background: var(--panel-2) !important;
        border: 1px solid var(--frame-subtle) !important;
        box-shadow: none !important;
        padding: 3px !important;
        min-height: 0 !important;
    }
    .timers-panel .card {
        border: 1px solid var(--frame-subtle) !important;
        box-shadow: none !important;
        background: var(--panel-2) !important;
    }
    .timers-panel .card:not(.alert) {
        border-left: 3px solid rgba(201,162,77,0.35) !important;
        background: linear-gradient(180deg, #272B2F, #22262A) !important;
    }
    .timers-panel .card:not(.alert) .c-title {
        color: var(--accent) !important;
    }
    .card.alert {
        background: var(--panel) !important;
        border-color: var(--frame) !important;
        border-left: 3px solid var(--alert-border) !important;
    }
    .card.alert .panel-head {
        background: var(--alert-bg) !important;
        color: var(--alert-text) !important;
    }
    .card.alert .c-title,
    .card.alert .c-role,
    .card.alert .c-sub,
    .card.alert .c-time,
    .card.alert label {
        color: var(--alert-text) !important;
    }
    .c-title, .c-role, .c-sub {
        font-size: 10px !important;
        letter-spacing: 0.08em !important;
        color: var(--text-secondary) !important;
    }
    .c-time { font-size: 16px !important; font-weight: 700 !important; font-family: "Segoe UI", Tahoma, Arial, sans-serif !important; color: var(--text-primary) !important; text-align: right; display: block; }
    .c-ms { font-size: 11px !important; color: var(--text-muted-2) !important; }

    .row { margin-top: 2px !important; padding-top: 2px !important; border-top: 1px solid var(--frame-subtle) !important; }
    .panel-head { border-bottom: 1px solid var(--frame-subtle) !important; padding-bottom: 2px !important; margin-bottom: 2px !important; }
    .panel-row { align-items: baseline !important; }
    .timers-panel .row {
        margin-top: 3px !important;
        padding-top: 3px !important;
        border-top: 1px solid var(--frame-subtle) !important;
    }
    .timers-panel .panel-head {
        border-bottom: 1px solid var(--frame-subtle) !important;
    }
    .row-value input,
    .row-value .align-in { height: var(--control-h) !important; }
    .row-value input { text-align: right !important; border: 1px solid var(--frame-subtle) !important; background: var(--panel-2) !important; }
    .timers-panel .row-value input {
        border: none !important;
        border-bottom: 1px solid var(--frame-subtle) !important;
        background: transparent !important;
    }

    .tos-button,
    button,
    .header-btn,
    .audio-btn,
    .alarm-btn,
    .news-refresh,
    .news-voice-btn,
    .news-anl-btn {
        background: var(--panel-3) !important;
        border: 1px solid var(--frame-subtle) !important;
        color: var(--text-muted) !important;
        padding: 0 6px !important;
        font-size: 10px !important;
        text-transform: uppercase !important;
        letter-spacing: 0.06em !important;
        min-width: auto !important;
        height: var(--control-h) !important;
        line-height: var(--control-h) !important;
    }
    button:hover,
    .header-btn:hover,
    .audio-btn:hover,
    .alarm-btn:hover,
    .news-refresh:hover,
    .news-voice-btn:hover,
    .news-anl-btn:hover {
        background: var(--panel) !important;
        border-color: var(--frame-subtle) !important;
        color: var(--text-secondary) !important;
        outline: none !important;
    }
    .audio-btn.on,
    #alarm10-btn.on {
        background: #1E9A4D !important;
        border-color: #1A8442 !important;
        color: #FFFFFF !important;
    }
    .alarm-btn.on,
    .news-voice-btn.on,
    #analysis-toggle.on {
        background: #003B5A !important;
        border-color: #003B5A !important;
        color: var(--text-primary) !important;
    }
    button:focus-visible { outline: 1px solid var(--focus) !important; outline-offset: -1px !important; }

    .tos-input,
    input,
    select,
    textarea {
        background: var(--panel-2) !important;
        border: 1px solid var(--frame) !important;
        color: var(--text-primary) !important;
        padding: 0 5px !important;
        font-size: 10px !important;
        height: var(--control-h) !important;
        line-height: var(--control-h) !important;
    }
    input:focus,
    select:focus,
    textarea:focus { outline: 1px solid var(--focus) !important; outline-offset: -1px !important; }

    .tos-checkbox,
    input[type="checkbox"] {
        appearance: none !important;
        width: 12px !important;
        height: 12px !important;
        border: 1px solid var(--frame) !important;
        background: var(--bg) !important;
        margin: 0 !important;
    }
    input[type="checkbox"]:checked {
        background: #5C5C5C !important;
        border-color: #7A7A7A !important;
    }
    input[type="checkbox"]:checked::after {
        content: "" !important;
        display: block !important;
        width: 6px !important;
        height: 6px !important;
        margin: 2px !important;
        background: #F0F0F0 !important;
    }
    .mute-label input[type="checkbox"]:checked {
        background: #7A2E2E !important;
        border-color: #7A2E2E !important;
    }
    .mute-label input[type="checkbox"]:checked::after {
        background: #F5D0D0 !important;
    }

    .news-wrapper {
        padding: 0 !important;
        overflow: auto !important;
        display: flex !important;
        flex-direction: column !important;
        gap: 0 !important;
        flex: 1 1 auto !important;
        min-height: 0 !important;
        border-top: 1px solid var(--frame-subtle) !important;
        background: var(--panel) !important;
    }
    body.landscape-mode .news-wrapper {
        border-top: none !important;
        border-left: 1px solid var(--frame-subtle) !important;
    }
    .news-container.econ-panel,
    .news-container.news-panel,
    .news-container.watchlist-panel {
        flex: 0 0 auto !important;
        min-height: 0 !important;
        max-height: none !important;
    }
    body.landscape-mode .news-container.econ-panel,
    body.landscape-mode .news-container.news-panel {
        flex: 1 1 0 !important;
        min-height: 0 !important;
    }
    .news-container {
        margin: 0 !important;
        padding: 0 !important;
        background: var(--panel-2) !important;
        border: none !important;
        border-top: 1px solid var(--frame-subtle) !important;
        box-shadow: none !important;
        overflow: hidden !important;
        display: flex !important;
        flex-direction: column !important;
        min-height: 0 !important;
        width: 100% !important;
        max-width: none !important;
    }
    .news-header {
        padding: 4px 8px !important;
        border-bottom: 1px solid var(--frame-subtle) !important;
        background: var(--header-bg) !important;
        box-shadow: none !important;
        position: static !important;
    }
    .news-title {
        font-size: 12px !important;
        text-transform: uppercase !important;
        letter-spacing: 0.06em !important;
        color: var(--text-secondary) !important;
    }
    .news-controls,
    .econ-controls { gap: 6px !important; }

    .news-filter-row,
    .ff-filter-row,
    .ff-hot-row {
        padding: 2px 6px !important;
        border-bottom: 1px solid var(--frame-subtle) !important;
        margin-top: 0 !important;
        font-size: 11px !important;
        background: linear-gradient(180deg, #2B3034, #23272A) !important;
    }
    .ff-filter-row span,
    .ff-filter-row label {
        color: var(--text-secondary) !important;
    }
    .news-item.ff-item .ff-time { color: var(--text-primary) !important; }
    .ff-next-banner {
        padding: 2px 6px !important;
        border-bottom: 1px solid var(--frame-subtle) !important;
        background: var(--panel-3) !important;
        font-size: 11px !important;
    }

    .news-list {
        flex: 1 1 auto !important;
        min-height: 0 !important;
        overflow: auto !important;
        padding: 0 !important;
        max-height: none !important;
    }

    .tos-row,
    .news-item {
        padding: 2px 6px !important;
        border-bottom: 1px solid var(--frame-subtle) !important;
        font-size: 11px !important;
        display: flex !important;
        align-items: center !important;
        gap: 6px !important;
        color: var(--text-primary) !important;
        background: var(--panel-2) !important;
        min-height: 22px !important;
    }
    .news-item a { color: var(--text-primary) !important; }
    .news-time { color: var(--text-primary) !important; }
    .news-time,
    .news-item.news-item-yahoo strong,
    .ff-stat-val,
    .row-value,
    .c-time,
    .c-ms {
        font-family: var(--mono) !important;
        font-variant-numeric: tabular-nums !important;
    }
    .ff-cur,
    .ff-stat-label,
    .row-label { color: var(--text-secondary) !important; font-size: 11px !important; }
    .ff-label,
    .ff-stat-val,
    .row-value { color: var(--text-primary) !important; }
    .news-item.ff-past { color: var(--text-muted-2) !important; }
    .news-item.news-item-yahoo {
        display: grid !important;
        align-items: center !important;
        gap: 0 !important;
    }
    .news-item.news-item-yahoo.has-anl { grid-template-columns: 56px 64px 120px 1fr 22px; }
    .news-item.news-item-yahoo.no-anl { grid-template-columns: 56px 64px 120px 1fr; }
    .news-item.news-item-yahoo > * { padding: 0 6px; }
    .news-item.news-item-yahoo > *:first-child { padding-left: 0; border-left: none; }
    .news-item.news-item-yahoo > * + * { border-left: 1px solid var(--frame-subtle); }
    .news-item.news-item-yahoo a { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .news-item.news-item-yahoo .news-time { justify-self: start; }
    .news-item.news-item-yahoo .news-impact { justify-self: start; }
    .news-item.news-item-yahoo strong { justify-self: start; }
    .news-item.news-item-yahoo a { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .news-item.news-item-yahoo .news-anl-btn { justify-self: end; }

    .news-item.ff-item {
        display: grid !important;
        grid-template-columns: 60px 52px 64px 1fr 56px 56px 56px 56px;
        align-items: center !important;
        gap: 0 !important;
    }
    .news-item.ff-item .ff-cell { padding: 0 6px; }
    .news-item.ff-item .ff-cell + .ff-cell { border-left: 1px solid var(--frame-subtle); }
    .news-item.ff-item .ff-cell { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .news-item.ff-item .ff-cell:nth-child(5),
    .news-item.ff-item .ff-cell:nth-child(6),
    .news-item.ff-item .ff-cell:nth-child(7),
    .news-item.ff-item .ff-cell:nth-child(8) { text-align: right; }
    .news-item.ff-item .ff-label { text-align: left; }
    .news-item.ff-item.ff-empty { color: var(--text-muted-2) !important; }
    .news-list .news-item.news-item-yahoo { background: var(--row-a) !important; }
    .news-list .news-item.news-item-yahoo:nth-child(odd) { background: var(--row-b) !important; }
    .news-item.news-item-yahoo:hover { background: var(--panel-3) !important; }
    .news-item:hover { background: var(--panel-2) !important; }
    .news-item a:hover { text-decoration: none !important; }
    .news-item:hover .news-anl-btn,
    .news-anl-btn:hover {
        background: var(--panel-2) !important;
        color: var(--text-primary) !important;
    }
    .refresh-state { font-size: 11px !important; }

    .watchlist-panel .watchlist-grid { gap: 6px !important; margin-top: 4px !important; }
    .watchlist-panel .watchlist-col { padding: 6px !important; }
    .watchlist-panel .watchlist-col-title { font-size: 11px !important; letter-spacing: 0.06em !important; }
    .watchlist-panel .watchlist-input { font-size: 11px !important; height: var(--control-h) !important; }
    .watchlist-panel .watchlist-list { font-size: 11px !important; }
    .watchlist-panel .watchlist-head {
        font-size: 10px !important;
        letter-spacing: 0.06em !important;
        color: var(--text-secondary) !important;
        padding: 2px 6px 4px 6px !important;
        border-bottom: 1px solid var(--frame-subtle) !important;
    }
    .watchlist-panel .watchlist-row {
        padding: 2px 6px !important;
        grid-template-columns: 62px 1fr 70px 70px !important;
        min-height: 22px !important;
    }
    .watchlist-panel .watchlist-price,
    .watchlist-panel .watchlist-change,
    .watchlist-panel .watchlist-pct { font-variant-numeric: tabular-nums; }
    .watchlist-panel .watchlist-change { font-weight: 700; }
    .watchlist-panel .watchlist-pct { font-weight: 700; }
    .watchlist-anchor { display: none; }

    .news-impact,
    .ff-badge {
        padding: 1px 4px !important;
        border: 1px solid var(--frame) !important;
        text-transform: uppercase !important;
        letter-spacing: 0.06em !important;
        font-size: 10px !important;
        color: var(--text-primary) !important;
    }
    .news-impact.high,
    .ff-high { border-color: var(--red) !important; }
    .news-impact.high {
        background: var(--red) !important;
        color: var(--text) !important;
    }
    .news-impact.medium,
    .ff-medium { border-color: var(--amber) !important; }
    .news-impact.low,
    .ff-low { border-color: var(--frame) !important; }

    .news-list.analysis-off .news-anl-btn { display: none !important; }

    .analysis-row {
        background: var(--panel) !important;
        border-top: 1px solid var(--frame) !important;
        border-bottom: 1px solid var(--frame) !important;
        padding: 2px 6px !important;
        font-size: 11px !important;
        display: block !important;
    }
    .analysis-grid {
        display: grid !important;
        grid-template-columns: 140px 1fr;
        gap: 4px 8px !important;
        align-items: start !important;
    }
    .analysis-label {
        color: var(--text-secondary) !important;
        text-transform: uppercase !important;
        letter-spacing: 0.06em !important;
        font-size: 10px !important;
    }
    .analysis-chip {
        display: inline-flex !important;
        align-items: center !important;
        padding: 1px 4px !important;
        border: 1px solid var(--frame) !important;
        background: var(--panel) !important;
        font-size: 10px !important;
        text-transform: uppercase !important;
        letter-spacing: 0.06em !important;
    }
    .analysis-chip.high { border-color: var(--red) !important; color: var(--text-primary) !important; background: var(--panel) !important; }
    .analysis-chip.medium { border-color: var(--amber) !important; color: var(--text-primary) !important; background: var(--panel) !important; }
    .analysis-chip.low { border-color: var(--frame) !important; color: var(--text-secondary) !important; background: var(--panel) !important; }
    .analysis-row .analysis-line { color: var(--text-primary) !important; }
    .analysis-row .analysis-muted { color: var(--text-muted-2) !important; }
    .analysis-controls {
        display: flex !important;
        align-items: center !important;
        gap: 6px !important;
        flex-wrap: wrap !important;
    }
    .analysis-refine {
        background: var(--panel) !important;
        border: 1px solid var(--frame) !important;
        color: var(--text-secondary) !important;
        font-size: 9px !important;
        padding: 1px 4px !important;
        height: 18px !important;
        text-transform: uppercase !important;
        letter-spacing: 0.06em !important;
    }

    .ff-stat {
        border: 1px solid var(--frame) !important;
        background: var(--panel) !important;
        padding: 2px 5px !important;
    }
    .ff-stat-label { font-size: 10px !important; }

    .overlay { background: var(--bg) !important; transition: none !important; backdrop-filter: none !important; }
    .modal {
        background: var(--panel) !important;
        border: 1px solid var(--border) !important;
        padding: 8px !important;
    }
    .setting-group,
    .cf-row,
    .scale-item,
    .theme-swatch,
    .analysis-row,
    .analysis-chip,
    .analysis-refine { border-radius: 0 !important; }

    body::-webkit-scrollbar,
    .news-list::-webkit-scrollbar { width: 8px !important; }
    body::-webkit-scrollbar-track,
    .news-list::-webkit-scrollbar-track { background: var(--bg) !important; }
    body::-webkit-scrollbar-thumb,
    .news-list::-webkit-scrollbar-thumb {
        background: var(--border) !important;
        border: 0 !important;
    }
</style>
</head>
<body>

<!-- SETTINGS OVERLAY -->
<div id="set-ov" class="overlay" onclick="tog('set-ov',0)">
  <div class="modal" onclick="event.stopPropagation()">
    <span class="close-btn" onclick="tog('set-ov',0)">&times;</span>
    <h2>Settings</h2>

    <div class="settings-tabs">
        <button class="tab-btn active" data-tab="set-theme">Theme</button>
        <button class="tab-btn" data-tab="set-layout">Layout</button>
        <button class="tab-btn" data-tab="set-data">Data</button>
        <button class="tab-btn" data-tab="set-advanced">Advanced</button>
    </div>

    <div id="set-theme" class="tab-panel active">
        <div class="setting-group">
            <div class="setting-title">Theme Presets</div>
            <div class="setting-desc">Pick a base look for the dashboard.</div>
            <div class="setting-row">
                <label class="setting-label">Theme</label>
                <select id="theme-select" class="theme-select">
                    <option value="bloomberg">Bloomberg Black</option>
                    <option value="nightops">Night Ops Blue</option>
                    <option value="minimal">Minimal Grey</option>
                    <option value="terminal">Terminal Green</option>
                </select>
            </div>
            <div class="theme-preview">
                <div class="theme-swatch bg"></div>
                <div class="theme-swatch card"></div>
                <div class="theme-swatch accent"></div>
                <div class="theme-swatch text">Aa</div>
            </div>
        </div>

        <div class="setting-group accordion">
            <button class="accordion-header" data-acc="acc-colors">Custom Colors</button>
            <div id="acc-colors" class="accordion-body">
                <div class="setting-row">
                    <label class="setting-label">Main Background</label>
                    <input type="color" id="p-bg" oninput="upTh('--bg',this.value)">
                </div>
                <div class="setting-row">
                    <label class="setting-label">Card Background</label>
                    <input type="color" id="p-cd" oninput="upTh('--card',this.value)">
                </div>
                <div class="setting-row">
                    <label class="setting-label">Text Color</label>
                    <input type="color" id="p-tx" oninput="upTh('--text',this.value)">
                </div>
                <div class="setting-row">
                    <label class="setting-label">Alert Background</label>
                    <input type="color" id="p-al" oninput="upTh('--alert',this.value)">
                </div>
            </div>
        </div>
    </div>

    <div id="set-layout" class="tab-panel">
        <div class="setting-group">
            <div class="setting-title">Global Scale</div>
            <div class="setting-desc">Adjust overall text size and widget sizing.</div>
            <div class="setting-row">
                <label class="setting-label">Text Size</label>
                <input type="range" min="12" max="24" value="16" oninput="upTh('size',this.value)">
            </div>
            <div class="setting-row">
                <label class="setting-label">Widget Zoom (My Browser Zoom)</label>
                <select id="widget-zoom" class="news-select">
                    <option value="100">100%</option>
                    <option value="110">110%</option>
                    <option value="115">115%</option>
                    <option value="120">120%</option>
                    <option value="125">125%</option>
                    <option value="130">130%</option>
                    <option value="135">135%</option>
                    <option value="140">140%</option>
                </select>
            </div>
            <div class="scale-grid">
                <div class="scale-item">
                    <div class="scale-label">Timers</div>
                    <input id="timer-scale" type="range" min="0.85" max="1.35" step="0.01"
                           oninput="setScale('--timer-scale', this.value, 'timer-scale')">
                </div>
                <div class="scale-item">
                    <div class="scale-label">Yahoo Panel</div>
                    <input id="yahoo-scale" type="range" min="0.85" max="1.25" step="0.01"
                           oninput="setScale('--yahoo-scale', this.value, 'yahoo-scale')">
                </div>
                <div class="scale-item">
                    <div class="scale-label">Econ Panel</div>
                    <input id="econ-scale" type="range" min="0.85" max="1.25" step="0.01"
                           oninput="setScale('--econ-scale', this.value, 'econ-scale')">
                </div>
                <div class="scale-item">
                    <div class="scale-label">Watchlist Panel</div>
                    <input id="watchlist-scale" type="range" min="0.85" max="1.25" step="0.01"
                           oninput="setScale('--watchlist-scale', this.value, 'watchlist-scale')">
                </div>
            </div>
        </div>

        <div class="setting-group">
            <div class="setting-title">Terminal Layout</div>
            <div class="setting-desc">Control density.</div>
            <div class="setting-row">
                <label class="setting-label">Density</label>
                <select id="density-mode" class="news-select">
                    <option value="comfortable">Comfortable</option>
                    <option value="compact">Compact</option>
                </select>
            </div>
        </div>

        <div class="setting-group">
            <div class="setting-title">Orientation</div>
            <div class="setting-desc">Switch layout between portrait and landscape.</div>
            <div class="setting-row">
                <label class="setting-label">Layout</label>
                <select id="layout-orientation" class="news-select">
                    <option value="portrait">Portrait</option>
                    <option value="landscape">Landscape</option>
                </select>
            </div>
        </div>

        <div class="setting-group">
            <div class="setting-title">Visible Timeframes</div>
            <div class="setting-desc">Hide or show timeframe cards and use quick presets.</div>
            <div class="chip-row">
                <button onclick="applyLayoutPreset('scalp')">Scalping</button>
                <button onclick="applyLayoutPreset('swing')">Swing</button>
                <button onclick="applyLayoutPreset('all')">All</button>
            </div>
            <div id="tf-list" class="tf-list"></div>
        </div>
    </div>

    <div id="set-data" class="tab-panel">
        <div class="setting-group">
            <div class="setting-title">News & Calendar</div>
            <div class="setting-desc">Control auto-refresh behavior.</div>
            <div class="setting-row">
                <label class="setting-label">Yahoo Auto Refresh</label>
                <select id="news-refresh-select" class="news-select">
                    <option value="0">Off (Manual)</option>
                    <option value="60000">Every 1 min</option>
                    <option value="300000">Every 5 min</option>
                    <option value="900000">Every 15 min</option>
                </select>
            </div>
            <div class="setting-row">
                <label class="setting-label">Econ Auto Refresh</label>
                <select id="econ-refresh-select" class="news-select">
                    <option value="0">Off (Manual)</option>
                    <option value="900000">Every 15 min</option>
                    <option value="3600000">Every 60 min</option>
                </select>
            </div>
        </div>
    </div>

    <div id="set-advanced" class="tab-panel">
        <div class="setting-group">
            <div class="setting-title">Reset</div>
            <div class="setting-desc">Restore all settings to defaults.</div>
            <button class="rst-btn" onclick="resetTh()">RESET TO DEFAULTS</button>
        </div>
    </div>
  </div>
</div>

<!-- HELP OVERLAY -->
<div id="hlp-ov" class="overlay" onclick="tog('hlp-ov',0)">
  <div class="modal" onclick="event.stopPropagation()">
    <span class="close-btn" onclick="tog('hlp-ov',0)">&times;</span>
    <h2>Dashboard Help</h2>
    <h3>1. Timers</h3>
    <p>Each card is a candle timeframe. The timer shows how much time is left before the current candle closes.</p>
    <p><strong>ALERT AT</strong> is the number of seconds (or HH:MM:SS) before close where the card turns red and (if not muted) the system speaks an alert.</p>
    <h3>2. Mute & Visibility</h3>
    <p>Use the <strong>MUTE</strong> checkbox on each card to silence audio alerts per timeframe. Grey titles indicate muted timers.</p>
    <p>In <strong>SETTINGS  Visible Timeframes</strong> you can hide/show each timeframe card entirely, or use the presets (Scalping / Swing / All). Each timeframe also has a size slider.</p>
    <h3>3. RTH Session & Alarm</h3>
    <p>The RTH card counts down until market open, then until close. It will speak when the alert threshold is hit. The 10 AM alarm button plays a short beep at 9:59 AM ET once per day (no TTS).</p>
    <h3>4. News & Economic Calendar</h3>
    <p>Yahoo has its own date and refresh (manual or auto). Economic calendar uses the Forex Factory JSON via your local Node server.</p>
    <p>Impact colors: <span class="ff-badge ff-high">High</span> <span class="ff-badge ff-medium">Medium</span> <span class="ff-badge ff-low">Low</span>.</p>
    <p>Hot Alerts highlight econ events inside 5/10/15 minutes and can beep when enabled.</p>
    <h3>5. Shortcuts</h3>
    <ul>
        <li><strong>S</strong>  Toggle sound</li>
        <li><strong>N</strong>  Refresh Yahoo news</li>
        <li><strong>E</strong>  Refresh economic calendar</li>
        <li><strong>A</strong>  Toggle 10 AM alarm</li>
    </ul>
  </div>
</div>

<!-- NOTES OVERLAY -->
<div id="notes-ov" class="overlay" onclick="tog('notes-ov',0)">
  <div class="modal" onclick="event.stopPropagation()">
    <span class="close-btn" onclick="tog('notes-ov',0)">&times;</span>
    <h2>Today's Notes</h2>
    <textarea id="notes-area" class="notes-area" placeholder="Trade plans, levels, mindset reminders..."></textarea>
    <div id="notes-meta" class="notes-meta">Saved locally</div>
  </div>
</div>

<div class="app-frame">
    <div class="shell-content">
        <div class="main-stack">
<!-- TOP BAR -->
<div class="top-bar">
    <div class="time-block">
        <span class="time-label">NY TIME (ET)</span><br>
        <span id="ny" class="time-value">--:--</span>
    </div>
    <div class="cluster">
        <button id="snd-btn" class="audio-btn tos-button" onclick="togSnd()">SOUND: OFF</button>
        <button id="alarm10-btn" class="alarm-btn tos-button" onclick="togAlarm10()">10 AM ALARM: ON</button>
    </div>
    <div class="btn-group cluster">
        <button class="header-btn tos-button" onclick="tog('set-ov',1)">SETTINGS</button>
        <button class="header-btn tos-button" onclick="tog('notes-ov',1)">NOTES</button>
        <button class="header-btn help-btn tos-button" onclick="tog('hlp-ov',1)">HELP</button>
    </div>
</div>

<div class="status-strip">
    <span class="strip-chip">Connection: <strong>Local</strong></span>
    <span class="strip-chip">News Refresh: <strong>Manual</strong></span>
    <span class="strip-chip">Econ Refresh: <strong>Manual</strong></span>
    <span class="strip-chip">Watchlist: <strong>5m</strong></span>
</div>

<!-- STATUS BAR -->
<div class="status-bar">
    <span id="status-market">STATUS: --</span>
    <span id="status-news">News: Manual</span>
    <span id="status-econ">Econ: Manual</span>
    <span id="status-alert">Alert: --</span>
</div>

<!-- SECTION BAR -->
<!-- TIMERS GRID -->
<div class="tos-panel timers-panel">
    <div class="tos-panel-header">
        <div class="tos-panel-title active">TIMERS</div>
        <div class="tos-panel-tools">MUTE PER CARD</div>
    </div>
    <div class="tos-panel-body">
        <div class="grid-wrapper">
            <div class="grid-container" id="grid"></div>
        </div>
    </div>
</div>


<!-- NEWS AREA (YAHOO + ECON CALENDAR) -->
<div class="news-wrapper">
    <!-- Economic Calendar (Forex Factory via backend) -->
    <div class="news-container tos-panel econ-panel" data-panel="econ">
        <div class="news-header tos-panel-header">
            <div class="news-title tos-panel-title active">ECONOMIC CALENDAR</div>
            <div class="econ-controls tos-panel-tools">
                <span>ECON DATE:</span>
                <select id="econ-date" class="news-select tos-input"></select>
                <button class="news-refresh tos-button" onclick="refreshEcon()">REFRESH CALENDAR</button>
            </div>
        </div>
        <div class="tos-panel-body">
            <div class="ff-filter-row">
                <span>Currencies:</span>
                <label><input type="checkbox" class="ff-country" value="USD" checked> USD</label>
                <label><input type="checkbox" class="ff-country" value="EUR" checked> EUR</label>
                <label><input type="checkbox" class="ff-country" value="GBP" checked> GBP</label>
                <label><input type="checkbox" class="ff-country" value="JPY" checked> JPY</label>
                <label><input type="checkbox" class="ff-country" value="CAD"> CAD</label>
                <label><input type="checkbox" class="ff-country" value="AUD"> AUD</label>
                <label><input type="checkbox" class="ff-country" value="NZD"> NZD</label>
                <label><input type="checkbox" class="ff-country" value="CHF"> CHF</label>
                <label><input type="checkbox" class="ff-country" value="CNY"> CNY</label>
                <span>Impact:</span>
                <label><input type="checkbox" class="ff-imp" value="high" checked> <span class="ff-badge ff-high">High</span></label>
                <label><input type="checkbox" class="ff-imp" value="medium" checked> <span class="ff-badge ff-medium">Medium</span></label>
                <label><input type="checkbox" class="ff-imp" value="low" checked> <span class="ff-badge ff-low">Low</span></label>
            </div>
            <div class="ff-hot-row">
                <span>Hot Alerts:</span>
                <label><input type="checkbox" class="ff-hot-min" value="15" checked> 15m</label>
                <label><input type="checkbox" class="ff-hot-min" value="10" checked> 10m</label>
                <label><input type="checkbox" class="ff-hot-min" value="5" checked> 5m</label>
                <label><input type="checkbox" id="ff-hot-beep" checked> Beep</label>
            </div>
            <div id="ff-next" class="ff-next-banner">Next event: </div>
            <div id="ff-list" class="news-list">Loading</div>
        </div>
    </div>

    <!-- Yahoo Finance -->
    <div class="news-container tos-panel news-panel" data-panel="yahoo">
        <div class="news-header tos-panel-header">
            <div class="news-title tos-panel-title active">MARKET NEWS FEED</div>
            <div class="news-controls tos-panel-tools">
                <span style="font-size:0.75rem;color:var(--dim);">Date:</span>
                <select id="news-date" class="news-select tos-input"></select>
                <button class="news-refresh tos-button" onclick="refreshNews()">REFRESH NEWS</button>
                <button id="news-voice-btn" class="news-voice-btn tos-button" onclick="togNewsVoice()">News TTS: ON</button>
                <button id="analysis-toggle" class="tos-button" onclick="toggleAnalysis()">AI ANALYSIS: OFF</button>
                <span id="yahoo-refresh-state" class="refresh-state"></span>
            </div>
        </div>
        <div class="tos-panel-body">
            <div class="news-filter-row">
                <span>Impact:</span>
                <label><input type="checkbox" class="news-imp" value="high" checked> <span class="news-impact high">High</span></label>
                <label><input type="checkbox" class="news-imp" value="medium" checked> <span class="news-impact medium">Medium</span></label>
                <label><input type="checkbox" class="news-imp" value="low" checked> <span class="news-impact low">Low</span></label>
            </div>
            <div id="news-list" class="news-list">Loading</div>
        </div>
    </div>

    <!-- Watchlist (Net Change) -->
    <div id="watchlist-anchor" class="watchlist-anchor"></div>
    <div class="news-container tos-panel watchlist-panel" data-panel="watchlist">
        <div class="news-header tos-panel-header">
            <div class="news-title tos-panel-title active">WATCHLIST</div>
            <div class="news-controls tos-panel-tools">
                <span style="font-size:0.7rem;color:var(--dim);">Auto: 5m</span>
                <span style="font-size:0.7rem;color:var(--dim);">Sort:</span>
                <select id="wl-sort" class="news-select tos-input">
                    <option value="symbol">Symbol</option>
                    <option value="change">Net Change</option>
                    <option value="pct">% Change</option>
                </select>
                <button id="wl-refresh-btn" class="news-refresh tos-button">REFRESH WATCHLIST</button>
                <span id="wl-refresh-state" class="refresh-state"></span>
            </div>
        </div>
        <div class="tos-panel-body">
            <div class="watchlist-grid">
                <div class="watchlist-col">
                    <div class="watchlist-col-title">STOCKS</div>
                    <div class="watchlist-col-controls">
                        <input id="wl-input-stocks" class="watchlist-input" placeholder="AAPL, MSFT, NVDA">
                        <button class="tos-button" onclick="applyWatchlistGroup('stocks')">APPLY</button>
                    </div>
                    <div class="watchlist-head">
                        <span class="watchlist-head-symbol">SYMBOL</span>
                        <span>PRICE</span>
                        <span>NET</span>
                        <span>$</span>
                    </div>
                    <div id="wl-list-stocks" class="watchlist-list">Loading</div>
                </div>
                <div class="watchlist-col">
                    <div class="watchlist-col-title">SECTORS</div>
                    <div class="watchlist-col-controls">
                        <input id="wl-input-sectors" class="watchlist-input" placeholder="XLF, XLK, XLE">
                        <button class="tos-button" onclick="applyWatchlistGroup('sectors')">APPLY</button>
                    </div>
                    <div class="watchlist-head">
                        <span class="watchlist-head-symbol">SYMBOL</span>
                        <span>PRICE</span>
                        <span>NET</span>
                        <span>$</span>
                    </div>
                    <div id="wl-list-sectors" class="watchlist-list">Loading</div>
                </div>
                <div class="watchlist-col">
                    <div class="watchlist-col-title">ETFS</div>
                    <div class="watchlist-col-controls">
                        <input id="wl-input-etfs" class="watchlist-input" placeholder="QQQ, SPY, NQ=F, ES=F, IWM">
                        <button class="tos-button" onclick="applyWatchlistGroup('etfs')">APPLY</button>
                    </div>
                    <div class="watchlist-head">
                        <span class="watchlist-head-symbol">SYMBOL</span>
                        <span>PRICE</span>
                        <span>NET</span>
                        <span>$</span>
                    </div>
                    <div id="wl-list-etfs" class="watchlist-list">Loading</div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="terminal-footer">
    <span class="footer-chip">F1 <strong>Help</strong></span>
    <span class="footer-chip">F2 <strong>Notes</strong></span>
    <span class="footer-chip">F5 <strong>Refresh</strong></span>
    <span class="footer-chip">F8 <strong>Mute</strong></span>
    <span class="footer-chip">ESC <strong>Close</strong></span>
</div>

</div>
</div>
</div>

<script>
/* THEME SYSTEM */
const THEMES = {
    bloomberg: { '--bg': '#191B1D', '--card': '#232629', '--text': '#E0E3E7', '--alert': '#d63b3b' },
    nightops:  { '--bg': '#191B1D', '--card': '#232629', '--text': '#E0E3E7', '--alert': '#d63b3b' },
    minimal:   { '--bg': '#191B1D', '--card': '#232629', '--text': '#E0E3E7', '--alert': '#d63b3b' },
    terminal:  { '--bg': '#191B1D', '--card': '#232629', '--text': '#E0E3E7', '--alert': '#d63b3b' }
};

/* TIMER CONFIG (with roles) */
const config = [
    { label: "1 Minute",   seconds: 60,    type: "standard", warn: "00:00:10", role: "Scalp" },
    { label: "2 Minute",   seconds: 120,   type: "standard", warn: "00:00:15", role: "Scalp" },
    { label: "3 Minute",   seconds: 180,   type: "standard", warn: "00:00:20", role: "Entry" },
    { label: "5 Minute",   seconds: 300,   type: "standard", warn: "00:00:30", role: "Entry" },
    { label: "10 Minute",  seconds: 600,   type: "standard", warn: "00:01:00", role: "Entry" },
    { label: "15 Minute",  seconds: 900,   type: "standard", warn: "00:01:30", role: "Trend" },
    { label: "30 Minute",  seconds: 1800,  type: "standard", warn: "00:03:00", role: "Trend" },
    { label: "1 Hour",     seconds: 3600,  type: "standard", warn: "00:05:00", role: "Context" },
    { label: "2 Hour",     seconds: 7200,  type: "aligned",  warn: "00:10:00", role: "Context" },
    { label: "4 Hour",     seconds: 14400, type: "aligned",  warn: "00:15:00", role: "Swing" }
];

let offset = 0;
let audioOn = false;
let newsSpeechOn = true;
let lastSpeak = {};   // avoid repeating same-second TTS

/* Visible timeframes */
let visibleTimeframes = [];

/* NEWS STATE */
const seenNewsIds = new Set();   // Yahoo
const seenFFIds = new Set();     // Econ calendar
let yahooLastHtml = "";
let yahooLastUpdated = "";

/* Auto-refresh state */
let newsRefreshMs = 0;
let econRefreshMs = 0;
let newsRefreshTimer = null;
let econRefreshTimer = null;

/* Watchlist (net change) */
const WATCHLIST_REFRESH_MS = 5 * 60 * 1000;
const WATCHLIST_STORAGE_KEYS = {
    stocks: "watchlist-stocks",
    sectors: "watchlist-sectors",
    etfs: "watchlist-etfs"
};
const WATCHLIST_SORT_KEY = "watchlist-sort";
const WATCHLIST_PIN_KEY = "watchlist-pins-stocks";
const WATCHLIST_PIN_LIMIT = 2;
const WATCHLIST_DEFAULTS = {
    stocks: ["AAPL","MSFT","NVDA","TSLA","AMD"],
    sectors: ["XLF","XLK","XLE","XLP","XLY","XLI","XLB","XLU","XLV","XLRE"],
    etfs: ["QQQ","SPY","NQ=F","ES=F","IWM"]
};
let watchlistTimer = null;
let watchlistLastUpdated = "";
let watchlistLastUpdatedMs = 0;

/* Status bar state */
let statusMarket = "--";
let statusNews = "Manual";
let statusEcon = "Manual";
let statusAlert = "--";

/* News impact filters */
let newsImpactFilters = { high: true, medium: true, low: true };

/* Econ hot alerts */
let econHotLevels = [15, 10, 5];
let econHotBeep = true;
const econHotTriggered = new Set();
let analysisEnabled = false;

/* 10 AM Alarm state */
let alarm10Enabled = true;
let alarm10LastDate = localStorage.getItem("alarm10-last") || "";

/* Web Audio for alarm beep */
let audioCtx = null;

/* Yahoo RSS via AllOrigins */
const YF_RSS = "https://feeds.finance.yahoo.com/rss/2.0/headline?s=%5EGSPC&region=US&lang=en-US";
const YF_FEED_BASE = "https://api.allorigins.win/raw?url=";
const YF_RSS_API = "http://localhost:3000/api/yahoo-rss";

/* ECON BACKEND (Forex Factory proxy) */
const ECON_API_BASE = "http://localhost:3000/api/ff-calendar";
const FF_DIRECT_BASE = "https://nfs.faireconomy.media/ff_calendar_";
const FF_CACHE_TTL_MS = 10 * 60 * 1000;
const ffWeekCache = new Map();

/* Index quotes via Yahoo JSON */
const INDEX_YAHOO_URL = "https://query1.finance.yahoo.com/v7/finance/quote?symbols=SPY,QQQ,^VIX";
let indexTimer = null;

/* INIT */
function init() {
    loadVisibleTimeframes();
    renderTimerGrid();
    buildTimeframeSettingsUI();
    loadTh();
    loadScales();      // NEW
    initWidgetZoom();
    initOrientation();
    initDensity();
    initSettingsTabs();
    initNotes();
    initNewsControls();
    initNewsFilters();
    initEconHotControls();
    initWatchlist();
    initAnalysisToggle();
    initAlarmButton();
    startLoop();
    refreshNews(); // initial Yahoo
}

/* --- NEW: SCALE SYSTEM (GLOBAL WIDGET SCALE) --- */
function setScale(cssVar, value, storageKey) {
    const v = Math.max(0.5, Math.min(2, parseFloat(value) || 1));
    document.documentElement.style.setProperty(cssVar, String(v));
    localStorage.setItem(storageKey, String(v));
}
function loadScales() {
    const timer = parseFloat(localStorage.getItem("timer-scale") || "1");
    const yahoo = parseFloat(localStorage.getItem("yahoo-scale") || "1");
    const econ  = parseFloat(localStorage.getItem("econ-scale")  || "1");
    const watchlist = parseFloat(localStorage.getItem("watchlist-scale") || "1");

    document.documentElement.style.setProperty("--timer-scale", String(timer));
    document.documentElement.style.setProperty("--yahoo-scale", String(yahoo));
    document.documentElement.style.setProperty("--econ-scale",  String(econ));
    document.documentElement.style.setProperty("--watchlist-scale", String(watchlist));

    const t = document.getElementById("timer-scale");
    const y = document.getElementById("yahoo-scale");
    const e = document.getElementById("econ-scale");
    const w = document.getElementById("watchlist-scale");
    if (t) t.value = String(timer);
    if (y) y.value = String(yahoo);
    if (e) e.value = String(econ);
    if (w) w.value = String(watchlist);
}

/* Widget zoom preset (applies to timers + panels) */
const WIDGET_ZOOM_KEY = "widget-zoom-pct";
function applyWidgetZoom(pct, save = true) {
    const zoomPct = Math.max(100, Math.min(140, parseInt(pct, 10) || 100));
    const scale = 100 / zoomPct;
    setScale("--timer-scale", scale, "timer-scale");
    setScale("--yahoo-scale", scale, "yahoo-scale");
    setScale("--econ-scale", scale, "econ-scale");
    setScale("--watchlist-scale", scale, "watchlist-scale");
    const sel = document.getElementById("widget-zoom");
    if (sel) sel.value = String(zoomPct);
    if (save) localStorage.setItem(WIDGET_ZOOM_KEY, String(zoomPct));
}
function initWidgetZoom() {
    const saved = parseInt(localStorage.getItem(WIDGET_ZOOM_KEY) || "100", 10);
    applyWidgetZoom(saved, false);
    const sel = document.getElementById("widget-zoom");
    if (sel && !sel.dataset.bound) {
        sel.dataset.bound = "1";
        sel.addEventListener("change", () => applyWidgetZoom(sel.value, true));
    }
}

/* Layout orientation (portrait / landscape) */
const ORIENTATION_KEY = "layout-orientation";
function applyOrientation(mode, save = true) {
    const next = (mode === "landscape") ? "landscape" : "portrait";
    document.body.classList.toggle("landscape-mode", next === "landscape");
    moveWatchlist(next === "landscape");
    const sel = document.getElementById("layout-orientation");
    if (sel) sel.value = next;
    if (save) localStorage.setItem(ORIENTATION_KEY, next);
}
function moveWatchlist(isLandscape) {
    const watchlist = document.querySelector(".watchlist-panel");
    const anchor = document.getElementById("watchlist-anchor");
    const appFrame = document.querySelector(".main-stack");
    const newsWrapper = document.querySelector(".news-wrapper");
    if (!watchlist || !anchor || !appFrame || !newsWrapper) return;

    if (isLandscape) {
        if (watchlist.parentElement !== appFrame) {
            appFrame.insertBefore(watchlist, newsWrapper);
        }
    } else {
        if (watchlist.parentElement !== anchor.parentElement) {
            anchor.parentElement.insertBefore(watchlist, anchor.nextSibling);
        }
    }
}
function initOrientation() {
    const saved = localStorage.getItem(ORIENTATION_KEY) || "portrait";
    applyOrientation(saved, false);
    const sel = document.getElementById("layout-orientation");
    if (sel && !sel.dataset.bound) {
        sel.dataset.bound = "1";
        sel.addEventListener("change", () => applyOrientation(sel.value, true));
    }
}

/* Terminal layout controls */
const DENSITY_KEY = "density-mode";
function applyDensity(mode, save = true) {
    const next = (mode === "compact") ? "compact" : "comfortable";
    document.body.classList.toggle("density-compact", next === "compact");
    const sel = document.getElementById("density-mode");
    if (sel) sel.value = next;
    if (save) localStorage.setItem(DENSITY_KEY, next);
}
function initDensity() {
    const saved = localStorage.getItem(DENSITY_KEY) || "comfortable";
    applyDensity(saved, false);
    const sel = document.getElementById("density-mode");
    if (sel && !sel.dataset.bound) {
        sel.dataset.bound = "1";
        sel.addEventListener("change", () => applyDensity(sel.value, true));
    }
}

function initSettingsTabs() {
    const tabs = Array.from(document.querySelectorAll(".settings-tabs .tab-btn"));
    const panels = Array.from(document.querySelectorAll(".tab-panel"));
    if (!tabs.length || !panels.length) return;

    function activate(id) {
        tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === id));
        panels.forEach(p => p.classList.toggle("active", p.id === id));
    }

    tabs.forEach(btn => {
        btn.addEventListener("click", () => {
            activate(btn.dataset.tab);
        });
    });

    const accBtns = Array.from(document.querySelectorAll(".accordion .accordion-header"));
    accBtns.forEach(btn => {
        btn.addEventListener("click", () => {
            const parent = btn.closest(".accordion");
            if (parent) parent.classList.toggle("open");
        });
    });
}

/* Theme functions */
function applyTheme(themeKey, save = true) {
    const theme = THEMES[themeKey] || THEMES['bloomberg'];
    Object.entries(theme).forEach(([k, v]) => {
        document.documentElement.style.setProperty(k, v);
        localStorage.setItem(k, v);
    });

    const bgInput = document.getElementById('p-bg');
    const cdInput = document.getElementById('p-cd');
    const txInput = document.getElementById('p-tx');
    const alInput = document.getElementById('p-al');
    if (bgInput) bgInput.value = theme['--bg'];
    if (cdInput) cdInput.value = theme['--card'];
    if (txInput) txInput.value = theme['--text'];
    if (alInput) alInput.value = theme['--alert'];

    const sel = document.getElementById('theme-select');
    if (sel) sel.value = themeKey;

    if (save) localStorage.setItem('theme', themeKey);
}

/* Visible timeframes state */
function loadVisibleTimeframes() {
    const saved = localStorage.getItem("tf-visible");
    if (!saved) {
        visibleTimeframes = config.map(() => true);
    } else {
        const set = new Set(saved.split(",").map(x => parseInt(x,10)));
        visibleTimeframes = config.map((_, i) => set.has(i));
    }
}
function saveVisibleTimeframes() {
    const indices = config
        .map((_, i) => visibleTimeframes[i] ? i : null)
        .filter(i => i !== null);
    localStorage.setItem("tf-visible", indices.join(","));
}

/* Build timer cards grid */
function renderTimerGrid() {
    let html = "";

    config.forEach((c, i) => {
        if (!visibleTimeframes[i]) return;

        const savedWarn = localStorage.getItem('w-'+i) || c.warn;
        const savedMute = localStorage.getItem('mute-'+i) === '1';

        /* NEW: per-card scale */
        const tfScale = parseFloat(localStorage.getItem("tf-scale-" + i) || "1");

        let timeHTML =
            c.seconds === 60
              ? '<span id="t-'+i+'" class="c-time">00</span><span id="m-'+i+'" class="c-ms">.00</span>'
              : '<span id="t-'+i+'" class="c-time">00:00</span>';

        let alignHTML = "";
        if (c.type === "aligned") {
            const alignTime = localStorage.getItem('a-'+i) || (c.seconds === 14400 ? "17:00" : "00:00");
            alignHTML =
              '<div class="panel-row">' +
                '<span class="row-label">Align</span>' +
                '<span class="row-value">' +
                  '<input type="time" id="a-'+i+'" class="align-in" value="'+alignTime+'" onchange="save()">' +
                '</span>' +
              '</div>';
        }

        const roleHTML = c.role ? '<div class="c-role">'+c.role+'</div>' : '';

        html +=
          '<div class="card panel" id="c-'+i+'" style="--card-scale:'+tfScale+';">' +
            '<div class="panel-head">' +
              '<div class="panel-title">' +
                '<div class="c-title" id="title-'+i+'">'+c.label+'</div>' +
                roleHTML +
              '</div>' +
            '</div>' +
            alignHTML +
            '<div class="panel-row time-row">' +
              '<span class="row-label">Time Left</span>' +
              '<span class="row-value">'+timeHTML+'</span>' +
            '</div>' +
            '<div class="panel-row">' +
              '<span class="row-label">Alert At</span>' +
              '<span class="row-value">' +
                '<input type="text" id="w-'+i+'" value="'+savedWarn+'" onchange="save()">' +
                '<label class="mute-label"><input type="checkbox" id="mu-'+i+'" '+(savedMute?'checked':'')+' onchange="save()"> Mute</label>' +
              '</span>' +
            '</div>' +
          '</div>';
    });

    // RTH SESSION CARD
    const rO = localStorage.getItem('ro') || "09:30";
    const rC = localStorage.getItem('rc') || "16:00";
    const rW = localStorage.getItem('rw') || "00:15:00";

    html +=
      '<div class="card panel rth" id="c-rth">' +
        '<div class="panel-head">' +
          '<div class="panel-title">' +
            '<div class="c-title">RTH SESSION</div>' +
          '</div>' +
        '</div>' +
        '<div class="panel-row">' +
          '<span class="row-label">Open</span>' +
          '<span class="row-value"><input type="time" id="ro" value="'+rO+'" onchange="save()"></span>' +
        '</div>' +
        '<div class="panel-row">' +
          '<span class="row-label">Close</span>' +
          '<span class="row-value"><input type="time" id="rc" value="'+rC+'" onchange="save()"></span>' +
        '</div>' +
        '<div class="panel-row time-row">' +
          '<span class="row-label">Session</span>' +
          '<span class="row-value stack">' +
            '<span id="trth" class="c-time">--</span>' +
            '<span id="srth" class="c-sub">LOAD</span>' +
          '</span>' +
        '</div>' +
        '<div class="panel-row">' +
          '<span class="row-label">Alert At</span>' +
          '<span class="row-value"><input type="text" id="rw" value="'+rW+'" onchange="save()"></span>' +
        '</div>' +
      '</div>';

    document.getElementById("grid").innerHTML = html;
    cacheTimerElements();
}

/* Rebuild grid when visible timeframes change */
let timerEls = [];
let timeEls = [];
let msEls = [];
let warnEls = [];
let muteEls = [];
let titleEls = [];
let alignEls = [];
let cardScaleEls = [];

function cacheTimerElements() {
    timerEls = [];
    timeEls = [];
    msEls = [];
    warnEls = [];
    muteEls = [];
    titleEls = [];
    alignEls = [];
    cardScaleEls = [];

    config.forEach((_, i) => {
        timerEls[i] = document.getElementById('c-' + i);
        timeEls[i] = document.getElementById('t-' + i);
        msEls[i] = document.getElementById('m-' + i);
        warnEls[i] = document.getElementById('w-' + i);
        muteEls[i] = document.getElementById('mu-' + i);
        titleEls[i] = document.getElementById('title-' + i);
        alignEls[i] = document.getElementById('a-' + i);
        cardScaleEls[i] = document.getElementById('c-' + i);
    });
}

function rebuildGrid() {
    renderTimerGrid();
    cacheTimerElements();
}

/* Build timeframe settings UI (UPDATED: includes per-card size sliders) */
function buildTimeframeSettingsUI() {
    const cont = document.getElementById("tf-list");
    if (!cont) return;

    let inner = "";
    config.forEach((c, i) => {
        const checked = visibleTimeframes[i] !== false;
        const sc = parseFloat(localStorage.getItem("tf-scale-" + i) || "1");

        inner += `
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;padding:6px;border:1px solid var(--border);background:var(--panel-2);border-radius:2px;">
            <label style="display:flex;align-items:center;gap:6px;min-width:120px;">
              <input type="checkbox" class="tf-toggle" data-idx="${i}" ${checked ? "checked" : ""}>
              <span style="font-size:0.7rem;color:var(--text);">${c.label}</span>
            </label>

            <div style="display:flex;align-items:center;gap:8px;flex:1;">
              <span style="font-size:0.65rem;color:var(--text-muted);min-width:54px;">Size</span>
              <input type="range" class="tf-scale" data-idx="${i}"
                     min="0.85" max="1.35" step="0.01" value="${sc}">
              <span style="font-size:0.65rem;color:var(--text-muted);width:42px;text-align:right;">${Math.round(sc*100)}%</span>
            </div>
          </div>
        `;
    });

    cont.innerHTML = inner;

    Array.from(cont.querySelectorAll(".tf-toggle")).forEach(cb => {
        cb.addEventListener("change", () => {
            const idx = parseInt(cb.getAttribute("data-idx"), 10);
            visibleTimeframes[idx] = cb.checked;
            saveVisibleTimeframes();
            rebuildGrid();
            buildTimeframeSettingsUI();
        });
    });

    Array.from(cont.querySelectorAll(".tf-scale")).forEach(sl => {
        sl.addEventListener("input", () => {
            const idx = parseInt(sl.getAttribute("data-idx"), 10);
            const v = parseFloat(sl.value);

            localStorage.setItem("tf-scale-" + idx, String(v));

            const pct = sl.parentElement.querySelector("span:last-child");
            if (pct) pct.textContent = `${Math.round(v*100)}%`;

            const card = document.getElementById("c-" + idx);
            if (card) card.style.setProperty("--card-scale", v);
        });
    });
}

/* Layout presets */
function applyLayoutPreset(name) {
    if (name === 'scalp') {
        visibleTimeframes = config.map((_, i) => i <= 4); // 110m
    } else if (name === 'swing') {
        visibleTimeframes = config.map((_, i) => i >= 4); // 10m+
    } else {
        visibleTimeframes = config.map(() => true);
    }
    saveVisibleTimeframes();
    rebuildGrid();
    buildTimeframeSettingsUI();
}

/* MAIN LOOP */
const LOOP_INTERVAL_MS = 1000;
let loopTimer = null;

function setTextIfChanged(el, next) {
    if (el && el.textContent !== next) el.textContent = next;
}

function loopTick() {
    try {
        const nowMs = Date.now() + offset;
        const now = new Date(nowMs);
        const nyEl = document.getElementById('ny');
        if (!nyEl) {
            return;
        }

        const nyStr = now.toLocaleTimeString(
            'en-US',
            { timeZone: 'America/New_York', hour12: true }
        );
        setTextIfChanged(nyEl, nyStr);

        const timeMatch = nyStr.match(/(\d+):(\d+):(\d+)\s*(AM|PM)/i);
        if (!timeMatch) {
            return;
        }
        let h = parseInt(timeMatch[1],10);
        const m = parseInt(timeMatch[2],10);
        const s = parseInt(timeMatch[3],10);
        const ampm = timeMatch[4].toUpperCase();
        if (ampm === "PM" && h !== 12) h += 12;
        if (ampm === "AM" && h === 12) h = 0;

        const ms = 999 - now.getMilliseconds();

        // 10 AM alarm check
        check10Alarm(h, m, s);

        // Timer cards
        config.forEach((c, i) => {
            if (!visibleTimeframes[i]) return;

            let secRem = 0;
            const cardEl = timerEls[i];
            const tEl = timeEls[i];
            if (!cardEl || !tEl) return;

            if (c.type === "standard") {
                const total = Math.floor(nowMs/1000);
                secRem = c.seconds - (total % c.seconds) - 1;
            } else {
                const aEl = alignEls[i];
                const alignVal = aEl && aEl.value ? aEl.value : "00:00";
                const aParts = alignVal.split(':').map(Number);
                const aH = !Number.isNaN(aParts[0]) ? aParts[0] : 0;
                const intervalHrs = c.seconds / 3600;
                let dist = (aH - h) % intervalHrs;
                if (dist <= 0) dist += intervalHrs;
                secRem = ((dist - 1) * 3600) + ((59 - m) * 60) + (59 - s);
            }

            if (c.seconds === 60) {
                const nextSec = (secRem < 10 ? "0" : "") + secRem;
                setTextIfChanged(tEl, nextSec);
                const msEl = msEls[i];
                if (msEl) setTextIfChanged(msEl, "");
            } else {
                const nextFmt = fmt(secRem, c.seconds >= 3600);
                setTextIfChanged(tEl, nextFmt);
            }

            const wEl = warnEls[i];
            const thresh = parseTime(wEl ? wEl.value : c.warn);

            if (secRem <= thresh) cardEl.classList.add("alert");
            else cardEl.classList.remove("alert");

            const muteEl = muteEls[i];
            const isMuted = muteEl ? muteEl.checked : false;

            const titleEl = titleEls[i];
            if (titleEl) {
                if (isMuted) titleEl.classList.add('muted');
                else titleEl.classList.remove('muted');
            }

            if (secRem === thresh) {
                if (lastSpeak['c-'+i] !== secRem && !isMuted) {
                    speak(c.label + " candle closing in " + thresh + " seconds");
                    setLastAlert(c.label + " close " + thresh + "s");
                    lastSpeak['c-'+i] = secRem;
                }
            } else {
                lastSpeak['c-'+i] = -1;
            }
        });

        // RTH LOGIC
        const roEl = document.getElementById('ro');
        const rcEl = document.getElementById('rc');
        const trthEl = document.getElementById('trth');
        const srthEl = document.getElementById('srth');
        const rCardEl = document.getElementById('c-rth');

        if (roEl && rcEl && trthEl && srthEl && rCardEl) {
            const roParts = roEl.value.split(':').map(Number);
            const rcParts = rcEl.value.split(':').map(Number);
            const ro = [
                !Number.isNaN(roParts[0]) ? roParts[0] : 9,
                !Number.isNaN(roParts[1]) ? roParts[1] : 30
            ];
            const rc = [
                !Number.isNaN(rcParts[0]) ? rcParts[0] : 16,
                !Number.isNaN(rcParts[1]) ? rcParts[1] : 0
            ];

            const nowS = (h*3600) + (m*60) + s;
            const oS = (ro[0]*3600) + (ro[1]*60);
            const cS = (rc[0]*3600) + (rc[1]*60);

            const rwEl = document.getElementById('rw');
            const rthThresh = parseTime(rwEl ? rwEl.value : "00:15:00");

            let phase = "Closed";

            if (nowS >= oS && nowS < cS) {
                const diff = cS - nowS - 1;
                setTextIfChanged(trthEl, fmt(diff, true));
                setTextIfChanged(srthEl, "MARKET OPEN");
                phase = "RTH";

                if (diff <= rthThresh) rCardEl.classList.add("alert");
                else rCardEl.classList.remove("alert");

                if (diff === rthThresh && lastSpeak['rth'] !== diff) {
                    speak("Session closing in " + rthThresh + " seconds");
                    setLastAlert("Session close " + rthThresh + "s");
                    lastSpeak['rth'] = diff;
                }

                rCardEl.style.borderColor = "var(--green)";
            } else {
                rCardEl.classList.remove("alert");
                if (nowS < oS) {
                    setTextIfChanged(trthEl, fmt(oS - nowS - 1, true));
                    setTextIfChanged(srthEl, "PRE-MARKET");
                    phase = "Premarket";
                    rCardEl.style.borderColor = "var(--focus)";
                } else {
                    setTextIfChanged(trthEl, "CLOSED");
                    setTextIfChanged(srthEl, "SESSION ENDED");
                    phase = "Closed";
                    rCardEl.style.borderColor = "var(--border)";
                }
            }

            if (phase !== statusMarket) {
                statusMarket = phase;
                updateStatusBar();
            }
        }
    } catch (e) {
        console.warn("Loop error caught:", e);
    }
}

function startLoop() {
    if (loopTimer) clearInterval(loopTimer);
    loopTimer = setInterval(loopTick, LOOP_INTERVAL_MS);
    loopTick();
}

function stopLoop() {
    if (loopTimer) {
        clearInterval(loopTimer);
        loopTimer = null;
    }
}

document.addEventListener('visibilitychange', () => {
    if (document.hidden) stopLoop();
    else startLoop();
});

/* HELPERS */
function speak(msg) {
    if (!audioOn) return;
    try {
        const u = new SpeechSynthesisUtterance(msg);
        u.rate = 1.1;
        window.speechSynthesis.speak(u);
    } catch (e) {
        console.warn("Speech error:", e);
    }
}
function setAudioOn(on, announce) {
    audioOn = !!on;
    const btn = document.getElementById('snd-btn');
    if (!btn) return;
    if (audioOn) {
        btn.innerText = "SOUND: ON";
        btn.classList.add('on');
        if (announce) speak("Audio enabled");
    } else {
        btn.innerText = "SOUND: OFF";
        btn.classList.remove('on');
    }
}
function togSnd() {
    setAudioOn(!audioOn, true);
}
function setLastAlert(msg) {
    statusAlert = msg || "--";
    updateStatusBar();
}
function parseTime(v) {
    if (!v || typeof v !== "string") return 0;
    const p = v.split(':').map(Number);
    if (p.length === 3) return (p[0]*3600) + (p[1]*60) + p[2];
    if (p.length === 2) return (p[0]*60) + p[1];
    return Number.isNaN(p[0]) ? 0 : p[0];
}
function fmt(s, showHours) {
    if (s < 0) s = 0;
    const hr = Math.floor(s / 3600);
    const mn = Math.floor((s % 3600) / 60);
    const sc = s % 60;
    const base = (mn < 10 ? "0" : "") + mn + ":" + (sc < 10 ? "0" : "") + sc;
    return showHours ? hr + ":" + base : base;
}
function save() {
    config.forEach((c, i) => {
        const wEl = document.getElementById('w-'+i);
        if (wEl) localStorage.setItem('w-'+i, wEl.value);
        const muEl = document.getElementById('mu-'+i);
        if (muEl) localStorage.setItem('mute-'+i, muEl.checked ? '1' : '0');
        if (c.type === "aligned") {
            const aEl = document.getElementById('a-'+i);
            if (aEl) localStorage.setItem('a-'+i, aEl.value);
        }
    });
    const roEl = document.getElementById('ro');
    const rcEl = document.getElementById('rc');
    const rwEl = document.getElementById('rw');
    if (roEl) localStorage.setItem('ro', roEl.value);
    if (rcEl) localStorage.setItem('rc', rcEl.value);
    if (rwEl) localStorage.setItem('rw', rwEl.value);
}
function tog(id, s) {
    const el = document.getElementById(id);
    if (!el) return;
    if (s) el.classList.add("visible");
    else el.classList.remove("visible");
}
function upTh(p, v) {
    if (p === "size") {
        document.documentElement.style.fontSize = v + "px";
        localStorage.setItem('sz', v);
    } else {
        document.documentElement.style.setProperty(p, v);
        localStorage.setItem(p, v);
        if (p === '--bg')  { const i = document.getElementById('p-bg'); if (i) i.value = v; }
        if (p === '--card'){ const i = document.getElementById('p-cd'); if (i) i.value = v; }
        if (p === '--text'){ const i = document.getElementById('p-tx'); if (i) i.value = v; }
        if (p === '--alert'){const i = document.getElementById('p-al'); if (i) i.value = v; }
    }
}
function loadTh() {
    const themeKey = localStorage.getItem('theme') || 'bloomberg';
    applyTheme(themeKey, false);

    ['--bg','--card','--text','--alert'].forEach(k => {
        const v = localStorage.getItem(k);
        if (v) {
            document.documentElement.style.setProperty(k, v);
            if (k === '--bg')  { const i = document.getElementById('p-bg'); if (i) i.value = v; }
            if (k === '--card'){ const i = document.getElementById('p-cd'); if (i) i.value = v; }
            if (k === '--text'){ const i = document.getElementById('p-tx'); if (i) i.value = v; }
            if (k === '--alert'){const i = document.getElementById('p-al'); if (i) i.value = v; }
        }
    });

    const sz = localStorage.getItem('sz');
    if (sz) document.documentElement.style.fontSize = sz + "px";

    const sel = document.getElementById('theme-select');
    if (sel && !sel.dataset.bound) {
        sel.dataset.bound = '1';
        sel.value = themeKey;
        sel.addEventListener('change', e => applyTheme(e.target.value, true));
    }
}
function resetTh() {
    localStorage.clear();
    location.reload();
}

/* DATE HELPERS */
function getTodayNY() {
    const now = new Date();
    const nyStr = now.toLocaleString("en-US", { timeZone: "America/New_York" });
    const ny = new Date(nyStr);
    const y = ny.getFullYear();
    const m = String(ny.getMonth()+1).padStart(2, "0");
    const d = String(ny.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
}

/* 10 AM ALARM */
function initAlarmButton() {
    const saved = localStorage.getItem("alarm10");
    if (saved === "0") alarm10Enabled = false;
    updateAlarmButton();
}
function updateAlarmButton() {
    const btn = document.getElementById("alarm10-btn");
    if (!btn) return;
    if (alarm10Enabled) {
        btn.classList.add("on");
        btn.innerText = "10 AM ALARM: ON";
    } else {
        btn.classList.remove("on");
        btn.innerText = "10 AM ALARM: OFF";
    }
}
function togAlarm10() {
    alarm10Enabled = !alarm10Enabled;
    localStorage.setItem("alarm10", alarm10Enabled ? "1" : "0");
    updateAlarmButton();
}
function check10Alarm(h, m, s) {
    if (!alarm10Enabled) return;
    const today = getTodayNY();
    if (today === alarm10LastDate) return;
    if (h === 9 && m === 59 && s === 0) {
        if (audioOn) {
            playBeep();
        }
        setLastAlert("10 AM Alarm");
        alarm10LastDate = today;
        localStorage.setItem("alarm10-last", today);
    }
}
function playBeep() {
    try {
        if (!audioCtx) {
            const Ctx = window.AudioContext || window.webkitAudioContext;
            if (!Ctx) return;
            audioCtx = new Ctx();
        }
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = "sine";
        osc.frequency.value = 880;
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        gain.gain.setValueAtTime(0.35, now);
        gain.gain.exponentialRampToValueAtTime(0.0001, now + 1.0);
        osc.start(now);
        osc.stop(now + 1.0);
    } catch (e) {
        console.warn("Beep error:", e);
    }
}

function setYahooRefreshState(text, active) {
    const el = document.getElementById("yahoo-refresh-state");
    if (!el) return;
    el.innerText = text || "";
    el.classList.toggle("active", !!active);
}

function classifyNewsImpact(title) {
    const t = (title || "").toLowerCase();
    const high = [
        "cpi","ppi","fomc","fed","rate ","rates","rate hike","rate cut",
        "inflation","payroll","jobs","nfp","gdp","pce","powell",
        "ism","pmi","unemployment","treasury","auction"
    ];
    const medium = [
        "earnings","guidance","downgrade","upgrade","buyback","futures",
        "dow ","nasdaq","s&p","spx","bank","oil","crude","opec",
        "bitcoin","crypto","sec","ipo","merger","acquisition","tariff","sanction"
    ];
    if (high.some(k => t.includes(k))) return "high";
    if (medium.some(k => t.includes(k))) return "medium";
    return "low";
}
function shouldShowNewsImpact(impact) {
    return !!newsImpactFilters[impact];
}

/* ---------------------- NEWS: YAHOO ---------------------- */
function refreshYahoo() {
    const dateInput = document.getElementById("news-date");
    const selectedDate = dateInput && dateInput.value ? dateInput.value : "";
    const url = YF_RSS_API;

    const listEl = document.getElementById("news-list");
    const prevScroll = listEl ? listEl.scrollTop : 0;
    setYahooRefreshState("Refreshing...", true);

    fetch(url)
        .then(r => {
            if (!r.ok) throw new Error("Yahoo RSS backend error");
            return r.text();
        })
        .catch(() => {
            const fallbackUrl = YF_FEED_BASE + encodeURIComponent(YF_RSS);
            return fetch(fallbackUrl).then(r => r.text());
        })
        .then(str => {
            let doc;
            try {
                doc = new window.DOMParser().parseFromString(str, "text/xml");
            } catch (e) {
                console.warn("DOMParser error on Yahoo feed:", e);
                if (listEl && yahooLastHtml) {
                    listEl.innerHTML = yahooLastHtml;
                } else if (listEl) {
                    listEl.innerText = "Could not parse news.";
                }
                setYahooRefreshState("Refresh failed", false);
                return;
            }

            const items = Array.from(doc.querySelectorAll("item"));
            if (!listEl) return;

            let html = "";
            let firstNewTitle = null;
            let shown = 0;
            const maxYahooItems = 15;

            function appendItems(filterByDate) {
                items.forEach(it => {
                    if (shown >= maxYahooItems) return;
                    const guid = it.querySelector("guid")?.textContent ||
                                 it.querySelector("link")?.textContent ||
                                 it.querySelector("title")?.textContent || "";
                    const title = it.querySelector("title")?.textContent?.trim() || "Untitled";
                    const link  = it.querySelector("link")?.textContent?.trim() || "#";
                    const pub   = it.querySelector("pubDate")?.textContent || "";
                    let tlabel = "";
                    let dStr = "";

                    if (pub) {
                        const d = new Date(pub);
                        if (!Number.isNaN(d.getTime())) {
                            tlabel = d.toLocaleTimeString("en-US", {
                                hour: "numeric",
                                minute: "2-digit",
                                hour12: true
                            });
                            const yy = d.getFullYear();
                            const mm = String(d.getMonth()+1).padStart(2,"0");
                            const dd = String(d.getDate()).padStart(2,"0");
                            dStr = `${yy}-${mm}-${dd}`;
                        }
                    }

                    if (filterByDate && selectedDate && dStr && dStr !== selectedDate) return;
                    const impact = classifyNewsImpact(title);
                    if (!shouldShowNewsImpact(impact)) return;
                    const impactLabel = impact === "high" ? "High" : (impact === "medium" ? "Medium" : "Low");
                    const analysisClass = analysisEnabled ? "has-anl" : "no-anl";
                    const analysisBtn = analysisEnabled
                        ? '<button class="news-anl-btn" data-guid="'+guid+'" data-impact="'+impact+'" data-title="'+encodeURIComponent(title)+'" title="Analyze">ANL</button>'
                        : '';

                    if (!seenNewsIds.has(guid)) {
                        seenNewsIds.add(guid);
                        if (!firstNewTitle) firstNewTitle = title;
                    }

                    html += '<div class="news-item news-item-yahoo tos-row '+analysisClass+'">' +
                                (tlabel ? '<span class="news-time">'+tlabel+'</span>' : '') +
                                '<span class="news-impact '+impact+'">'+impactLabel+'</span>' +
                                '<strong>Yahoo Finance</strong>' +
                                '<a href="'+link+'" target="_blank" rel="noopener noreferrer" title="'+title.replace(/"/g, "&quot;")+'">'+title+'</a>' +
                                analysisBtn +
                            '</div>';
                    shown += 1;
                });
            }

            appendItems(true);
            if (!html && selectedDate) {
                html = "";
                shown = 0;
                firstNewTitle = null;
                appendItems(false);
            }

            if (html) {
                listEl.innerHTML = html;
                yahooLastHtml = html;
            } else if (!yahooLastHtml) {
                listEl.innerText = "No headlines match filters.";
            }

            if (listEl) {
                listEl.scrollTop = Math.min(prevScroll, listEl.scrollHeight);
            }

            const now = new Date();
            yahooLastUpdated = now.toLocaleTimeString("en-US", {
                hour: "numeric",
                minute: "2-digit",
                hour12: true
            });
            setYahooRefreshState("Updated " + yahooLastUpdated, false);

            if (firstNewTitle && audioOn && newsSpeechOn) {
                speak("Yahoo Finance: " + firstNewTitle);
                setLastAlert("News: " + firstNewTitle);
            }
        })
        .catch(err => {
            console.warn("Yahoo Finance feed error:", err);
            if (listEl && yahooLastHtml) {
                listEl.innerHTML = yahooLastHtml;
            } else if (listEl) {
                listEl.innerText = "Could not load news.";
            }
            setYahooRefreshState("Refresh failed", false);
        });
}

/* ---------------------- ECON CALENDAR (Forex Factory) ---------------------- */
function impactToLevel(impact) {
    if (!impact) return "low";
    const s = impact.toLowerCase();
    if (s.includes("high")) return "high";
    if (s.includes("medium")) return "medium";
    if (s.includes("low")) return "low";
    return "low";
}

function dayDiff(a, b) {
    const da = new Date(`${a}T00:00:00`);
    const db = new Date(`${b}T00:00:00`);
    const msPerDay = 24 * 60 * 60 * 1000;
    return Math.round((da - db) / msPerDay);
}

function pickEconVal(ev, keys) {
    if (!ev) return "";
    for (const k of keys) {
        if (ev[k] == null) continue;
        const s = String(ev[k]).trim();
        if (s) return s;
    }
    return "";
}
function fmtEconVal(v) {
    return v && String(v).trim() ? String(v).trim() : "--";
}

async function fetchFFWeekData(suffix) {
    const cached = ffWeekCache.get(suffix);
    const now = Date.now();
    if (cached && (now - cached.fetchedAt) < FF_CACHE_TTL_MS) {
        return cached.data;
    }

    const url = FF_DIRECT_BASE + suffix + ".json";
    let data = [];

    try {
        const resp = await fetch(url);
        if (!resp.ok) throw new Error("FF direct fetch failed");
        data = await resp.json();
    } catch (err) {
        const proxyUrl = YF_FEED_BASE + encodeURIComponent(url);
        const resp = await fetch(proxyUrl);
        if (!resp.ok) throw new Error("FF proxy fetch failed");
        data = await resp.json();
    }

    const arr = Array.isArray(data) ? data : [];
    ffWeekCache.set(suffix, { data: arr, fetchedAt: now });
    return arr;
}

async function fetchEconFallback(selectedDate, countriesVal, impParam) {
    const todayStr = getTodayNY();
    const diffFromToday = dayDiff(selectedDate, todayStr);
    const candidates = ["thisweek"];

    if (diffFromToday < 0 && diffFromToday >= -7) {
        candidates.push("lastweek");
    } else if (diffFromToday > 0 && diffFromToday <= 7) {
        candidates.push("nextweek");
    }

    let dataForDate = [];

    for (const suffix of candidates) {
        const weekData = await fetchFFWeekData(suffix);
        const subset = weekData.filter(ev => {
            if (!ev.date) return false;
            return ev.date.slice(0, 10) === selectedDate;
        });
        if (subset.length > 0) {
            dataForDate = subset;
            break;
        }
    }

    const countries = (countriesVal || "")
        .split(",")
        .map(s => s.trim().toUpperCase())
        .filter(Boolean);
    if (countries.length) {
        dataForDate = dataForDate.filter(ev =>
            ev.country && countries.includes(ev.country.toUpperCase())
        );
    }

    const impacts = (impParam || "")
        .split(",")
        .map(s => s.trim().toLowerCase())
        .filter(Boolean);
    if (impacts.length) {
        dataForDate = dataForDate.filter(ev =>
            ev.impact && impacts.includes(ev.impact.toLowerCase())
        );
    }

    dataForDate.sort((a, b) => new Date(a.date) - new Date(b.date));
    return dataForDate;
}

function renderEconData(data) {
    if (!Array.isArray(data)) data = [];
    const el = document.getElementById("ff-list");
    if (!el) return;

    let html = "";
    let firstNew = null;
    const now = new Date();
    let nextUpcoming = null;
    let nextDiff = Infinity;
    let rendered = 0;

    data.forEach(ev => {
        try {
            const id = (ev.country || "") + "|" + (ev.title || "") + "|" + (ev.date || "");
            if (!seenFFIds.has(id)) {
                seenFFIds.add(id);
                if (!firstNew) firstNew = ev;
            }

            const level = impactToLevel(ev.impact);
            const when = ev.date ? new Date(ev.date) : null;
            const timeLabel = when
                ? when.toLocaleTimeString("en-US", {
                      timeZone: "America/New_York",
                      hour: "numeric",
                      minute: "2-digit",
                      hour12: true
                  })
                : "";

            const minsDiff = when ? (when - now) / 60000 : 9999;
            let extraClass = "";
            if (minsDiff < 0) extraClass = " ff-past";
            else if (minsDiff <= 30) extraClass = " ff-soon";
            const hotMax = econHotLevels.length ? Math.max(...econHotLevels) : 0;
            if (hotMax && minsDiff >= 0 && minsDiff <= hotMax) {
                extraClass += " ff-hot";
            }

            if (minsDiff >= 0 && minsDiff < nextDiff) {
                nextDiff = minsDiff;
                nextUpcoming = { ev, timeLabel, level };
            }

            const country = ev.country || "";
            const title = ev.title || "Event";

            const niceImpact =
                level === "high" ? "High" :
                level === "medium" ? "Medium" : "Low";

            const actual = pickEconVal(ev, ["actual", "act"]);
            const forecast = pickEconVal(ev, ["forecast", "consensus"]);
            const previous = pickEconVal(ev, ["previous", "prev"]);
            const revised = pickEconVal(ev, ["revised", "revision", "revised_from", "revisedFrom"]);

            if (econHotLevels.length && minsDiff >= 0) {
                const eligible = econHotLevels.filter(level => minsDiff <= level);
                if (eligible.length) {
                    const level = Math.min.apply(null, eligible);
                    const key = id + "|" + level;
                    if (!econHotTriggered.has(key)) {
                        econHotTriggered.add(key);
                        setLastAlert(`Econ ${level}m: ${title}`);
                        if (econHotBeep && audioOn) {
                            playBeep();
                        }
                    }
                }
            }

            html +=
                '<div class="news-item ff-item tos-row'+extraClass+'">' +
                    '<div class="ff-cell ff-time">'+(timeLabel || '--')+'</div>' +
                    '<div class="ff-cell ff-cur">'+(country || '--')+'</div>' +
                    '<div class="ff-cell"><span class="ff-badge ff-'+level+'">'+niceImpact+'</span></div>' +
                    '<div class="ff-cell ff-label">'+title+'</div>' +
                    '<div class="ff-cell ff-stat-val">'+fmtEconVal(actual)+'</div>' +
                    '<div class="ff-cell ff-stat-val">'+fmtEconVal(forecast)+'</div>' +
                    '<div class="ff-cell ff-stat-val">'+fmtEconVal(previous)+'</div>' +
                    '<div class="ff-cell ff-stat-val">'+fmtEconVal(revised)+'</div>' +
                '</div>';
            rendered += 1;
        } catch (e) {
            console.warn("Error mapping econ event:", e);
        }
    });

    if (!html) {
        html = '<div class="news-item ff-item tos-row"><div class="ff-cell">--</div><div class="ff-cell">--</div><div class="ff-cell">--</div><div class="ff-cell">No events found</div><div class="ff-cell">--</div><div class="ff-cell">--</div><div class="ff-cell">--</div><div class="ff-cell">--</div></div>';
    }
    const minRows = 10;
    const rowCount = html ? (html.match(/news-item ff-item/g) || []).length : 0;
    if (rowCount && rowCount < minRows) {
        for (let i = rowCount; i < minRows; i += 1) {
            html += '<div class="news-item ff-item tos-row ff-empty">' +
                new Array(8).fill('<div class="ff-cell">&nbsp;</div>').join("") +
            '</div>';
        }
    }
    el.innerHTML = html;

    const nextEl2 = document.getElementById("ff-next");
    if (nextEl2) {
        if (nextUpcoming) {
            const ev = nextUpcoming.ev;
            const level = nextUpcoming.level;
            const timeLabel = nextUpcoming.timeLabel;
            const what =
                level === "high" ? "High impact" :
                level === "medium" ? "Medium impact" : "Low impact";
            const country = ev.country || "";
            const title = ev.title || "event";
            const mins = Math.round(nextDiff);
            const minsText = mins <= 1 ? "now" : `in ${mins} min`;
            nextEl2.innerText =
                `Next ${what} event: ${timeLabel} ${country ? "["+country+"] " : ""}${title} (${minsText})`;
        } else {
            nextEl2.innerText = "No upcoming events for the rest of the selected day.";
        }
    }

    if (firstNew && audioOn && newsSpeechOn) {
        const level = impactToLevel(firstNew.impact);
        const when = firstNew.date ? new Date(firstNew.date) : null;
        const timeLabel = when
            ? when.toLocaleTimeString("en-US", {
                  timeZone: "America/New_York",
                  hour: "numeric",
                  minute: "2-digit",
                  hour12: true
              })
            : "";
        const country = firstNew.country || "";
        const title = firstNew.title || "event";

        const what =
            level === "high" ? "High impact" :
            level === "medium" ? "Medium impact" : "Low impact";

        const tPart = timeLabel ? " at " + timeLabel : "";
        const cPart = country ? " in " + country : "";

        speak("Economic calendar " + what + " event" + tPart + cPart + ": " + title);
        setLastAlert("Econ: " + title);
    }

    return rendered;
}

async function refreshEcon() {
    const econDateInput = document.getElementById("econ-date");
    const selectedDate = econDateInput && econDateInput.value ? econDateInput.value : getTodayNY();

    const countryCbs = Array.from(document.querySelectorAll(".ff-country"));
    const selectedCountries = countryCbs
        .filter(cb => cb.checked)
        .map(cb => cb.value);
    const countriesVal = selectedCountries.join(",");

    const impCheckboxes = Array.from(document.querySelectorAll(".ff-imp"));
    const imps = impCheckboxes
        .filter(cb => cb.checked)
        .map(cb => cb.value.toLowerCase());
    const impParam = imps.join(",");

    // Save filters
    localStorage.setItem("econ-date", selectedDate);
    localStorage.setItem("ff-countries", countriesVal);
    localStorage.setItem("ff-imp", impParam || "high,medium,low");

    const listEl = document.getElementById("ff-list");
    if (listEl) listEl.innerText = "Loading";
    const nextEl = document.getElementById("ff-next");
    if (nextEl) nextEl.innerText = "Next event: ";

    const url =
        ECON_API_BASE +
        `?date=${encodeURIComponent(selectedDate)}` +
        (countriesVal ? `&countries=${encodeURIComponent(countriesVal)}` : "") +
        (impParam ? `&imp=${encodeURIComponent(impParam)}` : "");

    try {
        const r = await fetch(url);
        if (!r.ok) throw new Error("Backend error");
        const data = await r.json();
        const rendered = renderEconData(data);
        const todayStr = getTodayNY();
        if (!rendered && selectedDate !== todayStr) {
            const fallbackToday = await fetchEconFallback(todayStr, countriesVal, impParam);
            renderEconData(fallbackToday);
            if (econDateInput) econDateInput.value = todayStr;
            localStorage.setItem("econ-date", todayStr);
        }
    } catch (err) {
        console.warn("Econ calendar fetch error:", err);
        try {
            const fallbackData = await fetchEconFallback(selectedDate, countriesVal, impParam);
            const rendered = renderEconData(fallbackData);
            const todayStr = getTodayNY();
            if (!rendered && selectedDate !== todayStr) {
                const fallbackToday = await fetchEconFallback(todayStr, countriesVal, impParam);
                renderEconData(fallbackToday);
                if (econDateInput) econDateInput.value = todayStr;
                localStorage.setItem("econ-date", todayStr);
            }
        } catch (fallbackErr) {
            console.warn("Econ calendar fallback error:", fallbackErr);
            const el = document.getElementById("ff-list");
            if (el) el.innerText = "Could not load economic calendar.";
            const nextEl2 = document.getElementById("ff-next");
            if (nextEl2) nextEl2.innerText = "Backend offline or unreachable.";
        }
    }
}

/* Combined manual refresh for Yahoo */
function refreshNews() {
    refreshYahoo();
}

/* NEWS CONTROLS & AUTO REFRESH */
function setNewsAutoRefresh(ms) {
    if (newsRefreshTimer) clearInterval(newsRefreshTimer);
    newsRefreshMs = ms || 0;
    localStorage.setItem("news-refresh-ms", String(newsRefreshMs));
    if (newsRefreshMs > 0) {
        newsRefreshTimer = setInterval(refreshNews, newsRefreshMs);
    }
    statusNews = newsRefreshMs ? `Auto ${Math.round(newsRefreshMs/60000)}m` : "Manual";
    updateStatusBar();
    const sel = document.getElementById("news-refresh-select");
    if (sel && String(newsRefreshMs) !== sel.value) sel.value = String(newsRefreshMs);
}
function setEconAutoRefresh(ms) {
    if (econRefreshTimer) clearInterval(econRefreshTimer);
    econRefreshMs = ms || 0;
    localStorage.setItem("econ-refresh-ms", String(econRefreshMs));
    if (econRefreshMs > 0) {
        econRefreshTimer = setInterval(refreshEcon, econRefreshMs);
    }
    statusEcon = econRefreshMs ? `Auto ${Math.round(econRefreshMs/60000)}m` : "Manual";
    updateStatusBar();
    const sel = document.getElementById("econ-refresh-select");
    if (sel && String(econRefreshMs) !== sel.value) sel.value = String(econRefreshMs);
}

/* WATCHLIST (Net Change) */
function normalizeWatchlistSymbols(raw) {
    return String(raw || "")
        .split(/[,\\s]+/)
        .map(s => s.trim())
        .filter(Boolean)
        .map(s => s.toUpperCase());
}
function getWatchlistSymbols(group) {
    const key = WATCHLIST_STORAGE_KEYS[group];
    const saved = localStorage.getItem(key);
    if (saved !== null) {
        return normalizeWatchlistSymbols(saved);
    }
    return WATCHLIST_DEFAULTS[group] || [];
}
function setWatchlistSymbols(group, symbols) {
    const key = WATCHLIST_STORAGE_KEYS[group];
    const clean = normalizeWatchlistSymbols(symbols.join(","));
    localStorage.setItem(key, clean.join(","));
}
function applyWatchlistGroup(group) {
    const input = document.getElementById(`wl-input-${group}`);
    if (!input) return;
    const list = normalizeWatchlistSymbols(input.value);
    setWatchlistSymbols(group, list);
    refreshWatchlist();
}
function initWatchlist() {
    const groups = ["stocks","sectors","etfs"];
    groups.forEach(group => {
        const input = document.getElementById(`wl-input-${group}`);
        if (input) {
            input.value = getWatchlistSymbols(group).join(", ");
            input.addEventListener("blur", () => applyWatchlistGroup(group));
        }
    });
    const btn = document.getElementById("wl-refresh-btn");
    if (btn) btn.addEventListener("click", refreshWatchlist);
    const sortSel = document.getElementById("wl-sort");
    if (sortSel) {
        sortSel.value = localStorage.getItem(WATCHLIST_SORT_KEY) || "symbol";
        sortSel.addEventListener("change", () => {
            localStorage.setItem(WATCHLIST_SORT_KEY, sortSel.value);
            refreshWatchlist();
        });
    }
    bindWatchlistPins();
    refreshWatchlist();
    if (watchlistTimer) clearInterval(watchlistTimer);
    watchlistTimer = setInterval(refreshWatchlist, WATCHLIST_REFRESH_MS);
    setInterval(updateWatchlistRefreshState, 60 * 1000);
}
function bindWatchlistPins() {
    const listEl = document.getElementById("wl-list-stocks");
    if (!listEl || listEl.dataset.pinsBound) return;
    listEl.dataset.pinsBound = "1";
    listEl.addEventListener("click", (e) => {
        const btn = e.target.closest(".watchlist-pin");
        if (!btn) return;
        const sym = (btn.dataset.symbol || "").toUpperCase();
        if (!sym) return;
        togglePinnedStock(sym);
    });
}
function getPinnedStocks() {
    const raw = localStorage.getItem(WATCHLIST_PIN_KEY) || "";
    const pins = raw
        .split(",")
        .map(s => s.trim().toUpperCase())
        .filter(Boolean);
    if (pins.length > WATCHLIST_PIN_LIMIT) {
        const trimmed = pins.slice(0, WATCHLIST_PIN_LIMIT);
        setPinnedStocks(trimmed);
        return trimmed;
    }
    return pins;
}
function setPinnedStocks(pins) {
    localStorage.setItem(WATCHLIST_PIN_KEY, pins.join(","));
}
function togglePinnedStock(symbol) {
    const pins = getPinnedStocks();
    const idx = pins.indexOf(symbol);
    if (idx >= 0) {
        pins.splice(idx, 1);
        setPinnedStocks(pins);
        refreshWatchlist();
        return;
    }
    if (pins.length >= WATCHLIST_PIN_LIMIT) {
        console.warn("Pin limit reached (2). Unpin a stock first.");
        return;
    }
    pins.unshift(symbol);
    setPinnedStocks(pins);
    refreshWatchlist();
}
function refreshWatchlist() {
    const stocks = getWatchlistSymbols("stocks");
    const sectors = getWatchlistSymbols("sectors");
    const etfs = getWatchlistSymbols("etfs");
    const allSymbols = Array.from(new Set([...stocks, ...sectors, ...etfs]));
    const stateEl = document.getElementById("wl-refresh-state");

    if (!allSymbols.length) {
        renderWatchlistColumn("stocks", stocks, {});
        renderWatchlistColumn("sectors", sectors, {});
        renderWatchlistColumn("etfs", etfs, {});
        if (stateEl) stateEl.textContent = "No symbols";
        return;
    }

    const url = `http://localhost:3000/api/quotes?symbols=${encodeURIComponent(allSymbols.join(","))}`;
    fetch(url)
        .then(r => r.json())
        .then(data => {
            const results = (data && data.quoteResponse && data.quoteResponse.result) ? data.quoteResponse.result : [];
            const bySymbol = {};
            results.forEach(q => { if (q && q.symbol) bySymbol[q.symbol.toUpperCase()] = q; });
            renderWatchlistColumn("stocks", stocks, bySymbol);
            renderWatchlistColumn("sectors", sectors, bySymbol);
            renderWatchlistColumn("etfs", etfs, bySymbol);
            const now = new Date();
            watchlistLastUpdatedMs = now.getTime();
            watchlistLastUpdated = now.toLocaleTimeString("en-US", { hour: "numeric", minute: "2-digit" });
            updateWatchlistRefreshState();
        })
        .catch(err => {
            console.warn("Watchlist fetch error:", err);
            if (stateEl) stateEl.textContent = "Offline";
        });
}
function updateWatchlistRefreshState() {
    const stateEl = document.getElementById("wl-refresh-state");
    if (!stateEl) return;
    if (!watchlistLastUpdatedMs) {
        stateEl.textContent = "Waiting...";
        return;
    }
    const ageMs = Date.now() - watchlistLastUpdatedMs;
    const mins = Math.floor(ageMs / 60000);
    const stale = ageMs > 10 * 60 * 1000;
    const suffix = stale ? " (Stale)" : "";
    stateEl.textContent = `Updated ${watchlistLastUpdated}${mins ? `  ${mins}m ago` : ""}${suffix}`;
}
function renderWatchlistColumn(group, symbols, bySymbol) {
    const listEl = document.getElementById(`wl-list-${group}`);
    if (!listEl) return;
    if (!symbols || !symbols.length) {
        listEl.innerHTML = '<div class=\"watchlist-empty\">No symbols.</div>';
        return;
    }
    const sortKey = localStorage.getItem(WATCHLIST_SORT_KEY) || "symbol";
    const sorted = [...symbols].sort((a, b) => {
        if (sortKey === "symbol") return a.localeCompare(b);
        const qa = bySymbol[a.toUpperCase()] || {};
        const qb = bySymbol[b.toUpperCase()] || {};
        const ca = Number(qa.regularMarketChange || 0);
        const cb = Number(qb.regularMarketChange || 0);
        const pa = Number(qa.regularMarketChangePercent || 0);
        const pb = Number(qb.regularMarketChangePercent || 0);
        if (sortKey === "change") return cb - ca;
        if (sortKey === "pct") return pb - pa;
        return 0;
    });
    let ordered = sorted;
    let pinnedSet = null;
    if (group === "stocks") {
        const pins = getPinnedStocks();
        const symbolMap = {};
        symbols.forEach(s => { symbolMap[s.toUpperCase()] = s; });
        const visiblePins = pins.filter(p => symbolMap[p]);
        if (visiblePins.length !== pins.length) {
            setPinnedStocks(visiblePins);
        }
        const pinned = visiblePins.map(p => symbolMap[p]).filter(Boolean);
        pinnedSet = new Set(pinned.map(p => p.toUpperCase()));
        ordered = [...pinned, ...sorted.filter(s => !pinnedSet.has(s.toUpperCase()))];
    }
    const rows = ordered.map(sym => {
        const q = bySymbol[sym.toUpperCase()];
        const isPinned = group === "stocks" && pinnedSet && pinnedSet.has(sym.toUpperCase());
        const pinBtn = (group === "stocks")
            ? `<button class=\"watchlist-pin ${isPinned ? "active" : ""}\" data-symbol=\"${sym.toUpperCase()}\" title=\"${isPinned ? "Unpin" : "Pin"}\" aria-label=\"${isPinned ? "Unpin" : "Pin"} ${sym}\">` +
                `<svg viewBox=\"0 0 24 24\" aria-hidden=\"true\" focusable=\"false\">` +
                    `<path d=\"M9 2h6v2l-1.5 2V9l2 2v2h-7.4l-.6 9-1-.3.6-8.7H8V11l2-2V6L9 4V2zm2.5 8.5h1V6h-1v4.5z\"/>` +
                `</svg>` +
            `</button>`
            : "";
        if (!q || q.regularMarketPrice == null) {
            return `<div class=\"watchlist-row${isPinned ? " pinned" : ""}\">` +
                `<div class=\"watchlist-symbol\">${pinBtn}<span>${sym}</span></div>` +
                '<div class=\"watchlist-price\">--</div>' +
                '<div class=\"watchlist-change\">--</div>' +
                '<div class=\"watchlist-pct\">--</div>' +
            '</div>';
        }
        const price = Number(q.regularMarketPrice);
        const change = Number(q.regularMarketChange || 0);
        const pct = Number(q.regularMarketChangePercent || 0);
        const changeClass = change > 0 ? "up" : (change < 0 ? "down" : "");
        const changeStr = (change >= 0 ? "+" : "") + change.toFixed(2);
        const pctStr = (pct >= 0 ? "+" : "") + pct.toFixed(2) + "%";
        return `<div class=\"watchlist-row ${changeClass}${isPinned ? " pinned" : ""}\">` +
            `<div class=\"watchlist-symbol\">${pinBtn}<span>${sym}</span></div>` +
            `<div class=\"watchlist-price\">${price.toFixed(2)}</div>` +
            `<div class=\"watchlist-change ${changeClass}\">${changeStr}</div>` +
            `<div class=\"watchlist-pct\">${pctStr}</div>` +
        '</div>';
    }).join("");
    listEl.innerHTML = rows;
}

/* NEWS CONTROLS */
function initNewsControls() {
    const voiceBtn = document.getElementById("news-voice-btn");
    const dateInput = document.getElementById("news-date");
    const econDateInput = document.getElementById("econ-date");
    const impCheckboxes = Array.from(document.querySelectorAll(".ff-imp"));
    const countryCbs = Array.from(document.querySelectorAll(".ff-country"));

    initDateSelects();
    if (dateInput) {
        dateInput.addEventListener("change", () => {
            localStorage.setItem("news-date", dateInput.value || "");
            seenNewsIds.clear();
            refreshYahoo();
        });
    }
    if (econDateInput) {
        econDateInput.addEventListener("change", () => {
            seenFFIds.clear();
            refreshEcon();
        });
    }

    const savedCountries = localStorage.getItem("ff-countries");
    if (savedCountries) {
        const set = new Set(savedCountries.split(","));
        countryCbs.forEach(cb => { cb.checked = set.has(cb.value); });
    }
    countryCbs.forEach(cb => {
        cb.addEventListener("change", () => {
            seenFFIds.clear();
            refreshEcon();
        });
    });

    const savedImp = localStorage.getItem("ff-imp");
    if (savedImp) {
        const parts = savedImp.split(",").map(s => s.trim().toLowerCase());
        impCheckboxes.forEach(cb => { cb.checked = parts.includes(cb.value.toLowerCase()); });
    }
    impCheckboxes.forEach(cb => {
        cb.addEventListener("change", () => {
            seenFFIds.clear();
            refreshEcon();
        });
    });

    const savedVoice = localStorage.getItem("news-voice");
    if (savedVoice === "0") {
        newsSpeechOn = false;
        if (voiceBtn) {
            voiceBtn.classList.add("off");
            voiceBtn.innerText = "News TTS: OFF";
        }
    }

    const savedNewsMs = parseInt(localStorage.getItem("news-refresh-ms") || "0",10) || 0;
    const savedEconMs = parseInt(localStorage.getItem("econ-refresh-ms") || "0",10) || 0;

    setNewsAutoRefresh(savedNewsMs);
    setEconAutoRefresh(savedEconMs);

    const newsSel = document.getElementById("news-refresh-select");
    if (newsSel && !newsSel.dataset.bound) {
        newsSel.dataset.bound = "1";
        newsSel.value = String(newsRefreshMs);
        newsSel.addEventListener("change", () => {
            const ms = parseInt(newsSel.value,10) || 0;
            setNewsAutoRefresh(ms);
        });
    }

    const econSel = document.getElementById("econ-refresh-select");
    if (econSel && !econSel.dataset.bound) {
        econSel.dataset.bound = "1";
        econSel.value = String(econRefreshMs);
        econSel.addEventListener("change", () => {
            const ms = parseInt(econSel.value,10) || 0;
            setEconAutoRefresh(ms);
        });
    }

    refreshEcon();
}

function togNewsVoice() {
    newsSpeechOn = !newsSpeechOn;
    const btn = document.getElementById("news-voice-btn");
    if (btn) {
        if (newsSpeechOn) {
            btn.classList.remove("off");
            btn.innerText = "News TTS: ON";
        } else {
            btn.classList.add("off");
            btn.innerText = "News TTS: OFF";
        }
    }
    localStorage.setItem("news-voice", newsSpeechOn ? "1" : "0");
}

function initDateSelects() {
    const newsSelect = document.getElementById("news-date");
    const econSelect = document.getElementById("econ-date");
    const baseStr = getTodayNY ? getTodayNY() : new Date().toISOString().slice(0, 10);
    const baseDate = new Date(baseStr + "T00:00:00");

    populateDateSelect(newsSelect, baseDate, true, "news-date");
    populateDateSelect(econSelect, baseDate, false, "econ-date");
}

function populateDateSelect(selectEl, baseDate, includeLatest, storageKey) {
    if (!selectEl || !baseDate || Number.isNaN(baseDate.getTime())) return;
    const saved = localStorage.getItem(storageKey) || "";
    const options = [];

    if (includeLatest) {
        options.push({ value: "", label: "Latest" });
    }

    for (let i = 0; i < 14; i += 1) {
        const d = new Date(baseDate);
        d.setDate(baseDate.getDate() - i);
        const value = formatDateValue(d);
        let label = value;
        if (i === 0) label = "Today";
        else if (i === 1) label = "Yesterday";
        else label = d.toLocaleDateString("en-US", { month: "short", day: "2-digit" });
        options.push({ value, label });
    }

    selectEl.innerHTML = options
        .map(opt => `<option value="${opt.value}">${opt.label}</option>`)
        .join("");

    if (saved && options.some(opt => opt.value === saved)) {
        selectEl.value = saved;
    } else if (!includeLatest) {
        selectEl.value = formatDateValue(baseDate);
    } else {
        selectEl.value = "";
    }
}

function formatDateValue(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
}

function initNewsFilters() {
    const impCbs = Array.from(document.querySelectorAll(".news-imp"));
    const saved = localStorage.getItem("news-imp") || "high,medium,low";
    const set = new Set(saved.split(",").map(s => s.trim()).filter(Boolean));
    newsImpactFilters = {
        high: set.has("high"),
        medium: set.has("medium"),
        low: set.has("low")
    };
    impCbs.forEach(cb => { cb.checked = set.has(cb.value); });

    impCbs.forEach(cb => {
        cb.addEventListener("change", () => {
            newsImpactFilters[cb.value] = cb.checked;
            const keys = Object.keys(newsImpactFilters).filter(k => newsImpactFilters[k]);
            localStorage.setItem("news-imp", keys.join(","));
            refreshYahoo();
        });
    });
}
function initAnalysisToggle() {
    analysisEnabled = localStorage.getItem("analysis-enabled") === "1";
    updateAnalysisToggle();
    bindNewsAnalysisClicks();
}
function toggleAnalysis() {
    analysisEnabled = !analysisEnabled;
    localStorage.setItem("analysis-enabled", analysisEnabled ? "1" : "0");
    updateAnalysisToggle();
    refreshNews();
}
function updateAnalysisToggle() {
    const btn = document.getElementById("analysis-toggle");
    if (btn) btn.textContent = "AI ANALYSIS: " + (analysisEnabled ? "ON" : "OFF");
    const listEl = document.getElementById("news-list");
    if (listEl) listEl.classList.toggle("analysis-off", !analysisEnabled);
}
function bindNewsAnalysisClicks() {
    const listEl = document.getElementById("news-list");
    if (!listEl || listEl.dataset.analysisBound) return;
    listEl.dataset.analysisBound = "1";
    listEl.addEventListener("click", (e) => {
        const btn = e.target.closest(".news-anl-btn");
        if (!btn) return;
        const row = btn.closest(".news-item");
        if (!row) return;
        const guid = btn.dataset.guid || "";
        const title = decodeURIComponent(btn.dataset.title || "");
        const impact = btn.dataset.impact || "low";
        const next = row.nextElementSibling;
        if (next && next.classList.contains("analysis-row") && next.dataset.guid === guid) {
            next.remove();
            return;
        }
        if (next && next.classList.contains("analysis-row")) next.remove();
        row.insertAdjacentHTML("afterend", buildAnalysisRowHtml(title, impact, guid));
    });
}
function buildAnalysisRowHtml(title, impact, guid) {
    const analysis = analyzeHeadline(title, impact);
    return (
        '<div class="analysis-row" data-guid="' + guid + '">' +
            '<div class="analysis-grid">' +
                '<div class="analysis-label">Headline Impact</div>' +
                '<div class="analysis-line"><span class="analysis-chip ' + analysis.impactClass + '">' + analysis.impactLabel + '</span></div>' +
                '<div class="analysis-label">Market Context</div>' +
                '<div class="analysis-line">' + analysis.context + '</div>' +
                '<div class="analysis-label">Quick Summary</div>' +
                '<div class="analysis-line">' + analysis.summary + '</div>' +
                '<div class="analysis-label">Potential Effects</div>' +
                '<div class="analysis-line">' + analysis.effects + '</div>' +
                '<div class="analysis-label">Confidence</div>' +
                '<div class="analysis-line"><span class="analysis-chip ' + analysis.confidenceClass + '">' + analysis.confidence + '</span></div>' +
                '<div class="analysis-label">Refine</div>' +
                '<div class="analysis-controls">' +
                    '<select class="analysis-refine">' +
                        '<option>Macro Only</option>' +
                        '<option>Equity Impact Only</option>' +
                        '<option>Volatility Relevance</option>' +
                    '</select>' +
                '</div>' +
            '</div>' +
        '</div>'
    );
}
function analyzeHeadline(title, impact) {
    const t = String(title || "").toLowerCase();
    const has = (arr) => arr.some(k => t.includes(k));

    const risk = has(["selloff","plunge","miss","cuts","downgrade","lawsuit","probe","war","conflict","inflation","rate hike","hawkish","recession","slump"])
        ? "Risk-Off"
        : has(["rally","beat","upgrade","record","surge","optimism","stimulus","dovish","rate cut","bullish"])
            ? "Risk-On"
            : "Neutral";

    const asset =
        has(["yield","treasury","bond","rates","fed"]) ? "Rates" :
        has(["fx","currency","dollar","euro","yen","yuan"]) ? "FX" :
        has(["oil","crude","wti","gas","gold","copper","commod"]) ? "Commodities" :
        "Equity";

    const theme =
        has(["cpi","ppi","inflation","gdp","jobs","payroll","pmi","retail","ism","macro"]) ? "Macro" :
        has(["earnings","eps","revenue","guidance"]) ? "Earnings" :
        has(["war","sanction","conflict","ceasefire"]) ? "Geopolitical" :
        "Macro";

    const context = risk + " \u2022 " + asset + " \u2022 " + theme;

    const summary = title.length > 140 ? title.slice(0, 137) + "..." : title;

    const vol =
        impact === "high" ? "Volatility \u2191" :
        impact === "medium" ? "Volatility \u2192" :
        "Volatility \u2193";

    const sector =
        has(["bank","financial"]) ? "Financials" :
        has(["semiconductor","chip","ai","software","cloud","tech"]) ? "Technology" :
        has(["oil","gas","energy"]) ? "Energy" :
        has(["retail","consumer"]) ? "Consumer" :
        "Broad";

    const effects = vol + " \u2022 Index Bias: SPX/NDX/RTY mixed \u2022 Sector: " + sector;

    const confidence =
        impact === "high" ? "High" :
        impact === "medium" ? "Medium" : "Low";

    return {
        impactLabel: impact.toUpperCase(),
        impactClass: impact,
        context,
        summary,
        effects,
        confidence,
        confidenceClass: confidence.toLowerCase()
    };
}
function initEconHotControls() {
    const hotCbs = Array.from(document.querySelectorAll(".ff-hot-min"));
    const beepCb = document.getElementById("ff-hot-beep");
    const saved = localStorage.getItem("ff-hot-levels") || "15,10,5";
    const set = new Set(saved.split(",").map(s => s.trim()).filter(Boolean));
    hotCbs.forEach(cb => { cb.checked = set.has(cb.value); });
    econHotLevels = hotCbs.filter(cb => cb.checked).map(cb => parseInt(cb.value, 10));

    const savedBeep = localStorage.getItem("ff-hot-beep");
    econHotBeep = savedBeep !== "0";
    if (beepCb) beepCb.checked = econHotBeep;

    hotCbs.forEach(cb => {
        cb.addEventListener("change", () => {
            econHotLevels = hotCbs.filter(x => x.checked).map(x => parseInt(x.value, 10));
            localStorage.setItem("ff-hot-levels", econHotLevels.join(","));
            refreshEcon();
        });
    });
    if (beepCb) {
        beepCb.addEventListener("change", () => {
            econHotBeep = beepCb.checked;
            localStorage.setItem("ff-hot-beep", econHotBeep ? "1" : "0");
        });
    }
}

/* INDEX QUOTES */
function initIndex() {
    fetchIndexQuotes();
    indexTimer = setInterval(fetchIndexQuotes, 60000);
}
function fetchIndexQuotes() {
    const url = YF_FEED_BASE + encodeURIComponent(INDEX_YAHOO_URL);
    fetch(url)
        .then(r => r.text())
        .then(txt => {
            let data = null;
            try {
                data = JSON.parse(txt);
            } catch (e) {
                console.warn("Index parse error:", e);
            }
            if (!data || !data.quoteResponse || !Array.isArray(data.quoteResponse.result)) {
                return;
            }
            const bySymbol = {};
            data.quoteResponse.result.forEach(q => { bySymbol[q.symbol] = q; });
            renderIndexQuote("SPY", "idx-spy", bySymbol["SPY"]);
            renderIndexQuote("QQQ", "idx-qqq", bySymbol["QQQ"]);
            renderIndexQuote("VIX", "idx-vix", bySymbol["^VIX"]);
        })
        .catch(err => {
            console.warn("Index fetch error:", err);
        });
}

function renderIndexQuote(symbol, elId, q) {
    const el = document.getElementById(elId);
    if (!el) return;
    el.classList.remove("up","down");
    if (!q || q.regularMarketPrice == null) {
        el.textContent = symbol + " --";
        return;
    }
    const price = Number(q.regularMarketPrice);
    const chgPct = Number(q.regularMarketChangePercent || 0);
    const pctStr = (chgPct >= 0 ? "+" : "") + chgPct.toFixed(2) + "%";
    el.textContent = `${symbol} ${price.toFixed(2)} (${pctStr})`;
    if (chgPct > 0.05) el.classList.add("up");
    else if (chgPct < -0.05) el.classList.add("down");
}

/* NOTES */
function initNotes() {
    const ta = document.getElementById("notes-area");
    const meta = document.getElementById("notes-meta");
    if (!ta) return;
    ta.value = localStorage.getItem("scratch-notes") || "";
    if (meta) meta.innerText = "Saved locally  " + (ta.value.length || 0) + " chars";
    ta.addEventListener("input", () => {
        localStorage.setItem("scratch-notes", ta.value);
        if (meta) meta.innerText = "Saved locally  " + (ta.value.length || 0) + " chars";
    });
}

/* STATUS BAR */
function updateStatusBar() {
    const mEl = document.getElementById("status-market");
    const nEl = document.getElementById("status-news");
    const eEl = document.getElementById("status-econ");
    const aEl = document.getElementById("status-alert");
    if (mEl) mEl.innerText = "STATUS: " + statusMarket;
    if (nEl) nEl.innerText = "News: " + statusNews;
    if (eEl) eEl.innerText = "Econ: " + statusEcon;
    if (aEl) aEl.innerText = "Alert: " + statusAlert;
}

/* GLOBAL LOGGING */
window.addEventListener("error", (e) => {
    console.warn("Global JS error:", e.message);
});
window.addEventListener("unhandledrejection", (e) => {
    console.warn("Unhandled promise rejection:", e.reason);
});

/* KEYBOARD SHORTCUTS */
document.addEventListener("keydown", (e) => {
    const tag = (e.target && e.target.tagName) ? e.target.tagName.toUpperCase() : "";
    if (tag === "INPUT" || tag === "TEXTAREA") return;
    if (e.key === "s" || e.key === "S") {
        togSnd();
    } else if (e.key === "n" || e.key === "N") {
        refreshNews();
    } else if (e.key === "e" || e.key === "E") {
        refreshEcon();
    } else if (e.key === "a" || e.key === "A") {
        togAlarm10();
    }
});

/* START */
init();
</script>
</body>
</html>




